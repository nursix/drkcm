/*
 2018-2023 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery UI datepicker
 requires moment.js
 requires fullCalendar
 requires qTip2
*/
(function(h,r){function t(){this.items={};this.slices=[]}var u=0;t.prototype.store=function(a,b,c){let g={};c.forEach(function(d){this.items[d.id]=g[d.id]=d},this);c=this.slices;a=[moment(a),moment(b),g];c.push(a);c.sort(function(d,e){return d[0].isBefore(e[0])?-1:e[0].isBefore(d[0])?1:d[1].isBefore(e[1])?-1:e[1].isBefore(d[1])?1:0});if(1<c.length){let d=[];a=c.reduce(function(e,f){return e[1].isBefore(f[0])||e[0].isAfter(f[1])?(d.push(e),f):[moment.min(e[0],f[0]),moment.max(e[1],f[1]),h.extend({},
e[2],f[2])]});d.push(a);this.slices=d}};t.prototype.retrieve=function(a,b){a=moment(a);b=moment(b);var c=this.slices,g=c.length;let d,e=[];for(let l=0;l<g;l++){var f=c[l];if(f[0].isSameOrBefore(a)&&f[1].isSameOrAfter(b)){c=f[2];for(d in c)if(g=c[d],f=moment(g.start),!f.isAfter(b)){if(g.end){if(moment(g.end).isBefore(a))continue}else if(f.isSameOrBefore(moment(a).subtract(1,"days")))continue;e.push(g)}return e}}return null};t.prototype.updateItem=function(a,b){(a=this.items[a])&&b&&h.extend(a,b)};
t.prototype.deleteItem=function(a){this.slices.forEach(function(b){delete b[2][a]});delete this.items[a]};t.prototype.clear=function(){this.slices=[];this.items={}};h.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null,aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",defaultTimedEventDuration:"00:30:00",businessHours:!1,weekNumbers:!0,timeFormat:{hour:"2-digit",minute:"2-digit"},firstDay:1,useTime:!1,yearView:!0,labelEdit:"Edit",labelDelete:"Delete",
labelReload:"Reload",labelGoto:"Go to Date",deleteConfirmation:"Do you want to delete this entry?",refreshIconClass:"fa fa-refresh",calendarIconClass:"fa fa-calendar"},_create:function(){this.id=u;u+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=this.calendar=null;this.loadCount=-1;this.refresh()},_destroy:function(){null!==this.calendar&&(this.calendar.destroy(),this.calendar=null);h.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();null!==this.calendar&&
(this.calendar.destroy(),this.calendar=null);var a=this.options;let b=a.resources,c=!1,g=!1;b.forEach(function(k){k.insertable&&(c=!0);k.useTime||(g=!0)});if(a.useTime){var d="dayGridMonth,timeGridWeek,timeGridDay reload";var e="timeGridWeek"}else d=a.yearView?"multiMonthYear,dayGridMonth,dayGridWeek reload":"dayGridMonth,dayGridWeek reload",e="dayGridMonth";let f=h("#"+h(this.element).attr("id")+"-date-picker"),l=this,m=new FullCalendar.Calendar(this.element[0],{aspectRatio:a.aspectRatio,nowIndicator:a.nowIndicator,
slotDuration:a.slotDuration,snapDuration:a.snapDuration,displayEventEnd:!1,defaultTimedEventDuration:a.defaultTimedEventDuration,allDaySlot:g,firstDay:a.firstDay,eventTimeFormat:a.timeFormat,slotLabelFormat:a.timeFormat,businessHours:a.businessHours,weekNumbers:a.weekNumbers,selectable:c,editable:!0,customButtons:{reload:{text:"",hint:a.labelReload,click:function(){l.reload()}},calendar:{text:"",hint:a.labelGoto,click:function(){f.datepicker("show")}}},headerToolbar:{start:d,center:"title",end:"calendar today prev,next"},
initialView:e,multiMonthMaxColumns:2,views:{dayGridWeek:{selectable:!a.useTime,aspectRatio:3*a.aspectRatio/2},dayGridMonth:{selectable:!a.useTime},multiMonthYear:{selectable:!a.useTime,aspectRatio:2*a.aspectRatio/3}},eventDidMount:function(k){l._eventRender(k)},eventWillUnmount:function(k){l._eventDestroy(k)},eventDrop:function(k){l._updateItem(k)},eventResize:function(k){l._updateItem(k)},select:function(k){l._selectDate(k)},unselect:function(){h(l.element).qtip("destroy",!0)},unselectCancel:".s3-organizer-create",
locale:a.locale,timezone:"local"});this.calendar=m;m.render();d=h("<i>").addClass(a.refreshIconClass);e=h("<i>").addClass(a.calendarIconClass);this.reloadButton=h(".fc-reload-button").empty().append(d);d=h(".fc-calendar-button").empty().append(e);f.datepicker("option",{showOn:"focus",showButtonPanel:!0,firstDay:a.firstDay}).insertBefore(d).on("change",function(){let k=f.datepicker("getDate");k&&m.gotoDate(k)});f.datepicker("widget").hide();a=h('<div class="inline-throbber">').css({visibility:"hidden"});
h(".fc-reload-button",this.element).after(a);this.throbber=a;this.resources=[];b&&b.forEach(function(k,n){this._addResource(k,n)},this);this._bindEvents()},_addResource:function(a,b){let c=h.extend({},a,{_cache:new t});this.resources.push(c);a=c.timeout;a===r&&(a=this.options.timeout);let g=this;this.calendar.addEventSource({id:""+b,allDayDefault:!c.useTime,editable:!!c.editable,startEditable:!!c.startEditable,durationEditable:!!c.end&&!!c.durationEditable,events:function(d,e){g._fetchItems(c,d,e)}})},
_eventRender:function(a){let b=a.el;if(b!==r){var c=this;h(b).qtip({content:{title:function(g,d){return c._itemTitle(a,d)},text:function(g,d){return c._itemDisplay(a,d)},button:!0},position:{at:"center right",my:"left center",effect:!1,viewport:h(window),adjust:{method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}})}},_eventDestroy:function(a){(a=a.el)&&h(a).qtip("destroy",!0)},_itemTitle:function(a,b){b=
this.options.locale||"en";a=a.event;var c=a.allDay?"L":"L LT";c=[moment(a.start).locale(b).format(c)];a.end&&(b=moment(a.end).locale(b).endOf("minute"),c.push(b.format("LT")));return c.join(" - ")},_itemDisplay:function(a,b){let c=a.event,g=h('<div class="s3-organizer-popup">'),d=this.options,e=d.resources[c.source.id];h("<h6>").html(c.popupTitle).appendTo(g);var f=e.columns;let l=c.extendedProps.description;f&&l&&f.forEach(function(p){let v=p[0];p=p[1];l[v]!==r&&(p&&h("<label>").text(p).appendTo(g),
h("<p>").html(l[v]).appendTo(g))});var m=h(this.element).attr("id");f=this.eventNamespace;let k=this,n=[],q=e.baseURL;if(q){if(e.editable&&!1!==c.editable){let p=document.createElement("a");p.href=q;p.pathname+="/"+c.id+"/update.popup";p.search=p.search?p.search+("&refresh="+m):"?refresh="+m;m=h('<a class="action-btn s3_modal">').text(d.labelEdit).attr("href",p.href);m.on("click"+f,function(){b.hide()});n.push(m)}e.deletable&&!1!==c.extendedProps.deletable&&(m=h('<a class="action-btn delete-btn-ajax">').text(d.labelDelete),
m.on("click"+f,function(){confirm(d.deleteConfirmation)&&(b.hide(),k._deleteItem(a,function(){b.destroy()}));return!1}),n.push(m))}n.length&&h("<div>").append(n).appendTo(g);return g},_selectDate:function(a){let b=this;h(this.element).qtip({content:{text:function(c,g){let d=moment(a.start),e=moment(a.end);return b._selectResource(d,e,c,g)}},position:{target:"mouse",at:"center right",my:"left center",effect:!1,viewport:h(window),adjust:{mouse:!1,method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"mouseleave",
delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}});h(this.element).qtip("show",a.jsEvent)},_selectResource:function(a,b,c,g){g.set("style.classes","s3-organizer-create");c=this.options.resources;let d=this.eventNamespace,e=h(this.element).attr("id"),f=h("<div>");c.forEach(function(l){if(l.insertable){var m=h('<a class="action-btn s3_modal">'),k=l.labelCreate,n=l.baseURL;if(n&&k){l=m.get(0);let q=[];l.href=n;l.pathname+="/create.popup";e&&q.push("refresh="+encodeURIComponent(e));n=a.toISOString()+
"--"+moment(b).subtract(1,"seconds").toISOString();q.push("organizer="+encodeURIComponent(n));l.search=l.search?l.search+("&"+q.join("&")):"?"+q.join("&");m.text(k).appendTo(f).on("click"+d,function(){g.hide()})}}});return f},_fetchItems:function(a,b,c){let g=b.start,d=b.end;if(b=a._cache.retrieve(g,d))c(b);else{b=this.options;this._showThrobber();var e;a.filterForm?e=h("#"+a.filterForm):b.filterForm&&(e=h("#"+b.filterForm));var f=S3.search.getCurrentFilters(e).filter(function(k){k=k[0].split("__")[0];
return k!==a.start&&k!==a.end});if(e=a.ajaxURL){e=S3.search.filterURL(e,f);f=encodeURIComponent(g.toISOString()+"--"+d.toISOString());e=-1!=e.indexOf("?")?e+("&$interval="+f):e+("?$interval="+f);f=a.timeout;var l=h.ajaxS3;f===r&&(f=b.timeout);h.searchS3!==r&&(l=h.searchS3);if(b=a.openRequest)b.onreadystatechange=null,b.abort();var m=this;a.openRequest=l({timeout:f,url:e,dataType:"json",type:"GET",success:function(k){k=m._decodeServerData(a,k);m._hideThrobber();a._cache.store(g,d,k);c(k)},error:function(k,
n,q){m._hideThrobber();console.log("UNAUTHORIZED"==q?i18n.gis_requires_login:k.responseText)}})}}},_decodeServerData:function(a,b){let c=b.c;b=b.r;let g=[],d=0,e=a.colors;c&&c.constructor===Array&&(d=c.length);b.forEach(function(f){var l={},m=f.d;if(d&&m&&m.constructor===Array){var k=m.length;if(k<=d)for(let n=0;n<k;n++)l[c[n]]=m[n]}(m=f.e)&&(m=a.useTime?moment(m).add(1,"seconds").toISOString():moment(m).add(1,"days").startOf("day").toISOString());k=f.t;l={id:f.id,title:h("<div>").html(k).text(),
start:f.s,end:m,extendedProps:{popupTitle:k,description:l}};f.pe||(l.editable=!1);f.pd||(l.extendedProps.deletable=!1);e&&f.c&&(f=e[f.c],f!==r&&(l.color=f));g.push(l)});return g},_updateItem:function(a){let b=a.event;a=a.revert;let c=this.resources[b.source.id],g={id:b.id,s:b.start.toISOString()};c.end&&(g.e=c.useTime?moment(b.end).subtract(1,"seconds").toISOString():moment(b.end).subtract(1,"days").endOf("day").toISOString());let d=this;this._sendItems(c,{u:[g]},function(){c.reloadOnUpdate?d.reload():
c._cache.updateItem(b.id,{start:b.start,end:b.end})},a)},_deleteItem:function(a,b){let c=a.event,g=this.resources[c.source.id];this._sendItems(g,{d:[{id:c.id}]},function(){c.remove();g._cache.deleteItem(c.id);"function"===typeof b&&b()})},_sendItems:function(a,b,c,g){let d=h('input[name="_formkey"]',this.element).val();b=JSON.stringify(h.extend({k:d},b));let e=this;this._showThrobber();h.ajaxS3({type:"POST",url:a.ajaxURL,data:b,dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",
success:function(){"function"===typeof c&&c();e._hideThrobber()},error:function(){"function"===typeof g&&g();e._hideThrobber()}})},reload:function(){this.resources.forEach(function(a){a._cache.clear()});this.calendar.refetchEvents()},_showThrobber:function(){this.throbber.css({visibility:"visible"});this.reloadButton.prop("disabled",!0)},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
