/*
 2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery UI MultiSelect Widget 1.14 by Eric Hynds
*/
(function(k,l){var n=0;k.widget("s3.cascadeSelect",{options:{multiple:!0,leafonly:!0,cascade:!0},_create:function(){this.id=n;n+=1;this.eventNamespace=".cascadeSelect"},_init:function(){var a=k(this.element);this.hiddenInput=k(".s3-cascade-input",a).first();this.refresh()},_destroy:function(){k.Widget.prototype.destroy.call(this)},refresh:function(){var a=k(this.element);this._unbindEvents();var b=[];k("select.s3-cascade-select",a).each(function(){b.push(k(this).empty().data("available",{}))});b.sort(function(d,
g){return d.data("level")-g.data("level")});this.selectors=b;a=this._getHierarchy();for(var c in a)this._addAvailableOption(null,0,c,a[c]);this._renderOptions(b[0],Object.keys(a),[]);c=this._deserialize();this._updateOptions(b[b.length-1],c);this._multiSelectInit();this._bindEvents()},get:function(){return this._deserialize()},set:function(a){this.reset();if(a){a.constructor!==Array&&(a=[a]);a=a.map(function(c){return""+c});var b=this.selectors;this._updateOptions(b[b.length-1],a);this._serialize();
return this}},reset:function(){this.selectors.forEach(function(a,b){a.val("");0<b&&k("option",a).remove();(a=a.multiselect("instance"))&&a.refresh()});this._serialize();this._toggleSelectors();return this},_deserialize:function(){var a=JSON.parse(this.hiddenInput.val());return a?a.map(function(b){return""+b}):[]},_serialize:function(){for(var a=this.options,b=[],c=this.selectors,d=c.length;d--;){var g=c[d],f=g.prop("multiple"),e=g.data("available");g=this._getSelected(g);for(var h=0,q=g.length;h<
q;h++){var m=g[h],p=e[m];if(!(!p||a.leafonly&&p[3])&&(-1==b.indexOf(m)&&b.push(m),b.length&&!f))break}if(b.length&&!f)break}this.hiddenInput.val(JSON.stringify(b)).trigger("select.s3hierarchy")},_multiSelectInit:function(){this.selectors.forEach(function(a){a.multiselect("instance")?a.multiselect("refresh"):a.prop("multiple")&&a.multiselect({})})},_getHierarchy:function(){var a=k(this).element,b=this.hierarchy;b===l&&(a=k(".s3-cascade",a),this.hierarchy=b=JSON.parse(a.val()));return b},_updateOptions:function(a,
b,c){var d=a.data("level"),g=a.data("available"),f=[];b=b.slice(0);this._getSelected(a).forEach(function(h){-1!=b.indexOf(h)||c&&-1==c.indexOf(h)||b.push(h)});if(0===d)this._setSelected(a,b);else if(c)this._renderOptions(a,c,b);else{var e=b.slice(0);b.forEach(function(h){h=g[h];h!==l&&-1==e.indexOf(h[0])&&e.push(h[0])});this._updateOptions(this.selectors[d-1],e)}if(0===d||c)a=this.selectors[d+1],a!==l?(b.forEach(function(h){h=g[h];h!==l&&(f=f.concat(Object.keys(h[3])))}),this._updateOptions(a,b,f)):
this._toggleSelectors()},_renderOptions:function(a,b,c){var d=this.options;!d.multiple&&d.cascade&&1==b.length&&(d=b[0],-1==c.indexOf(d)&&c.push(d));var g=a.data("available");a.empty();var f=[];b.forEach(function(e){var h=g[e];h&&f.push([e,h[1]])});f.sort(function(e,h){return e[1].localeCompare(h[1])});f.forEach(function(e){k("<option>").val(e[0]).text(e[1]).appendTo(a)});this._setSelected(a,c)},_getSelected:function(a){return(a=k(a).val())?a.constructor===Array?a.map(function(b){return""+b}):[""+
a]:[]},_setSelected:function(a,b){var c=a.data("available"),d=a.multiselect("instance");b=b.filter(function(g){return c[""+g]!==l});a.prop("multiple")?a.val(b):a.val(b[0]);d&&d.refresh()},_addAvailableOption:function(a,b,c,d){var g=this.selectors[b];if(g){var f=g.data("available");if(f===l||null===f)f={};f[""+c]=[""+a].concat(d);g.data("available",f);if((a=d[2])&&!0!==a)for(var e in a)this._addAvailableOption(c,b+1,e,a[e])}},_toggleSelectors:function(){this.selectors.forEach(function(a){var b=a.multiselect("instance");
k("option",a).length?(a.prop("disabled",!1),b&&b.enable()):(a.prop("disabled",!0),b&&b.disable())})},_hiddenBranches:function(a,b){var c=[],d=a.data("level");if(d=this.selectors[d+1]){var g=a.data("available"),f={};b.forEach(function(e){if((e=g[e])&&(e=e[3])&&!0!==e)for(var h in e)f[""+h]=!0});k("option",d).each(function(){f[k(this).val()]=!1});c=Object.keys(f).filter(function(e){return f[e]});c=c.concat(this._hiddenBranches(d,c))}return c},_bindEvents:function(){var a=k(this.element),b=this.eventNamespace,
c=this.options,d=this;k("select.s3-cascade-select",a).on("change"+b,function(){var g=k(this),f=d._getSelected(g);c.multiple&&c.cascade&&d._hiddenBranches(g,f).forEach(function(e){-1==f.indexOf(e)&&f.push(e)});d._updateOptions(g,f);d._serialize()});return!0},_unbindEvents:function(){var a=k(this.element),b=this.eventNamespace;k("select.s3-cascade-select",a).off(b);return!0}})})(jQuery);
