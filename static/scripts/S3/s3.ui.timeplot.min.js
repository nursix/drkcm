/*
 2013-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js

*/
(function(f,z){var v=function(a,b){var d=[],e={},c=0,g=1==a.length,k;for(k=0;k<a.length;k++){var h=a[k][0];e.hasOwnProperty(h)&&(c=e[h]+1);(e[h]=c)&&(h+=" ["+(c+1)+"]");var p={key:h,label:a[k][0],area:g},n=[];for(h=0;h<b.length;h++){var q=b[h];n.push({start:(new Date(q.t[0])).getTime(),value:q.v[k]})}p.values=n;d.push(p)}return d},w=0;f.widget("s3.timeplot",{options:{ajaxURL:null,autoSubmit:1E3,burnDown:!1,emptyMessage:"No data available",thousandSeparator:" ",thousandGrouping:"3",precision:null,
defaultChartType:"barchart",defaultChartAxis:"totals",labelGrouped:"Grouped",labelStacked:"Stacked"},_create:function(){this.id=w;w+=1},_init:function(){var a=f(this.element),b=this.options;this.widget_id=a.attr("id");this.input=a.find('input[type="hidden"][name="tp-data"]').first();this.svg=this.data=null;a=a.find(".tp-chart");this.chart=a.length?a.first():null;this.currentChart={type:null,chart:null,container:null};b.numberFormatter=function(d){var e=b.precision;if(null===d||"undefined"==typeof d)return"-";
e=e||0==e?d.toFixed(e):d.toString();e=e.split(".");d=e[0];e=1<e.length?"."+e[1]:"";d=d.replace(new RegExp("\\B(?=(\\d{"+b.thousandGrouping+"})+(?!\\d))","g"),b.thousandSeparator);return d+e};this.refresh()},_destroy:function(){var a=this.element;this._unbindEvents();this.svg&&(this.svg.remove(),this.svg=null,a.find(".tp-chart").empty());this.data=null;f.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.element;this._unbindEvents();this._renderChart();this._renderChartOptions();this.options.autoSubmit?
a.find(".tp-submit").hide():a.find(".tp-submit").show();this._bindEvents();a.find(".tp-throbber").hide()},_renderChartOptions:function(){var a=f(this.element),b=a.find(".tp-chart-controls").first().empty();if(!this.data.e){var d=a.attr("id");a=f('<div class="pt-chart-opts">');var e=d+"-bchart-totals";d+="-lchart-totals";f(a).append(f('<span id="'+d+'" class="tp-chart-icon tp-lchart"></span><span class="tp-chart-label">Line Chart</span>'));f(a).append(f('<span id="'+e+'" class="tp-chart-icon tp-bchart"></span><span class="tp-chart-label">Bar Chart</span>'));
f(b).append(a)}},_renderChart:function(a){var b=this.chart;if(b){var d=this.options,e=this.currentChart,c=null,g=null;a?(c=a.type,g=a.axis):(e&&(c=e.type,g=e.axis),c&&g||(c=d.defaultChartType,g=d.defaultChartAxis));e.type==c&&e.axis==g||this._removeChart();a=this.element;d=a.find(".tp-empty");e=this.data;null===e&&(e=JSON.parse(this.input.val()));e||={e:!0};this.data=e;if(e.e)this._removeChart(),a.find(".tp-empty").show();else switch(d.hide(),b.show(),g){case "totals":switch(c){case "barchart":this._renderMultiBarChart(b,
e.f,e.p);break;default:this._renderLineChart(b,e.f,e.p)}}}},_removeChart:function(){var a=this.chart;a&&(a.empty().hide(),a=this.currentChart,a.container=null,a.chart=null,a.type=null,a.axis=null,f(window).off("resize.tp"))},_renderMultiBarChart:function(a,b,d){var e=v(b,d);d=this.currentChart;var c=this.options;if(d.chart){var g=d.container;var k=d.chart;k.showControls(1<b.length);g.datum(e).transition().duration(50).call(k)}else f(a).closest(".tp-chart-contents").show(),f(a).css({height:"360px"}),
g=d3.select(f(a).get(0)).append("svg").attr("class","nv"),k=nv.models.multiBarChart().x(function(h){return h.start}).y(function(h){return h.value}).staggerLabels(!0).showControls(1<b.length).controlLabels({grouped:c.labelGrouped,stacked:c.labelStacked}).forceY([0,1]),k.tooltip.enabled(!1),k.yAxis.tickFormat(this.options.numberFormatter),k.xAxis.tickFormat(function(h){return(new Date(h)).toLocaleDateString()}),nv.addGraph(function(){g.datum(e).transition().duration(50).call(k);f(window).off("resize.tp").on("resize.tp",
function(h){k.update(h)});return k}),d.container=g,d.chart=k,d.type="barchart",d.axis="totals"},_renderLineChart:function(a,b,d){var e=v(b,d);b=this.currentChart;if(b.chart){var c=b.container;var g=b.chart;c.datum(e).transition().duration(50).call(g)}else f(a).closest(".tp-chart-contents").show(),f(a).css({height:"360px"}),c=d3.select(f(a).get(0)).append("svg").attr("class","nv"),g=nv.models.lineChart().x(function(k){return k.start}).y(function(k){return k.value}).margin({right:50}).duration(50).showLegend(!0).useInteractiveGuideline(!0).forceY([0,
1]),g.yAxis.tickFormat(this.options.numberFormatter),g.xAxis.tickFormat(function(k){return(new Date(k)).toLocaleDateString()}),nv.addGraph(function(){c.datum(e).transition().duration(50).call(g);f(window).off("resize.tp").on("resize.tp",function(k){g.update(k)});return g}),b.container=c,b.chart=g,b.type="linechart",b.axis="totals"},reload:function(a,b,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof b&&(b=this._getFilters());var e=this,c=!1;f(this.element).find(".tp-throbber").show();if(a||b)c=
this._updateAjaxURL(a,b);c||d?(a=this.options.ajaxURL,b=f.ajaxS3,f.searchS3!==z&&(b=f.searchS3),b({url:a,type:"GET",dataType:"json",success:function(g){e.input.val(JSON.stringify(g));e.data=g;e.refresh()},error:function(g,k,h){console.log("UNAUTHORIZED"==h?i18n.gis_requires_login:g.responseText)}})):e.refresh()},_getOptions:function(){var a="#"+f(this.element).attr("id"),b=f(a+"-time").val(),d=null,e=null,c=f(a+"-slots").val();"custom"!=b&&(b=b.split("|"),3==b.length&&(d=b[0],e=b[1],c&&"auto"!=c||
(c=b[2])));return{fact:f(a+"-fact").val(),timestamp:f(a+"-timestamp").val(),start:d,end:e,slots:c}},_getFilters:function(){var a=f("#"+this.widget_id+"-filters");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(b){return null}},_updateAjaxURL:function(a,b){var d=this.options.ajaxURL;if(!d)return!1;var e=d.split("?");if(1<e.length){var c=e[1];var g=c.split("&")}else c="",g=[];var k=[];d=!1;if(a)for(var h in a)c=a[h],c=h+"="+c,d||-1!=f.inArray(c,g)||(d=!0),k.push(c);h={};var p=
{},n;if(b){var q=function(x){var t,u,y=[];["contains","anyof","belongs","eq"].forEach(function(r){t=new RegExp("__"+r+"$","g");x.match(t)?u=t:y.push(r)});u&&y.forEach(function(r){p[x.replace(u,"__"+r)]=!0})};c=0;for(n=b.length;c<n;c++){var m=b[c];var l=m[0];m=m[1];q(l);null===m?h[l]||(p[l]=!0):(p[l]&&(p[l]=!1),m=l+"="+encodeURIComponent(m),h[l]?h[l].push(m):h[l]=[m])}}c=0;for(n=g.length;c<n;c++)m=g[c].split("="),1<m.length&&(l=decodeURIComponent(m[0]),m=decodeURIComponent(m[1]),p[l]?d=!0:h[l]?d||
-1!=f.inArray(l+"="+m,h[l])||(d=!0):a&&a.hasOwnProperty(l)||k.push(g[c]));for(l in h)for(c=0,n=h[l].length;c<n;c++)d||-1!=f.inArray(h[l][c],g)||(d=!0),k.push(h[l][c]);a=k.join("&");b=e[0];a&&(b=b+"?"+a);this.options.ajaxURL=b;return d},_parseDate:function(a){return d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse(a)},_bindEvents:function(){var a=this,b="#"+this.widget_id;f(b+"-options legend").on("click",function(){f(this).siblings().toggle();f(this).children().toggle()});f(b+"-filters legend").on("click",
function(){f(this).siblings().toggle();f(this).children().toggle()});var d=["fact","timestamp","time","slots"].map(function(c){return b+"-"+c}).join(",");f(d).on("change.autosubmit",function(){f(b+"-tp-form").trigger("optionChanged")});if(this.options.autoSubmit){var e=this.options.autoSubmit;f(b+"-tp-form").on("optionChanged",function(){var c=f(this);if(!c.data("noAutoSubmit")){var g=c.data("autoSubmitTimeout");g&&clearTimeout(g);g=setTimeout(function(){var k=a._getOptions(),h=a._getFilters();a.reload(k,
h,!1)},e);c.data("autoSubmitTimeout",g)}})}else f(b+"-tp-form input.tp-submit").on("click.timeplot",function(){var c=a._getOptions(),g=a._getFilters();a.reload(c,g,!1)});f(b+"-lchart-totals").on("click",function(){a._renderChart({type:"linechart",axis:"totals"})});f(b+"-bchart-totals").on("click",function(){a._renderChart({type:"barchart",axis:"totals"})})},_unbindEvents:function(){var a="#"+this.widget_id;f(window).off("resize.timeplot");f(a+"-tp-form").off("optionChanged");f(a+"-tp-form input.tp-submit").off("click.timeplot");
f(a+"-time").off("change.autosubmit");f(a+"-options legend").off("click");f(a+"-filters legend").off("click");f(a+"-lchart-totals,"+a+"-bchart-totals").off("click")}})})(jQuery);
