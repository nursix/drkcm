/*
 2013-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,k,h){b instanceof String&&(b=String(b));for(var n=b.length,a=0;a<n;a++){var c=b[a];if(k.call(h,c,a,b))return{i:a,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,k,h){if(b==Array.prototype||b==Object.prototype)return b;b[k]=h.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var k=0;k<b.length;++k){var h=b[k];if(h&&h.Math==Math)return h}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,k){var h=$jscomp.propertyToPolyfillSymbol[k];if(null==h)return b[k];h=b[h];return void 0!==h?h:b[k]};
$jscomp.polyfill=function(b,k,h,n){k&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,k,h,n):$jscomp.polyfillUnisolated(b,k,h,n))};$jscomp.polyfillUnisolated=function(b,k,h,n){h=$jscomp.global;b=b.split(".");for(n=0;n<b.length-1;n++){var a=b[n];if(!(a in h))return;h=h[a]}b=b[b.length-1];n=h[b];k=k(n);k!=n&&null!=k&&$jscomp.defineProperty(h,b,{configurable:!0,writable:!0,value:k})};
$jscomp.polyfillIsolated=function(b,k,h,n){var a=b.split(".");b=1===a.length;n=a[0];n=!b&&n in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var c=0;c<a.length-1;c++){var e=a[c];if(!(e in n))return;n=n[e]}a=a[a.length-1];h=$jscomp.IS_SYMBOL_NATIVE&&"es6"===h?n[a]:null;k=k(h);null!=k&&(b?$jscomp.defineProperty($jscomp.polyfills,a,{configurable:!0,writable:!0,value:k}):k!==h&&(void 0===$jscomp.propertyToPolyfillSymbol[a]&&(h=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[a]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(a):$jscomp.POLYFILL_PREFIX+h+"$"+a),$jscomp.defineProperty(n,$jscomp.propertyToPolyfillSymbol[a],{configurable:!0,writable:!0,value:k})))};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(k,h){return $jscomp.findInternal(this,k,h).v}},"es6","es3");
(function(b,k){var h=function(a,c){var e=[],f={},d=0,g=1==a.length,l;for(l=0;l<a.length;l++){var m=a[l][0];f.hasOwnProperty(m)&&(d=f[m]+1);(f[m]=d)&&(m+=" ["+(d+1)+"]");var t={key:m,label:a[l][0],area:g},r=[];for(m=0;m<c.length;m++){var u=c[m];r.push({start:(new Date(u.t[0])).getTime(),value:u.v[l]})}t.values=r;e.push(t)}return e},n=0;b.widget("s3.timeplot",{options:{ajaxURL:null,autoSubmit:1E3,burnDown:!1,emptyMessage:"No data available",thousandSeparator:" ",thousandGrouping:"3",precision:null,
defaultChartType:"barchart",defaultChartAxis:"totals"},_create:function(){this.id=n;n+=1},_init:function(){var a=b(this.element),c=this.options;this.widget_id=a.attr("id");this.input=a.find('input[type="hidden"][name="tp-data"]').first();this.svg=this.data=null;a=a.find(".tp-chart");this.chart=a.length?a.first():null;this.currentChart={type:null,chart:null,container:null};c.numberFormatter=function(e){var f=c.precision;if(null===e||"undefined"==typeof e)return"-";f=f||0==f?e.toFixed(f):e.toString();
f=f.split(".");e=f[0];f=1<f.length?"."+f[1]:"";e=e.replace(new RegExp("\\B(?=(\\d{"+c.thousandGrouping+"})+(?!\\d))","g"),c.thousandSeparator);return e+f};this.refresh()},_destroy:function(){var a=this.element;this._unbindEvents();this.svg&&(this.svg.remove(),this.svg=null,a.find(".tp-chart").empty());this.data=null;b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.element;this._unbindEvents();this._renderChart();this._renderChartOptions();this.options.autoSubmit?a.find(".tp-submit").hide():
a.find(".tp-submit").show();this._bindEvents();a.find(".tp-throbber").hide()},_renderChartOptions:function(){var a=b(this.element),c=a.find(".tp-chart-controls").first().empty();if(!this.data.e){var e=a.attr("id");a=b('<div class="pt-chart-opts">');var f=e+"-bchart-totals";e+="-lchart-totals";b(a).append(b('<span id="'+e+'" class="tp-chart-icon tp-lchart"/><span class="tp-chart-label">Line Chart</span>'));b(a).append(b('<span id="'+f+'" class="tp-chart-icon tp-bchart"/><span class="tp-chart-label">Bar Chart</span>'));
b(c).append(a)}},_renderChart:function(a){var c=this.chart;if(c){var e=this.options,f=this.currentChart,d=null,g=null;a?(d=a.type,g=a.axis):(f&&(d=f.type,g=f.axis),d&&g||(d=e.defaultChartType,g=e.defaultChartAxis));f.type==d&&f.axis==g||this._removeChart();a=this.element;e=a.find(".tp-empty");f=this.data;null===f&&(f=JSON.parse(this.input.val()));f||(f={e:!0});this.data=f;if(f.e)this._removeChart(),a.find(".tp-empty").show();else switch(e.hide(),c.show(),g){case "totals":switch(d){case "barchart":this._renderMultiBarChart(c,
f.f,f.p);break;default:this._renderLineChart(c,f.f,f.p)}}}},_removeChart:function(){var a=this.chart;a&&(a.empty().hide(),a=this.currentChart,a.container=null,a.chart=null,a.type=null,a.axis=null,b(window).off("resize.tp"))},_renderMultiBarChart:function(a,c,e){var f=h(c,e);e=this.currentChart;if(e.chart){var d=e.container;var g=e.chart;d.datum(f).transition().duration(50).call(g)}else b(a).closest(".tp-chart-contents").show(),b(a).css({height:"360px"}),d=d3.select(b(a).get(0)).append("svg").attr("class",
"nv"),g=nv.models.multiBarChart().x(function(l){return l.start}).y(function(l){return l.value}).staggerLabels(!0).showControls(1<c.length).forceY([0,1]),g.tooltip.enabled(!1),g.yAxis.tickFormat(this.options.numberFormatter),g.xAxis.tickFormat(function(l){return(new Date(l)).toLocaleDateString()}),nv.addGraph(function(){d.datum(f).transition().duration(50).call(g);b(window).off("resize.tp").on("resize.tp",function(l){g.update(l)});return g}),e.container=d,e.chart=g,e.type="barchart",e.axis="totals"},
_renderLineChart:function(a,c,e){var f=h(c,e);c=this.currentChart;if(c.chart){var d=c.container;var g=c.chart;d.datum(f).transition().duration(50).call(g)}else b(a).closest(".tp-chart-contents").show(),b(a).css({height:"360px"}),d=d3.select(b(a).get(0)).append("svg").attr("class","nv"),g=nv.models.lineChart().x(function(l){return l.start}).y(function(l){return l.value}).margin({right:50}).duration(50).showLegend(!0).useInteractiveGuideline(!0).forceY([0,1]),g.yAxis.tickFormat(this.options.numberFormatter),
g.xAxis.tickFormat(function(l){return(new Date(l)).toLocaleDateString()}),nv.addGraph(function(){d.datum(f).transition().duration(50).call(g);b(window).off("resize.tp").on("resize.tp",function(l){g.update(l)});return g}),c.container=d,c.chart=g,c.type="linechart",c.axis="totals"},reload:function(a,c,e){e="undefined"!=typeof e?e:!0;"undefined"==typeof c&&(c=this._getFilters());var f=this,d=!1;b(this.element).find(".tp-throbber").show();if(a||c)d=this._updateAjaxURL(a,c);d||e?(a=this.options.ajaxURL,
c=b.ajaxS3,b.searchS3!==k&&(c=b.searchS3),c({url:a,type:"GET",dataType:"json",success:function(g){f.input.val(JSON.stringify(g));f.data=g;f.refresh()},error:function(g,l,m){console.log("UNAUTHORIZED"==m?i18n.gis_requires_login:g.responseText)}})):f.refresh()},_getOptions:function(){var a="#"+b(this.element).attr("id"),c=b(a+"-time").val(),e=null,f=null,d=b(a+"-slots").val();"custom"!=c&&(c=c.split("|"),3==c.length&&(e=c[0],f=c[1],d&&"auto"!=d||(d=c[2])));return{fact:b(a+"-fact").val(),timestamp:b(a+
"-timestamp").val(),start:e,end:f,slots:d}},_getFilters:function(){var a=b("#"+this.widget_id+"-filters");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(c){return null}},_updateAjaxURL:function(a,c){var e=this.options.ajaxURL;if(!e)return!1;var f=e.split("?");if(1<f.length){var d=f[1];var g=d.split("&")}else d="",g=[];var l=[];e=!1;if(a)for(var m in a)d=a[m],d=m+"="+d,e||-1!=b.inArray(d,g)||(e=!0),l.push(d);m={};var t={},r;if(c){var u=function(y){var w,x,z=[];["contains","anyof",
"belongs","eq"].forEach(function(v){w=new RegExp("__"+v+"$","g");y.match(w)?x=w:z.push(v)});x&&z.forEach(function(v){t[y.replace(x,"__"+v)]=!0})};d=0;for(r=c.length;d<r;d++){var q=c[d];var p=q[0];q=q[1];u(p);null===q?m[p]||(t[p]=!0):(t[p]&&(t[p]=!1),q=p+"="+encodeURIComponent(q),m[p]?m[p].push(q):m[p]=[q])}}d=0;for(r=g.length;d<r;d++)q=g[d].split("="),1<q.length&&(p=decodeURIComponent(q[0]),q=decodeURIComponent(q[1]),t[p]?e=!0:m[p]?e||-1!=b.inArray(p+"="+q,m[p])||(e=!0):a&&a.hasOwnProperty(p)||l.push(g[d]));
for(p in m)for(d=0,r=m[p].length;d<r;d++)e||-1!=b.inArray(m[p][d],g)||(e=!0),l.push(m[p][d]);a=l.join("&");c=f[0];a&&(c=c+"?"+a);this.options.ajaxURL=c;return e},_parseDate:function(a){return d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse(a)},_bindEvents:function(){var a=this,c="#"+this.widget_id;b(c+"-options legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-filters legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});var e=
["fact","timestamp","time","slots"].map(function(d){return c+"-"+d}).join(",");b(e).on("change.autosubmit",function(){b(c+"-tp-form").trigger("optionChanged")});if(this.options.autoSubmit){var f=this.options.autoSubmit;b(c+"-tp-form").on("optionChanged",function(){var d=b(this);if(!d.data("noAutoSubmit")){var g=d.data("autoSubmitTimeout");g&&clearTimeout(g);g=setTimeout(function(){var l=a._getOptions(),m=a._getFilters();a.reload(l,m,!1)},f);d.data("autoSubmitTimeout",g)}})}else b(c+"-tp-form input.tp-submit").on("click.timeplot",
function(){var d=a._getOptions(),g=a._getFilters();a.reload(d,g,!1)});b(c+"-lchart-totals").click(function(){a._renderChart({type:"linechart",axis:"totals"})});b(c+"-bchart-totals").click(function(){a._renderChart({type:"barchart",axis:"totals"})})},_unbindEvents:function(){var a="#"+this.widget_id;b(window).off("resize.timeplot");b(a+"-tp-form").off("optionChanged");b(a+"-tp-form input.tp-submit").off("click.timeplot");b(a+"-time").unbind("change.autosubmit");b(a+"-options legend").unbind("click");
b(a+"-filters legend").unbind("click");b(a+"-lchart-totals,"+a+"-bchart-totals").unbind("click")}})})(jQuery);
