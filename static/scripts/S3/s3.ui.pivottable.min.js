/*
 2013-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js 1.8.5 (patched)

*/
(function(e,K){var M=0;e.widget("s3.pivottable",{options:{showTotals:!0,ajaxURL:null,defaultChart:{type:"breakdown",axis:"rows"},renderFilter:!0,renderOptions:!0,renderChart:!0,renderTable:!0,collapseFilter:!1,collapseOptions:!0,collapseChart:!0,collapseTable:!1,exploreChart:!1,filterURL:null,filterForm:null,filterTab:null,autoSubmit:1E3,timeout:1E4,thousandSeparator:" ",thousandGrouping:"3",minTickSize:null,precision:null,textAll:"All",labelRecords:"Records"},_create:function(){this.id=M;M+=1;this.openRequest=
this.chart=this.table=null;this.eventNamespace=".pt"},_init:function(){var a=e(this.element),b=this.options;this.table=this.data=null;this.chartOptions={currentChart:null,currentDataIndex:null,currentSeriesIndex:null,currentSpectrumIndex:null};this.table_options={hidden:!1};var c=a.find(".pt-chart");this.chart=c.length?c.first():null;b.renderFilter||b.renderOptions?(c="#"+a.attr("id"),b.renderOptions?(e(c+"-options").show(),b.collapseOptions&&(e(c+"-options legend").siblings().toggle(),e(c+"-options legend").children().toggle())):
e(c+"-options").hide(),b.renderFilter?(e(c+"-filters").show(),b.collapseFilter&&(e(c+"-filters legend").siblings().toggle(),e(c+"-filters legend").children().toggle())):e(c+"-options").hide()):a.find(".pt-form-container").hide();b.collapseTable&&(this.table_options.hidden=!0,a.find(".pt-table").hide(),a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide());b.numberFormatter=function(d){var f=b.precision;if(null===d||"undefined"==typeof d)return"-";f=f||0==f?d.toFixed(f):d.toString();f=f.split(".");
d=f[0];f=1<f.length?"."+f[1]:"";d=d.replace(new RegExp("\\B(?=(\\d{"+b.thousandGrouping+"})+(?!\\d))","g"),b.thousandSeparator);return d+f};this.refresh()},_destroy:function(){this.table&&this.table.remove();this.chart&&this.chart.empty()},refresh:function(){var a=e(this.element),b=null;this._unbindEvents();var c=a.find('input[type="hidden"][name="pivotdata"]');c.length&&(b=JSON.parse(e(c).first().val()));b?"count"==b.method&&(this.options.precision=0,this.options.minTickSize=1):(b={empty:!0},a.find(".pt-hide-table").hide(),
a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide());this.data=b;this.lookups={};b.nodata?(a.find(".pt-table").first().empty().append(e('<div class="pt-no-data">'+b.nodata+"</div>")),a.find(".pt-hide-table").hide(),a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide()):(this._renderTable(),this._renderChartOptions());this._renderChart();b.empty?a.find(".pt-empty").show():a.find(".pt-empty").hide();this.options.autoSubmit?a.find(".pt-submit").hide():a.find(".pt-submit").show();
this._bindEvents();a.find(".pt-throbber").hide()},_renderTable:function(){var a=e(this.element),b=a.find(".pt-table").first().empty();this.table=null;var c=this.data;if(!c.empty)if(this.options.renderTable){var d=c.cells.slice(0),f=c.cols,g=c.rows,l=c.total,h=c.labels,k=!1,m=!1;c=c.facts;1==c.length&&"list"!=c[0][1]&&(1==g.length&&null===g[0][4]&&(k=!0),1==f.length&&null===f[0][4]&&(m=!0));c=this.options;var q=c.showTotals,r;if(m&&q)for(f=[],r=0;r<g.length;r++)d[r]=[];else{var x=function(p,z){return"__other__"!=
f[z][0]};for(r=0;r<g.length;r++)d[r]=d[r].filter(x);f=f.filter(function(p){return"__other__"!=p[0]})}k&&q?(g=[],d=[]):(d=d.filter(function(p,z){return"__other__"!=g[z][0]}),g=g.filter(function(p){return"__other__"!=p[0]}));b=d3.select(b.get(0)).append("table").attr("class","dataTable display report");b.append("thead").call(this._renderHeader,f,h,c).call(this._renderColumns,f,h,m);k&&q||b.append("tbody").call(this._renderRows,this,g,f,h,d,c);q&&b.append("tfoot").call(this._renderFooter,g,f,h,l);this.table=
e(b.node());this.table_options.hidden?(a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()):(a.find(".pt-show-table").hide(),a.find(".pt-hide-table").show(),a.find(".pt-export-opt").show())}else a.find(".pt-show-table").hide(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()},_renderHeader:function(a,b,c,d){a=a.append("tr");a.append("th").attr("scope","col").text(c.layer);b.length&&a.append("th").attr({scope:"col",colspan:b.length}).text(c.cols);
d.showTotals&&a.append("th").attr({scope:"col","class":"pt-totals-header pt-row-total",rowspan:2}).text(c.total);return a},_renderColumns:function(a,b,c,d){a=a.append("tr");a.append("th").attr({scope:"col","class":"pt-rows-header"}).text(c.rows);a.selectAll("th.pt-data").data(b).enter().append("th").attr({scope:"col","class":"pt-col-label"}).text(function(f){return d?"":f[4]});return a},_renderRows:function(a,b,c,d,f,g,l){c=a.selectAll("tr.pt-row").data(c).enter().append("tr").attr("class",function(h,
k){return k%2?"odd":"even"});c.append("td").text(function(h){return h[4]});c.selectAll("td.pt-cell").data(function(h,k){return g[k]}).enter().append("td").attr("class","pt-cell").each(b._renderCell,f);l.showTotals&&c.append("td").attr("class","pt-row-total").text(function(h){return h[2][0]});return c},_renderCell:function(a,b,c){b=d3.select(this);for(var d=a.i,f,g=0,l=d.length;g<l;g++){f=d[g];var h=b.append("div").attr("class","pt-cell-value");null===f?h.text(c.none):e.isArray(f)?h.append("ul").selectAll("li").data(f).enter().append("li").html(function(k){return k}):
h.text(f);1<l-g&&h.append("span").text(" / ")}(a=a.k)&&a.length&&(e(b.node()).data("recordIDs",a),b.append("div").attr("class","pt-cell-zoom"))},_renderCellRecords:function(a,b){var c=e(".pt-cell-zoom",a).removeClass("opened");a=e(".pt-cell-records",a).remove();if(b){var d=this.lookups,f=[],g,l=[];b.forEach(function(k){if(g=d[k]){if(g.constructor===Array){k=g[1];if(-1!=l.indexOf(k))return;l.push(k);g=g[0]}g&&f.push(g)}});a=e('<div class="pt-cell-records">');var h=e("<ul>").appendTo(a);f.length?(f.sort(function(k,
m){return k.localeCompare(m)}),f.forEach(function(k){e("<li>").html(k).appendTo(h)})):e("<li>").text(b.length+" "+this.options.textRecords).appendTo(h);c.addClass("opened").after(a)}},_renderFooter:function(a,b,c,d,f){b=b.length%2?"odd":"even";a=a.append("tr").attr("class",b+" pt-totals-row");a.append("th").attr({"class":"pt-totals-header",scope:"row"}).text(d.total);a.selectAll("td.pt-col-total").data(c).enter().append("td").attr("class","pt-col-total").text(function(g){return g[2][0]});a.append("td").attr("class",
"pt-total").text(f);return a},_renderChartOptions:function(){var a=e(this.element),b=a.find(".pt-chart-controls").first().empty(),c=this.data;if(!c.empty&&this.options.renderChart){c=c.labels;var d=a.attr("id");a=c.layer;var f=c.rows,g=c.cols,l=c.per,h=e('<div class="pt-chart-opts">'),k=d+"-pchart-rows",m=d+"-vchart-rows",q=d+"-hchart-rows",r=d+"-schart-rows",x=d+"-pchart-cols",p=d+"-vchart-cols",z=d+"-hchart-cols";d+="-schart-cols";a&&e(h).append(e('<span class="pt-chart-label">'+a+": </span>"));
f&&e(h).append(e('<div id="'+k+'" class="pt-chart-icon pt-pchart"/><div id="'+m+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+l+" "+f+"</span>"));g&&e(h).append(e('<div id="'+x+'" class="pt-chart-icon pt-pchart"/><div id="'+p+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+l+" "+g+"</span>"));f&&g&&e(h).append(e('<span class="pt-chart-label">| '+c.breakdown+': </span><div id="'+r+'" class="pt-chart-icon pt-schart"/><div id="'+q+'" class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+
l+" "+f+'</span><div id="'+d+'"  class="pt-chart-icon pt-schart"/><div id="'+z+'"  class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+l+" "+g+"</span>"));e(b).append(h)}},_truncateLabel:function(a,b){return a&&a.length>b?a.substring(0,b-3).replace(/\s+$/g,"")+"...":a},_renderChart:function(a){var b=e(this.element),c=this.data;e(".pt-chart-contents",b).hide();if(b=this.chart)if(e(b).off("plothover").off("plotclick").empty(),!c.empty&&this.options.renderChart)if(!1===a)this.options.collapseChart=
!0;else{b=this.options.collapseChart;if("undefined"==typeof a||!a){if(b)return;a=this.chartOptions.currentChart}if("undefined"==typeof a||!a){if(b)return;a=this.options.defaultChart}if("undefined"!=typeof a&&a){this.options.collapseChart=!1;this.chartOptions.currentChart=a;b=a.type;a=a.axis;var d=c.labels,f=d.per,g=d.layer+" "+f+" "+d.rows;d=d.layer+" "+f+" "+d.cols;f=c.filter;var l=f[0],h=f[1];"piechart"==b?"rows"==a?this._renderPieChart(c.rows,g,l):this._renderPieChart(c.cols,d,h):"barchart"==b?
"rows"==a?this._renderBarChart(c.rows,c.facts,g,l):this._renderBarChart(c.cols,c.facts,d,h):"breakdown"==b?"rows"==a?this._renderBreakDown(c,0,g,f):this._renderBreakDown(c,1,d,f):"spectrum"==b&&this._renderSpectrum(c,a,f)}}},_renderPieChart:function(a,b,c){var d=this.chart;if(d){e(d).css({height:"360px"}).closest(".pt-chart-contents").show();b?e(d).siblings(".pt-chart-title").html("<h4>"+b+"</h4>"):e(d).siblings(".pt-chart-title").empty();var f=[],g=0;for(b=0;b<a.length;b++){var l=a[b];!l[1]&&0<=
l[2][0]&&(f.push({index:l[0],label:l[4],value:l[2][0],key:l[3]}),g+=l[2][0])}var h=this;h.chartOptions.currentDataIndex=null;var k=function(m){var q=m.index;if(h.chartOptions.currentDataIndex!=q){h._removeChartTooltip();h.chartOptions.currentDataIndex=q;m=m.data;var r=m.value,x=d3.event;h._renderChartTooltip(x.pageX,x.pageY,'<div class="pt-tooltip-label">'+m.label+'</div><div class="pt-tooltip-text">'+(r+" ("+Math.round(r/g*100)+"%)</div>"));e(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},
q)})}};nv.addGraph(function(){var m=nv.models.pieChart().x(function(q){return q.label}).y(function(q){return q.value}).labelsOutside(!1).labelType("percent").labelThreshold(.03).showLegend(!0);m.tooltip.enabled(!1);m.legend.align(!0).rightAlign(!1);m.pie.dispatch.on("elementMouseover",k).on("elementMouseout",function(){e(".pt-tooltip").remove();h.chartOptions.currentDataIndex=null;h.chartOptions.currentSeriesIndex=null});if(h.options.exploreChart&&c)m.pie.dispatch.on("elementClick",function(q){q=
q.data;h._chartExplore([["__other__"==q.index?c+"__belongs":c,q.key]])});d3.select(e(d).get(0)).append("svg").attr("class","nv").datum(f).transition().duration(1200).call(m);nv.utils.windowResize(m.update);return m})}},_renderBarChart:function(a,b,c,d){var f=this.chart;if(f){e(f).closest(".pt-chart-contents").show().css({width:"96%"});for(var g=[],l=this._truncateLabel,h,k,m,q=0;q<b.length;q++){h={key:b[q][2]};k=[];for(var r=0;r<a.length;r++)m=a[r],k.push({label:m[4],value:m[2][q],filterIndex:m[0],
filterKey:m[3]});h.values=k;g.push(h)}e(f).css({height:"360px"});c?e(f).siblings(".pt-chart-title").html("<h4>"+c+"</h4>"):e(f).siblings(".pt-chart-title").empty();var x=function(u){u=u.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},u.index)+'">'+u.label+'</div><div class="pt-tooltip-text">'+u.value+"</div></div>"},p=this,z=this.options.numberFormatter;nv.addGraph(function(){if(1<g.length){var u=nv.models.multiBarChart().x(function(w){return w.label}).y(function(w){return w.value}).staggerLabels(!0).showControls(!1);
var D=u.multibar}else u=nv.models.discreteBarChart().x(function(w){return w.label}).y(function(w){return w.value}).staggerLabels(!0).showValues(!0),u.valueFormat(z),D=u.discretebar;u.tooltip.contentGenerator(x);u.yAxis.tickFormat(z);u.xAxis.tickFormat(function(w){return l(w,18)});d3.select(e(f).get(0)).append("svg").attr("class","nv").datum(g).transition().duration(500).call(u);if(p.options.exploreChart&&d)D.dispatch.on("elementClick",function(w){var C=w.data.filterKey;null===C&&(C="None");var y=
d;"__other__"==w.data.filterIndex&&(y+="__belongs");p._chartExplore([[y,C]])});nv.utils.windowResize(u.update);return u})}},_renderBreakDown:function(a,b,c,d){var f=this.chart;if(f){e(f).closest(".pt-chart-contents").show().css({width:"96%"});var g=a.cells,l=[],h=[];if(0===b){var k=a.rows;var m=a.cols;a=function(y,v){return g[l[y]][h[v]].v[0]};var q=d[0];var r=d[1]}else k=a.cols,m=a.rows,a=function(y,v){return g[h[v]][l[y]].v[0]},q=d[1],r=d[0];var x;d=[];b=[];var p=0;for(x=k.length;p<x;p++)k[p][1]||
(d.push(k[p]),l.push(p));p=0;for(x=m.length;p<x;p++)m[p][1]||(b.push(m[p]),h.push(p));var z=[];for(k=0;k<b.length;k++){m={key:b[k][4],filterIndex:b[k][0],filterKey:b[k][3]};p=[];for(x=0;x<d.length;x++)p.push({label:d[x][4],filterIndex:d[x][0],filterKey:d[x][3],value:a(x,k)});m.values=p;z.push(m)}a=Math.max(d.length*Math.max(16*(b.length+1),50)+70,360);e(f).css({height:a+"px"});c?e(f).siblings(".pt-chart-title").html("<h4>"+c+"</h4>"):e(f).siblings(".pt-chart-title").empty();var u=function(y){var v=
y.series[0];y=y.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},y.index)+'">'+v.key+'</div><div class="pt-tooltip-text">'+y.label+': <span class="pt-tooltip-value">'+y.value+"</span></div></div>"},D=this,w=this.options.numberFormatter,C=this._truncateLabel;nv.addGraph(function(){var y=nv.models.multiBarHorizontalChart().x(function(v){return v.label}).y(function(v){return v.value}).margin({top:20,right:20,bottom:20,left:175}).showValues(!0).duration(350).showControls(!0);
y.tooltip.contentGenerator(u);y.valueFormat(w);y.yAxis.tickFormat(w);y.xAxis.tickFormat(function(v){return C(v,24)});d3.select(e(f).get(0)).append("svg").attr("class","nv").datum(z).call(y);if(D.options.exploreChart&&q&&r)y.multibar.dispatch.on("elementClick",function(v){v=v.data;var F=d3.event.currentTarget.parentElement.__data__,E=F.filterKey;null===E&&(E="None");F="__other__"==F.filterIndex?r+"__belongs":r;var I=v.filterKey;null===I&&(I="None");D._chartExplore([["__other__"==v.filterIndex?q+"__belongs":
q,I],[F,E]])});nv.utils.windowResize(y.update);return y})}},_renderSpectrum:function(a,b,c){var d=this.chart;if(d){var f=this,g=a.cells,l=a.labels;if("rows"==b){var h=a.rows;var k=a.cols;b=l.rows;var m=l.cols;var q=c[0];var r=c[1];var x=function(n,t){return g[n][t]}}else h=a.cols,k=a.rows,b=l.cols,m=l.rows,q=c[1],r=c[0],x=function(n,t){return g[t][n]};var p=function(n,t){return null===n?k[t]:null===t?h[n]:x(n,t)},z=function(n,t){t===K&&(t="silver");for(var B=[],A,G,H=0;H<k.length;H++)A=p(null,H),
G=null===n?A[2][0]:p(n,H).v[0],!A[1]&&0<=A[2][0]&&B.push({filterIndex:A[0],filterKey:A[3],label:A[4],value:G,color:t});return B},u=[],D=0;for(c=0;c<h.length;c++){var w=p(c,null);!w[1]&&0<=w[2][0]&&(u.push({position:c,filterIndex:w[0],filterKey:w[3],label:w[4],value:w[2][0]}),D+=w[2][0])}f.chartOptions.currentDataIndex=null;e(d).removeAttr("style").closest(".pt-chart-contents").css({height:"auto"}).show();e(d).siblings(".pt-chart-title").empty();c=e('<div class="pt-spectrum-pie">').appendTo(d);d=e('<div class="pt-spectrum-bar">').appendTo(d);
var C=this.options.numberFormatter,y=this._truncateLabel,v=nv.models.discreteBarChart().x(function(n){return n.label}).y(function(n){return n.value}).color(["silver"]).staggerLabels(!0).showValues(!0);v.tooltip.contentGenerator(function(n){n=n.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+(n.color||["silver"])+'">'+n.label+'</div><div class="pt-tooltip-text">'+C(n.value)+"</div></div>"});v.valueFormat(C);v.yAxis.tickFormat(C);v.xAxis.tickFormat(function(n){return y(n,
18)});var F=d3.select(e(d).get(0)).append("svg").attr("class","nv");d=Math.floor(c.width()/2)-30;var E=nv.models.pieChart().x(function(n){return n.label}).y(function(n){return n.value}).height(280).width(d).margin({top:-20,left:20}).labelType("percent").labelThreshold(.1).showLegend(!1).donut(!0).donutRatio(.35);E.tooltip.enabled(!1);E.legend.align(!0).rightAlign(!1);E.pie.startAngle(function(n){return n.startAngle/2-Math.PI/2}).endAngle(function(n){return n.endAngle/2-Math.PI/2});E.pie.dispatch.on("elementMouseover",
function(n){var t=n.index;if(f.chartOptions.currentDataIndex!=t){f._removeChartTooltip();f.chartOptions.currentDataIndex=t;n=n.data;var B=n.value,A=d3.event;f._renderChartTooltip(A.pageX,A.pageY,'<div class="pt-tooltip-label">'+n.label+'</div><div class="pt-tooltip-text">'+(B+" ("+Math.round(B/D*100)+"%)</div>"));e(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},t)})}}).on("elementMouseout",function(){e(".pt-tooltip").remove();f.chartOptions.currentDataIndex=null;f.chartOptions.currentSeriesIndex=
null});var I=d3.select(e(c).get(0)).append("svg").attr("class","nv").style({"min-width":d-30+"px"});d=d3.select(e(c).get(0)).append("div").attr("class","pt-spectrum-form");d.append("h4").html(l.layer+" "+l.per+" "+m);d.append("label").html(b+":");var J=d.append("select");J.append("option").attr("value","null").style("font-weight","bold").html(f.options.textAll);J.selectAll(".pt-series-item").data(u).enter().append("option").attr("class","pt-series-item").attr("value",function(n,t){return t}).html(function(n){return n.label});
d.append("label").html(l.total+":");var N=d.append("span").text(a.total),L=function(n){if(null===n||f.chartOptions.currentSpectrumIndex==n){var t=function(G,H){return nv.utils.defaultColor()({},H)};I.selectAll(".nv-slice").style("fill",t).style("stroke",t);t=z(null);F.datum([{key:null,filterIndex:null,filterKey:null,values:t}]);v.update();f.chartOptions.currentSpectrumIndex=null;J.property("value","null");N.text(a.total)}else{var B=u[n],A=nv.utils.defaultColor()({},n);t=function(G,H){return H==n?
A:"silver"};I.selectAll(".nv-slice").style("fill",t).style("stroke",t);t=z(B.position,A);F.datum([{key:B.position,filterIndex:B.filterIndex,filterKey:B.filterKey,values:t}]);v.update();f.chartOptions.currentSpectrumIndex=n;J.property("value",n);N.text(u[n].value)}};E.pie.dispatch.on("elementClick",function(n){L(n.index)});J.on("change.pt",function(){var n=d3.select(this).property("value");"null"==n?L(null):L(n)});nv.addGraph(function(){I.datum(u).transition().duration(1200).call(E);nv.utils.windowResize(E.update);
return E});nv.addGraph(function(){F.datum([{key:null,filterIndex:null,filterKey:null,values:z(null)}]).transition().duration(500).call(v);if(f.options.exploreChart&&q&&r)v.discretebar.dispatch.on("elementClick",function(n){var t=n.data,B=d3.event.currentTarget.parentElement.__data__;n=B.filterIndex;B=B.filterKey;var A=t.filterIndex;t=t.filterKey;var G=[];null!==n&&G.push(["__other__"==n?q+"__belongs":q,B||"None"]);null!==A&&G.push(["__other__"==A?r+"__belongs":r,t||"None"]);f._chartExplore(G)});nv.utils.windowResize(v.update);
return v})}},_chartExplore:function(a){var b=this.options,c=e(this.element).closest(".ui-tabs"),d=b.filterTab;if(c.length&&!1!==d)b=(b=b.filterForm)?e("#"+b):K,S3.search.setCurrentFilters(b,a),a=d?e("#"+d).index():0,c.tabs("option","active",a);else if(c=b.filterURL)a=this._updateURL(c,a),window.open(a,"_blank")},_cellExplore:function(a){if(e(".pt-cell-records",a).length)this._renderCellRecords(a,!1);else{var b=a.data("recordIDs");if(b.length){var c=e.Deferred(),d=this;c.promise().then(function(){d._renderCellRecords(a,
b)});var f=this._updateAjaxURL({explore:"1"},null,!0),g=this.lookups,l=b.filter(function(m){return!g.hasOwnProperty(m)});if(l.length){var h=e(".pt-cell-zoom",a).hide(),k=e('<div class="inline-throbber">');k.css({display:"inline-block"}).insertAfter(h);e.ajaxS3({type:"POST",url:f,data:JSON.stringify(l),dataType:"json",contentType:"application/json; charset=utf-8",success:function(m){e.extend(d.lookups,m);c.resolve();k.remove();h.show()},error:function(){c.reject();k.remove();h.show()}})}else c.resolve()}}},
_renderChartTooltip:function(a,b,c){e('<div class="pt-tooltip">'+c+"</div>").css({position:"absolute",display:"none",top:b-50,left:a+10,border:"1px solid #999",padding:"10px","min-height":"50px","max-width":"240px","z-index":"501","background-color":"white",color:"#000",opacity:.95}).appendTo("body").fadeIn(200)},_removeChartTooltip:function(){e(".pt-tooltip").remove();this.chartOptions.currentDataIndex=null;this.chartOptions.currentSeriesIndex=null},_getOptions:function(){var a="#"+e(this.element).attr("id");
return{rows:e(a+"-rows").val(),cols:e(a+"-cols").val(),fact:e(a+"-fact").val(),totals:e(a+"-totals").is(":checked")?1:0}},_getFilters:function(){var a="#"+e(this.element).attr("id"),b=null;a=e(a+"-filters");if(a.length)try{b=S3.search.getCurrentFilters(a.first())}catch(c){}return b},_updateURL:function(a,b){var c=[],d={},f;if(b){var g=0;for(f=b.length;g<f;g++){var l=b[g];var h=l[0];d[h]=!0;c.push(h+"="+l[1])}}b=this.options.ajaxURL.split("?");if(1<b.length){l=b[1].split("&");b={};g=0;for(f=l.length;g<
f;g++){var k=l[g].split("=");1<k.length&&(h=decodeURIComponent(k[0]),d[h]||(c.push(h+"="+decodeURIComponent(k[1])),b[h]=!0))}for(h in b)d[h]=!0}b=a.split("?");if(1<b.length)for(l=b[1].split("&"),g=0,f=l.length;g<f;g++)k=l[g].split("="),1<k.length&&(h=decodeURIComponent(k[0]),d[h]||c.push(h+"="+decodeURIComponent(k[1])));a=c.join("&");c=b[0];a&&(c=c+"?"+a);return c},_updateAjaxURL:function(a,b,c){var d=this.options.ajaxURL.split("?"),f=[],g=!1;if(1<d.length){var l=d[1];l=l.split("&")}else l="",l=[];
if(a)for(m in a){var h=a[m];var k=m+"="+h;"totals"==m?this.options.showTotals=h?!0:!1:g||-1!=e.inArray(k,l)||(g=!0);f.push(k)}var m={};var q={},r;if(b){var x=function(z){var u,D,w=[];["contains","anyof","belongs","eq"].forEach(function(C){u=new RegExp("__"+C+"$","g");z.match(u)?D=u:w.push(C)});D&&w.forEach(function(C){q[z.replace(D,"__"+C)]=!0})};h=0;for(r=b.length;h<r;h++){k=b[h];var p=k[0];k=k[1];x(p);null===k?m[p]||(q[p]=!0):(q[p]&&(q[p]=!1),k=p+"="+encodeURIComponent(k),m[p]?m[p].push(k):m[p]=
[k])}}h=0;for(r=l.length;h<r;h++)k=l[h].split("="),1<k.length&&(p=decodeURIComponent(k[0]),k=decodeURIComponent(k[1]),q[p]?g=!0:m[p]?g||-1!=e.inArray(p+"="+k,m[p])||(g=!0):"aggregate"!=p&&(a&&a.hasOwnProperty(p)||f.push(l[h])));for(p in m)for(h=0,r=m[p].length;h<r;h++)g||-1!=e.inArray(m[p][h],l)||(g=!0),f.push(m[p][h]);a=f.join("&");d=d[0];a&&(d=d+"?"+a);if(c)return d;this.options.ajaxURL=d;return g},_setExtension:function(a,b){var c=document.createElement("a");c.href=a;a=c.pathname.split("/");var d=
[];a.length&&(a.forEach(function(g){var l=g.lastIndexOf(".");-1!=l?d.push(g.slice(0,l)):d.push(g)}),d[d.length-1]+="."+b,c.pathname=d.join("/"));var f=c.search;f&&(d=f.slice(1).split().filter(function(g){return"format"!=g.split("=")[0]}),a.length||d.push("format="+b),c.search="?"+d.join("&"));return c.href},reload:function(a,b,c){c="undefined"!=typeof c?c:!0;"undefined"==typeof b&&(b=this._getFilters());var d=this,f=this.element,g=f.find('input[type="hidden"][name="pivotdata"]');if(g.length){f.find(".pt-throbber").show();
if(a||b)var l=this._updateAjaxURL(a,b);l||c?(a=this.options.ajaxURL,b=this.options.timeout,c=e.ajaxS3,e.searchS3!==K&&(c=e.searchS3),f.find(".pt-empty").hide(),d.openRequest&&(d.openRequest.onreadystatechange=null,d.openRequest.abort()),d.openRequest=c({timeout:b,url:a,dataType:"json",type:"GET",success:function(h){d.openRequest=null;g.first().val(JSON.stringify(h));d.refresh()},error:function(h,k,m){console.log("UNAUTHORIZED"==m?i18n.gis_requires_login:h.responseText)}})):d.refresh()}},_downloadXLSX:function(){if(this.element.find('input[type="hidden"][name="pivotdata"]').length){var a=
this._getOptions(),b=this._getFilters();a=this._updateAjaxURL(a,b,!0);a=this._setExtension(a,"xlsx");e.searchDownloadS3!==K?e.searchDownloadS3(a,"_blank"):window.open(a)}},_bindEvents:function(){var a=this,b=e(this.element),c=this.eventNamespace,d="#"+b.attr("id");e(d+"-options legend").on("click"+c,function(){e(this).siblings().toggle();e(this).children().toggle()});e(d+"-filters legend").on("click"+c,function(){e(this).siblings().toggle();e(this).children().toggle()});e(".pt-hide-table",b).on("click"+
c,function(){a.table_options.hidden=!0;e(".pt-table",b).hide();e(".pt-export-opt",b).hide();e(this).hide().siblings(".pt-show-table").show()});e(".pt-show-table",b).on("click"+c,function(){a.table_options.hidden=!1;e(".pt-table",b).show();e(".pt-export-opt",b).show();e(this).hide().siblings(".pt-hide-table").show()});e(".pt-export-xls",b).on("click"+c,function(){a._downloadXLSX()});e(d+"-totals").on("click"+c,function(){var g=e(this).is(":checked");a.options.showTotals!=g&&a.reload({totals:g},null,
!1)});e(d+"-rows,"+d+"-cols,"+d+"-fact").on("change.autosubmit",function(){e(d+"-pt-form").trigger("optionChanged")});if(this.options.autoSubmit){var f=this.options.autoSubmit;e(d+"-pt-form").on("optionChanged",function(){var g=e(this);if(!g.data("noAutoSubmit")){var l=g.data("autoSubmitTimeout");l&&clearTimeout(l);l=setTimeout(function(){var h=a._getOptions(),k=a._getFilters();a.reload(h,k,!1)},f);g.data("autoSubmitTimeout",l)}})}else e(d+"-pt-form input.pt-submit").on("click"+c,function(){var g=
a._getOptions(),l=a._getFilters();a.reload(g,l,!1)});e(d+" .pt-table .pt-cell-zoom").on("click"+c,function(g){g=e(g.currentTarget).closest(".pt-cell");g.length&&a._cellExplore(g)});e(d+"-pchart-rows").on("click"+c,function(){a._renderChart({type:"piechart",axis:"rows"})});e(d+"-vchart-rows").on("click"+c,function(){a._renderChart({type:"barchart",axis:"rows"})});e(d+"-schart-rows").on("click"+c,function(){a._renderChart({type:"spectrum",axis:"rows"})});e(d+"-hchart-rows").on("click"+c,function(){a._renderChart({type:"breakdown",
axis:"rows"})});e(d+"-pchart-cols").on("click"+c,function(){a._renderChart({type:"piechart",axis:"cols"})});e(d+"-vchart-cols").on("click"+c,function(){a._renderChart({type:"barchart",axis:"cols"})});e(d+"-schart-cols").on("click"+c,function(){a._renderChart({type:"spectrum",axis:"cols"})});e(d+"-hchart-cols").on("click"+c,function(){a._renderChart({type:"breakdown",axis:"cols"})});e(".pt-hide-chart",b).on("click"+c,function(){a._renderChart(!1)})},_unbindEvents:function(){var a=e(this.element),b=
"#"+a.attr("id"),c=this.eventNamespace;e(b+" .pt-table .pt-cell-zoom").off(c);e(b+"-options legend").off(c);e(b+"-filters legend").off(c);e(b+"-totals").off(c);e(b+"-rows,"+b+"-cols,"+b+"-fact").off("change.autosubmit");e(b+"-pt-form").off("optionChanged");e("input.pt-submit, .pt-export-xls",a).off(c);e(b+"-pchart-rows,"+b+"-vchart-rows,"+b+"-schart-rows,"+b+"-hchart-rows,"+b+"-pchart-cols,"+b+"-vchart-cols,"+b+"-schart-cols,"+b+"-hchart-cols").off(c);e(".pt-hide-table, .pt-show-table, .pt-hide-chart",
a).off(c)}})})(jQuery);
