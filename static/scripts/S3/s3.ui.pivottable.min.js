/*
 2013-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js 1.8.5 (patched)

*/
(function(e,J){var L=0;e.widget("s3.pivottable",{options:{showTotals:!0,ajaxURL:null,defaultChart:{type:"breakdown",axis:"rows"},renderFilter:!0,renderOptions:!0,renderChart:!0,renderTable:!0,collapseFilter:!1,collapseOptions:!0,collapseChart:!0,collapseTable:!1,exploreChart:!1,filterURL:null,filterForm:null,filterTab:null,autoSubmit:1E3,timeout:1E4,thousandSeparator:" ",thousandGrouping:"3",minTickSize:null,precision:null,textAll:"All",labelRecords:"Records"},_create:function(){this.id=L;L+=1;this.openRequest=
this.chart=this.table=null;this.eventNamespace=".pt"},_init:function(){var a=e(this.element),b=this.options;this.table=this.data=null;this.chartOptions={currentChart:null,currentDataIndex:null,currentSeriesIndex:null,currentSpectrumIndex:null};this.table_options={hidden:!1};var c=a.find(".pt-chart");this.chart=c.length?c.first():null;b.renderFilter||b.renderOptions?(c="#"+a.attr("id"),b.renderOptions?(e(c+"-options").show(),b.collapseOptions&&(e(c+"-options legend").siblings().toggle(),e(c+"-options legend").children().toggle())):
e(c+"-options").hide(),b.renderFilter?(e(c+"-filters").show(),b.collapseFilter&&(e(c+"-filters legend").siblings().toggle(),e(c+"-filters legend").children().toggle())):e(c+"-options").hide()):a.find(".pt-form-container").hide();b.collapseTable&&(this.table_options.hidden=!0,a.find(".pt-table").hide(),a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide());b.numberFormatter=function(d){var f=b.precision;if(null===d||"undefined"==typeof d)return"-";f=f||0==f?d.toFixed(f):d.toString();f=f.split(".");
d=f[0];f=1<f.length?"."+f[1]:"";d=d.replace(new RegExp("\\B(?=(\\d{"+b.thousandGrouping+"})+(?!\\d))","g"),b.thousandSeparator);return d+f};this.refresh()},_destroy:function(){this.table&&this.table.remove();this.chart&&this.chart.empty()},refresh:function(){var a=e(this.element),b=null;this._unbindEvents();var c=a.find('input[type="hidden"][name="pivotdata"]');c.length&&(b=JSON.parse(e(c).first().val()));b?"count"==b.method&&(this.options.precision=0,this.options.minTickSize=1):(b={empty:!0},a.find(".pt-hide-table").hide(),
a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide());this.data=b;this.lookups={};b.nodata?(a.find(".pt-table").first().empty().append(e('<div class="pt-no-data">'+b.nodata+"</div>")),a.find(".pt-hide-table").hide(),a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide()):(this._renderTable(),this._renderChartOptions());this._renderChart();b.empty?a.find(".pt-empty").show():a.find(".pt-empty").hide();this.options.autoSubmit?a.find(".pt-submit").hide():a.find(".pt-submit").show();
this._bindEvents();a.find(".pt-throbber").hide()},_renderTable:function(){var a=e(this.element),b=a.find(".pt-table").first().empty();this.table=null;var c=this.data;if(!c.empty)if(this.options.renderTable){var d=c.cells.slice(0),f=c.cols,g=c.rows,l=c.total,h=c.labels,k=!1,m=!1;c=c.facts;1==c.length&&"list"!=c[0][1]&&(1==g.length&&null===g[0][4]&&(k=!0),1==f.length&&null===f[0][4]&&(m=!0));c=this.options;var q=c.showTotals,r;if(m&&q)for(f=[],r=0;r<g.length;r++)d[r]=[];else{var w=function(p,t){return"__other__"!=
f[t][0]};for(r=0;r<g.length;r++)d[r]=d[r].filter(w);f=f.filter(function(p){return"__other__"!=p[0]})}k&&q?(g=[],d=[]):(d=d.filter(function(p,t){return"__other__"!=g[t][0]}),g=g.filter(function(p){return"__other__"!=p[0]}));b=d3.select(b.get(0)).append("table").attr("class","dataTable display report");b.append("thead").call(this._renderHeader,f,h,c).call(this._renderColumns,f,h,m);k&&q||b.append("tbody").call(this._renderRows,this,g,f,h,d,c);q&&b.append("tfoot").call(this._renderFooter,g,f,h,l);this.table=
e(b.node());this.table_options.hidden?(a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()):(a.find(".pt-show-table").hide(),a.find(".pt-hide-table").show(),a.find(".pt-export-opt").show())}else a.find(".pt-show-table").hide(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()},_renderHeader:function(a,b,c,d){a=a.append("tr");a.append("th").attr("scope","col").text(c.layer);b.length&&a.append("th").attr({scope:"col",colspan:b.length}).text(c.cols);
d.showTotals&&a.append("th").attr({scope:"col","class":"pt-totals-header pt-row-total",rowspan:2}).text(c.total);return a},_renderColumns:function(a,b,c,d){a=a.append("tr");a.append("th").attr({scope:"col","class":"pt-rows-header"}).text(c.rows);a.selectAll("th.pt-data").data(b).enter().append("th").attr({scope:"col","class":"pt-col-label"}).text(function(f){return d?"":f[4]});return a},_renderRows:function(a,b,c,d,f,g,l){c=a.selectAll("tr.pt-row").data(c).enter().append("tr").attr("class",function(h,
k){return k%2?"odd":"even"});c.append("td").text(function(h){return h[4]});c.selectAll("td.pt-cell").data(function(h,k){return g[k]}).enter().append("td").attr("class","pt-cell").each(b._renderCell,f);l.showTotals&&c.append("td").attr("class","pt-row-total").text(function(h){return h[2][0]});return c},_renderCell:function(a,b,c){b=d3.select(this);for(var d=a.i,f,g=0,l=d.length;g<l;g++){f=d[g];var h=b.append("div").attr("class","pt-cell-value");null===f?h.text(c.none):Array.isArray(f)?h.append("ul").selectAll("li").data(f).enter().append("li").html(function(k){return k}):
h.text(f);1<l-g&&h.append("span").text(" / ")}(a=a.k)&&a.length&&(e(b.node()).data("recordIDs",a),b.append("div").attr("class","pt-cell-zoom"))},_renderCellRecords:function(a,b){var c=e(".pt-cell-zoom",a).removeClass("opened");a=e(".pt-cell-records",a).remove();if(b){var d=this.lookups,f=[],g,l=[];b.forEach(function(k){if(g=d[k]){if(g.constructor===Array){k=g[1];if(-1!=l.indexOf(k))return;l.push(k);g=g[0]}g&&f.push(g)}});a=e('<div class="pt-cell-records">');var h=e("<ul>").appendTo(a);f.length?(f.sort(function(k,
m){return k.localeCompare(m)}),f.forEach(function(k){e("<li>").html(k).appendTo(h)})):e("<li>").text(b.length+" "+this.options.textRecords).appendTo(h);c.addClass("opened").after(a)}},_renderFooter:function(a,b,c,d,f){b=b.length%2?"odd":"even";a=a.append("tr").attr("class",b+" pt-totals-row");a.append("th").attr({"class":"pt-totals-header",scope:"row"}).text(d.total);a.selectAll("td.pt-col-total").data(c).enter().append("td").attr("class","pt-col-total").text(function(g){return g[2][0]});a.append("td").attr("class",
"pt-total").text(f);return a},_renderChartOptions:function(){var a=e(this.element),b=a.find(".pt-chart-controls").first().empty(),c=this.data;if(!c.empty&&this.options.renderChart){c=c.labels;var d=a.attr("id");a=c.layer;var f=c.rows,g=c.cols,l=c.per,h=e('<div class="pt-chart-opts">'),k=d+"-pchart-rows",m=d+"-vchart-rows",q=d+"-hchart-rows",r=d+"-schart-rows",w=d+"-pchart-cols",p=d+"-vchart-cols",t=d+"-hchart-cols";d+="-schart-cols";a&&e(h).append(e('<span class="pt-chart-label">'+a+": </span>"));
f&&e(h).append(e('<div id="'+k+'" class="pt-chart-icon pt-pchart"></div><div id="'+m+'" class="pt-chart-icon pt-vchart"></div><span class="pt-chart-label">'+l+" "+f+"</span>"));g&&e(h).append(e('<div id="'+w+'" class="pt-chart-icon pt-pchart"></div><div id="'+p+'" class="pt-chart-icon pt-vchart"></div><span class="pt-chart-label">'+l+" "+g+"</span>"));f&&g&&e(h).append(e('<span class="pt-chart-label">| '+c.breakdown+': </span><div id="'+r+'" class="pt-chart-icon pt-schart"></div><div id="'+q+'" class="pt-chart-icon pt-hchart"></div><span class="pt-chart-label">'+
l+" "+f+'</span><div id="'+d+'"  class="pt-chart-icon pt-schart"></div><div id="'+t+'"  class="pt-chart-icon pt-hchart"></div><span class="pt-chart-label">'+l+" "+g+"</span>"));e(b).append(h)}},_truncateLabel:function(a,b){return a&&a.length>b?a.substring(0,b-3).replace(/\s+$/g,"")+"...":a},_renderChart:function(a){var b=e(this.element),c=this.data;e(".pt-chart-contents",b).hide();if(b=this.chart)if(e(b).off("plothover").off("plotclick").empty(),!c.empty&&this.options.renderChart)if(!1===a)this.options.collapseChart=
!0;else{b=this.options.collapseChart;if("undefined"==typeof a||!a){if(b)return;a=this.chartOptions.currentChart}if("undefined"==typeof a||!a){if(b)return;a=this.options.defaultChart}if("undefined"!=typeof a&&a){this.options.collapseChart=!1;this.chartOptions.currentChart=a;b=a.type;a=a.axis;var d=c.labels,f=d.per,g=d.layer+" "+f+" "+d.rows;d=d.layer+" "+f+" "+d.cols;f=c.filter;var l=f[0],h=f[1];"piechart"==b?"rows"==a?this._renderPieChart(c.rows,g,l):this._renderPieChart(c.cols,d,h):"barchart"==b?
"rows"==a?this._renderBarChart(c.rows,c.facts,g,l):this._renderBarChart(c.cols,c.facts,d,h):"breakdown"==b?"rows"==a?this._renderBreakDown(c,0,g,f):this._renderBreakDown(c,1,d,f):"spectrum"==b&&this._renderSpectrum(c,a,f)}}},_renderPieChart:function(a,b,c){var d=this.chart;if(d){e(d).css({height:"360px"}).closest(".pt-chart-contents").show();b?e(d).siblings(".pt-chart-title").html("<h4>"+b+"</h4>"):e(d).siblings(".pt-chart-title").empty();var f=[],g=0;for(b=0;b<a.length;b++){var l=a[b];!l[1]&&0<=
l[2][0]&&(f.push({index:l[0],label:l[4],value:l[2][0],key:l[3]}),g+=l[2][0])}var h=this;h.chartOptions.currentDataIndex=null;var k=function(m){var q=m.index;if(h.chartOptions.currentDataIndex!=q){h._removeChartTooltip();h.chartOptions.currentDataIndex=q;m=m.data;var r=m.value,w=d3.event;h._renderChartTooltip(w.pageX,w.pageY,'<div class="pt-tooltip-label">'+m.label+'</div><div class="pt-tooltip-text">'+(r+" ("+Math.round(r/g*100)+"%)</div>"));e(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},
q)})}};nv.addGraph(function(){var m=nv.models.pieChart().x(function(q){return q.label}).y(function(q){return q.value}).labelsOutside(!1).labelType("percent").labelThreshold(.03).showLegend(!0);m.tooltip.enabled(!1);m.legend.align(!0).rightAlign(!1);m.pie.dispatch.on("elementMouseover",k).on("elementMouseout",function(){e(".pt-tooltip").remove();h.chartOptions.currentDataIndex=null;h.chartOptions.currentSeriesIndex=null});if(h.options.exploreChart&&c)m.pie.dispatch.on("elementClick",function(q){q=
q.data;h._chartExplore([["__other__"==q.index?c+"__belongs":c,q.key]])});d3.select(e(d).get(0)).append("svg").attr("class","nv").datum(f).transition().duration(1200).call(m);nv.utils.windowResize(m.update);return m})}},_renderBarChart:function(a,b,c,d){var f=this.chart;if(f){e(f).closest(".pt-chart-contents").show().css({width:"96%"});for(var g=[],l,h,k,m=0;m<b.length;m++){l={key:b[m][2]};h=[];for(var q=0;q<a.length;q++)k=a[q],h.push({label:k[4],value:k[2][m],filterIndex:k[0],filterKey:k[3]});l.values=
h;g.push(l)}e(f).css({height:"360px"});c?e(f).siblings(".pt-chart-title").html("<h4>"+c+"</h4>"):e(f).siblings(".pt-chart-title").empty();var r=function(t){t=t.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},t.index)+'">'+t.label+'</div><div class="pt-tooltip-text">'+t.value+"</div></div>"},w=this,p=this.options.numberFormatter;nv.addGraph(function(){if(1<g.length){var t=nv.models.multiBarChart().x(function(y){return y.label}).y(function(y){return y.value}).staggerLabels(!0).showControls(!1);
var C=t.multibar}else t=nv.models.discreteBarChart().x(function(y){return y.label}).y(function(y){return y.value}).staggerLabels(!0).showValues(!0),t.valueFormat(p),C=t.discretebar;t.tooltip.contentGenerator(r);t.yAxis.tickFormat(p);t.xAxis.tickFormat(function(y){return w._truncateLabel(y,18)});d3.select(e(f).get(0)).append("svg").attr("class","nv").datum(g).transition().duration(500).call(t);if(w.options.exploreChart&&d)C.dispatch.on("elementClick",function(y){var z=y.data.filterKey;null===z&&(z=
"None");var v=d;"__other__"==y.data.filterIndex&&(v+="__belongs");w._chartExplore([[v,z]])});nv.utils.windowResize(t.update);return t})}},_renderBreakDown:function(a,b,c,d){var f=this.chart;if(f){e(f).closest(".pt-chart-contents").show().css({width:"96%"});var g=a.cells,l=[],h=[];if(0===b){var k=a.rows;var m=a.cols;a=function(v,x){return g[l[v]][h[x]].v[0]};var q=d[0];var r=d[1]}else k=a.cols,m=a.rows,a=function(v,x){return g[h[x]][l[v]].v[0]},q=d[1],r=d[0];var w;d=[];b=[];var p=0;for(w=k.length;p<
w;p++)k[p][1]||(d.push(k[p]),l.push(p));p=0;for(w=m.length;p<w;p++)m[p][1]||(b.push(m[p]),h.push(p));var t=[];for(k=0;k<b.length;k++){m={key:b[k][4],filterIndex:b[k][0],filterKey:b[k][3]};p=[];for(w=0;w<d.length;w++)p.push({label:d[w][4],filterIndex:d[w][0],filterKey:d[w][3],value:a(w,k)});m.values=p;t.push(m)}a=Math.max(d.length*Math.max(16*(b.length+1),50)+70,360);e(f).css({height:a+"px"});c?e(f).siblings(".pt-chart-title").html("<h4>"+c+"</h4>"):e(f).siblings(".pt-chart-title").empty();var C=function(v){var x=
v.series[0];v=v.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},v.index)+'">'+x.key+'</div><div class="pt-tooltip-text">'+v.label+': <span class="pt-tooltip-value">'+v.value+"</span></div></div>"},y=this,z=this.options.numberFormatter;nv.addGraph(function(){var v=nv.models.multiBarHorizontalChart().x(function(x){return x.label}).y(function(x){return x.value}).margin({top:20,right:20,bottom:20,left:175}).showValues(!0).duration(350).showControls(!0);
v.tooltip.contentGenerator(C);v.valueFormat(z);v.yAxis.tickFormat(z);v.xAxis.tickFormat(function(x){return y._truncateLabel(x,24)});d3.select(e(f).get(0)).append("svg").attr("class","nv").datum(t).call(v);if(y.options.exploreChart&&q&&r)v.multibar.dispatch.on("elementClick",function(x){x=x.data;var E=d3.event.currentTarget.parentElement.__data__,D=E.filterKey;null===D&&(D="None");E="__other__"==E.filterIndex?r+"__belongs":r;var H=x.filterKey;null===H&&(H="None");y._chartExplore([["__other__"==x.filterIndex?
q+"__belongs":q,H],[E,D]])});nv.utils.windowResize(v.update);return v})}},_renderSpectrum:function(a,b,c){var d=this.chart;if(d){var f=this,g=a.cells,l=a.labels;if("rows"==b){var h=a.rows;var k=a.cols;b=l.rows;var m=l.cols;var q=c[0];var r=c[1];var w=function(n,u){return g[n][u]}}else h=a.cols,k=a.rows,b=l.cols,m=l.rows,q=c[1],r=c[0],w=function(n,u){return g[u][n]};var p=function(n,u){return null===n?k[u]:null===u?h[n]:w(n,u)},t=function(n,u){u===J&&(u="silver");for(var B=[],A,F,G=0;G<k.length;G++)A=
p(null,G),F=null===n?A[2][0]:p(n,G).v[0],!A[1]&&0<=A[2][0]&&B.push({filterIndex:A[0],filterKey:A[3],label:A[4],value:F,color:u});return B},C=[],y=0;for(c=0;c<h.length;c++){var z=p(c,null);!z[1]&&0<=z[2][0]&&(C.push({position:c,filterIndex:z[0],filterKey:z[3],label:z[4],value:z[2][0]}),y+=z[2][0])}f.chartOptions.currentDataIndex=null;e(d).removeAttr("style").closest(".pt-chart-contents").css({height:"auto"}).show();e(d).siblings(".pt-chart-title").empty();c=e('<div class="pt-spectrum-pie">').appendTo(d);
d=e('<div class="pt-spectrum-bar">').appendTo(d);var v=this.options.numberFormatter,x=nv.models.discreteBarChart().x(function(n){return n.label}).y(function(n){return n.value}).color(["silver"]).staggerLabels(!0).showValues(!0);x.tooltip.contentGenerator(function(n){n=n.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+(n.color||["silver"])+'">'+n.label+'</div><div class="pt-tooltip-text">'+v(n.value)+"</div></div>"});x.valueFormat(v);x.yAxis.tickFormat(v);x.xAxis.tickFormat(function(n){return f._truncateLabel(n,
18)});var E=d3.select(e(d).get(0)).append("svg").attr("class","nv");d=Math.floor(c.width()/2)-30;var D=nv.models.pieChart().x(function(n){return n.label}).y(function(n){return n.value}).height(280).width(d).margin({top:-20,left:20}).labelType("percent").labelThreshold(.1).showLegend(!1).donut(!0).donutRatio(.35);D.tooltip.enabled(!1);D.legend.align(!0).rightAlign(!1);D.pie.startAngle(function(n){return n.startAngle/2-Math.PI/2}).endAngle(function(n){return n.endAngle/2-Math.PI/2});D.pie.dispatch.on("elementMouseover",
function(n){var u=n.index;if(f.chartOptions.currentDataIndex!=u){f._removeChartTooltip();f.chartOptions.currentDataIndex=u;n=n.data;var B=n.value,A=d3.event;f._renderChartTooltip(A.pageX,A.pageY,'<div class="pt-tooltip-label">'+n.label+'</div><div class="pt-tooltip-text">'+(B+" ("+Math.round(B/y*100)+"%)</div>"));e(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},u)})}}).on("elementMouseout",function(){e(".pt-tooltip").remove();f.chartOptions.currentDataIndex=null;f.chartOptions.currentSeriesIndex=
null});var H=d3.select(e(c).get(0)).append("svg").attr("class","nv").style({"min-width":d-30+"px"});d=d3.select(e(c).get(0)).append("div").attr("class","pt-spectrum-form");d.append("h4").html(l.layer+" "+l.per+" "+m);d.append("label").html(b+":");var I=d.append("select");I.append("option").attr("value","null").style("font-weight","bold").html(f.options.textAll);I.selectAll(".pt-series-item").data(C).enter().append("option").attr("class","pt-series-item").attr("value",function(n,u){return u}).html(function(n){return n.label});
d.append("label").html(l.total+":");var M=d.append("span").text(a.total),K=function(n){if(null===n||f.chartOptions.currentSpectrumIndex==n){var u=function(F,G){return nv.utils.defaultColor()({},G)};H.selectAll(".nv-slice").style("fill",u).style("stroke",u);u=t(null);E.datum([{key:null,filterIndex:null,filterKey:null,values:u}]);x.update();f.chartOptions.currentSpectrumIndex=null;I.property("value","null");M.text(a.total)}else{var B=C[n],A=nv.utils.defaultColor()({},n);u=function(F,G){return G==n?
A:"silver"};H.selectAll(".nv-slice").style("fill",u).style("stroke",u);u=t(B.position,A);E.datum([{key:B.position,filterIndex:B.filterIndex,filterKey:B.filterKey,values:u}]);x.update();f.chartOptions.currentSpectrumIndex=n;I.property("value",n);M.text(C[n].value)}};D.pie.dispatch.on("elementClick",function(n){K(n.index)});I.on("change.pt",function(){var n=d3.select(this).property("value");"null"==n?K(null):K(n)});nv.addGraph(function(){H.datum(C).transition().duration(1200).call(D);nv.utils.windowResize(D.update);
return D});nv.addGraph(function(){E.datum([{key:null,filterIndex:null,filterKey:null,values:t(null)}]).transition().duration(500).call(x);if(f.options.exploreChart&&q&&r)x.discretebar.dispatch.on("elementClick",function(n){var u=n.data,B=d3.event.currentTarget.parentElement.__data__;n=B.filterIndex;B=B.filterKey;var A=u.filterIndex;u=u.filterKey;var F=[];null!==n&&F.push(["__other__"==n?q+"__belongs":q,B||"None"]);null!==A&&F.push(["__other__"==A?r+"__belongs":r,u||"None"]);f._chartExplore(F)});nv.utils.windowResize(x.update);
return x})}},_chartExplore:function(a){var b=this.options,c=e(this.element).closest(".ui-tabs"),d=b.filterTab;if(c.length&&!1!==d)b=(b=b.filterForm)?e("#"+b):J,S3.search.setCurrentFilters(b,a),a=d?e("#"+d).index():0,c.tabs("option","active",a);else if(c=b.filterURL)a=this._updateURL(c,a),window.open(a,"_blank")},_cellExplore:function(a){if(e(".pt-cell-records",a).length)this._renderCellRecords(a,!1);else{var b=a.data("recordIDs");if(b.length){var c=e.Deferred(),d=this;c.promise().then(function(){d._renderCellRecords(a,
b)});var f=this._updateAjaxURL({explore:"1"},null,!0),g=this.lookups,l=b.filter(function(m){return!g.hasOwnProperty(m)});if(l.length){var h=e(".pt-cell-zoom",a).hide(),k=e('<div class="inline-throbber">');k.css({display:"inline-block"}).insertAfter(h);e.ajaxS3({type:"POST",url:f,data:JSON.stringify(l),dataType:"json",contentType:"application/json; charset=utf-8",success:function(m){e.extend(d.lookups,m);c.resolve();k.remove();h.show()},error:function(){c.reject();k.remove();h.show()}})}else c.resolve()}}},
_renderChartTooltip:function(a,b,c){e('<div class="pt-tooltip">'+c+"</div>").css({position:"absolute",display:"none",top:b-50,left:a+10,border:"1px solid #999",padding:"10px","min-height":"50px","max-width":"240px","z-index":"501","background-color":"white",color:"#000",opacity:.95}).appendTo("body").fadeIn(200)},_removeChartTooltip:function(){e(".pt-tooltip").remove();this.chartOptions.currentDataIndex=null;this.chartOptions.currentSeriesIndex=null},_getOptions:function(){var a="#"+e(this.element).attr("id");
return{rows:e(a+"-rows").val(),cols:e(a+"-cols").val(),fact:e(a+"-fact").val(),totals:e(a+"-totals").is(":checked")?1:0}},_getFilters:function(){var a="#"+e(this.element).attr("id"),b=null;a=e(a+"-filters");if(a.length)try{b=S3.search.getCurrentFilters(a.first())}catch(c){}return b},_updateURL:function(a,b){var c=[],d={},f;if(b){var g=0;for(f=b.length;g<f;g++){var l=b[g];var h=l[0];d[h]=!0;c.push(h+"="+l[1])}}b=this.options.ajaxURL.split("?");if(1<b.length){l=b[1].split("&");b={};g=0;for(f=l.length;g<
f;g++){var k=l[g].split("=");1<k.length&&(h=decodeURIComponent(k[0]),d[h]||(c.push(h+"="+decodeURIComponent(k[1])),b[h]=!0))}for(h in b)d[h]=!0}b=a.split("?");if(1<b.length)for(l=b[1].split("&"),g=0,f=l.length;g<f;g++)k=l[g].split("="),1<k.length&&(h=decodeURIComponent(k[0]),d[h]||c.push(h+"="+decodeURIComponent(k[1])));a=c.join("&");c=b[0];a&&(c=c+"?"+a);return c},_updateAjaxURL:function(a,b,c){var d=this.options.ajaxURL.split("?"),f=[],g=!1;if(1<d.length){var l=d[1];l=l.split("&")}else l="",l=[];
if(a)for(m in a){var h=a[m];var k=m+"="+h;"totals"==m?this.options.showTotals=h?!0:!1:g||-1!=e.inArray(k,l)||(g=!0);f.push(k)}var m={};var q={},r;if(b){var w=function(t){var C,y,z=[];["contains","anyof","belongs","eq"].forEach(function(v){C=new RegExp("__"+v+"$","g");t.match(C)?y=C:z.push(v)});y&&z.forEach(function(v){q[t.replace(y,"__"+v)]=!0})};h=0;for(r=b.length;h<r;h++){k=b[h];var p=k[0];k=k[1];w(p);null===k?m[p]||(q[p]=!0):(q[p]&&(q[p]=!1),k=p+"="+encodeURIComponent(k),m[p]?m[p].push(k):m[p]=
[k])}}h=0;for(r=l.length;h<r;h++)k=l[h].split("="),1<k.length&&(p=decodeURIComponent(k[0]),k=decodeURIComponent(k[1]),q[p]?g=!0:m[p]?g||-1!=e.inArray(p+"="+k,m[p])||(g=!0):"aggregate"!=p&&(a&&a.hasOwnProperty(p)||f.push(l[h])));for(p in m)for(h=0,r=m[p].length;h<r;h++)g||-1!=e.inArray(m[p][h],l)||(g=!0),f.push(m[p][h]);a=f.join("&");d=d[0];a&&(d=d+"?"+a);if(c)return d;this.options.ajaxURL=d;return g},_setExtension:function(a,b){var c=document.createElement("a");c.href=a;a=c.pathname.split("/");var d=
[];a.length&&(a.forEach(function(g){var l=g.lastIndexOf(".");-1!=l?d.push(g.slice(0,l)):d.push(g)}),d[d.length-1]+="."+b,c.pathname=d.join("/"));var f=c.search;f&&(d=f.slice(1).split().filter(function(g){return"format"!=g.split("=")[0]}),a.length||d.push("format="+b),c.search="?"+d.join("&"));return c.href},reload:function(a,b,c){c="undefined"!=typeof c?c:!0;"undefined"==typeof b&&(b=this._getFilters());var d=this,f=this.element,g=f.find('input[type="hidden"][name="pivotdata"]');if(g.length){f.find(".pt-throbber").show();
if(a||b)var l=this._updateAjaxURL(a,b);l||c?(a=this.options.ajaxURL,b=this.options.timeout,c=e.ajaxS3,e.searchS3!==J&&(c=e.searchS3),f.find(".pt-empty").hide(),d.openRequest&&(d.openRequest.onreadystatechange=null,d.openRequest.abort()),d.openRequest=c({timeout:b,url:a,dataType:"json",type:"GET",success:function(h){d.openRequest=null;g.first().val(JSON.stringify(h));d.refresh()},error:function(h,k,m){console.log("UNAUTHORIZED"==m?i18n.gis_requires_login:h.responseText)}})):d.refresh()}},_downloadXLSX:function(){if(this.element.find('input[type="hidden"][name="pivotdata"]').length){var a=
this._getOptions(),b=this._getFilters();a=this._updateAjaxURL(a,b,!0);a=this._setExtension(a,"xlsx");e.searchDownloadS3!==J?e.searchDownloadS3(a,"_blank"):window.open(a)}},_bindEvents:function(){var a=this,b=e(this.element),c=this.eventNamespace,d="#"+b.attr("id");e(d+"-options legend").on("click"+c,function(){e(this).siblings().toggle();e(this).children().toggle()});e(d+"-filters legend").on("click"+c,function(){e(this).siblings().toggle();e(this).children().toggle()});e(".pt-hide-table",b).on("click"+
c,function(){a.table_options.hidden=!0;e(".pt-table",b).hide();e(".pt-export-opt",b).hide();e(this).hide().siblings(".pt-show-table").show()});e(".pt-show-table",b).on("click"+c,function(){a.table_options.hidden=!1;e(".pt-table",b).show();e(".pt-export-opt",b).show();e(this).hide().siblings(".pt-hide-table").show()});e(".pt-export-xls",b).on("click"+c,function(){a._downloadXLSX()});e(d+"-totals").on("click"+c,function(){var g=e(this).is(":checked");a.options.showTotals!=g&&a.reload({totals:g},null,
!1)});e(d+"-rows,"+d+"-cols,"+d+"-fact").on("change.autosubmit",function(){e(d+"-pt-form").trigger("optionChanged")});if(this.options.autoSubmit){var f=this.options.autoSubmit;e(d+"-pt-form").on("optionChanged",function(){var g=e(this);if(!g.data("noAutoSubmit")){var l=g.data("autoSubmitTimeout");l&&clearTimeout(l);l=setTimeout(function(){var h=a._getOptions(),k=a._getFilters();a.reload(h,k,!1)},f);g.data("autoSubmitTimeout",l)}})}else e(d+"-pt-form input.pt-submit").on("click"+c,function(){var g=
a._getOptions(),l=a._getFilters();a.reload(g,l,!1)});e(d+" .pt-table .pt-cell-zoom").on("click"+c,function(g){g=e(g.currentTarget).closest(".pt-cell");g.length&&a._cellExplore(g)});e(d+"-pchart-rows").on("click"+c,function(){a._renderChart({type:"piechart",axis:"rows"})});e(d+"-vchart-rows").on("click"+c,function(){a._renderChart({type:"barchart",axis:"rows"})});e(d+"-schart-rows").on("click"+c,function(){a._renderChart({type:"spectrum",axis:"rows"})});e(d+"-hchart-rows").on("click"+c,function(){a._renderChart({type:"breakdown",
axis:"rows"})});e(d+"-pchart-cols").on("click"+c,function(){a._renderChart({type:"piechart",axis:"cols"})});e(d+"-vchart-cols").on("click"+c,function(){a._renderChart({type:"barchart",axis:"cols"})});e(d+"-schart-cols").on("click"+c,function(){a._renderChart({type:"spectrum",axis:"cols"})});e(d+"-hchart-cols").on("click"+c,function(){a._renderChart({type:"breakdown",axis:"cols"})});e(".pt-hide-chart",b).on("click"+c,function(){a._renderChart(!1)})},_unbindEvents:function(){var a=e(this.element),b=
"#"+a.attr("id"),c=this.eventNamespace;e(b+" .pt-table .pt-cell-zoom").off(c);e(b+"-options legend").off(c);e(b+"-filters legend").off(c);e(b+"-totals").off(c);e(b+"-rows,"+b+"-cols,"+b+"-fact").off("change.autosubmit");e(b+"-pt-form").off("optionChanged");e("input.pt-submit, .pt-export-xls",a).off(c);e(b+"-pchart-rows,"+b+"-vchart-rows,"+b+"-schart-rows,"+b+"-hchart-rows,"+b+"-pchart-cols,"+b+"-vchart-cols,"+b+"-schart-cols,"+b+"-hchart-cols").off(c);e(".pt-hide-table, .pt-show-table, .pt-hide-chart",
a).off(c)}})})(jQuery);
