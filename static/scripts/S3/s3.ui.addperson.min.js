/*
 2017-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.owns=function(b,k){return Object.prototype.hasOwnProperty.call(b,k)};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,k,m){if(b==Array.prototype||b==Object.prototype)return b;b[k]=m.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var k=0;k<b.length;++k){var m=b[k];if(m&&m.Math==Math)return m}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,k){var m=$jscomp.propertyToPolyfillSymbol[k];if(null==m)return b[k];m=b[m];return void 0!==m?m:b[k]};
$jscomp.polyfill=function(b,k,m,n){k&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,k,m,n):$jscomp.polyfillUnisolated(b,k,m,n))};$jscomp.polyfillUnisolated=function(b,k,m,n){m=$jscomp.global;b=b.split(".");for(n=0;n<b.length-1;n++){var a=b[n];if(!(a in m))return;m=m[a]}b=b[b.length-1];n=m[b];k=k(n);k!=n&&null!=k&&$jscomp.defineProperty(m,b,{configurable:!0,writable:!0,value:k})};
$jscomp.polyfillIsolated=function(b,k,m,n){var a=b.split(".");b=1===a.length;n=a[0];n=!b&&n in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var c=0;c<a.length-1;c++){var d=a[c];if(!(d in n))return;n=n[d]}a=a[a.length-1];m=$jscomp.IS_SYMBOL_NATIVE&&"es6"===m?n[a]:null;k=k(m);null!=k&&(b?$jscomp.defineProperty($jscomp.polyfills,a,{configurable:!0,writable:!0,value:k}):k!==m&&(void 0===$jscomp.propertyToPolyfillSymbol[a]&&(m=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[a]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(a):$jscomp.POLYFILL_PREFIX+m+"$"+a),$jscomp.defineProperty(n,$jscomp.propertyToPolyfillSymbol[a],{configurable:!0,writable:!0,value:k})))};$jscomp.polyfill("Object.values",function(b){return b?b:function(k){var m=[],n;for(n in k)$jscomp.owns(k,n)&&m.push(k[n]);return m}},"es8","es3");
(function(b,k){var m=function(a,c){var d=function(l,p){return p?encodeURIComponent(l)+"="+encodeURIComponent(p):""};a=a.split("?");a=[a[0]].concat((a[1]||"").split("#"));var e=a[1],f,h={},g;e=e?e.split("&").map(function(l){f=decodeURIComponent(l.split("=")[0]);return c.hasOwnProperty(f)?(h[f]=!0,d(f,c[f])):l}).filter(function(l){return l}):[];for(f in c)h[f]||(g=d(f,c[f]))&&e.push(g);g=a[0];e.length&&(g+="?"+e.join("&"));a[2]&&(g+="#"+a[2]);return g};S3.addPersonWidgetReady=function(a){var c=new jQuery.Deferred,
d=b("#"+a);if(d.data("lookup_contact")!==k)c.resolve(d);else d.on("addPersonReady",function(){c.resolve(d)});return c.promise()};var n=0;b.widget("s3.addPerson",{options:{lookupDuplicates:!1,separateNameFields:!1,trigger:"full_name",c:"pr",f:"person",editableFields:[],tags:[],chars:2,delay:800,downIcon:"fa fa-caret-down",yesIcon:"fa fa-check",noIcon:"fa fa-remove"},_create:function(){this.id=n;n+=1;this.eventNamespace=".addPerson"},_init:function(){var a=b(this.element),c=this.options;this.fieldName=
a=a.attr("id");this.selector="#"+a;this.data={};this.edited=!1;a=b(this.selector+"__row").hide();a.hasClass("form-row")||a.hasClass("control-group")?this.formStyle="div":this.formStyle="table";this.topFields=["organisation_id","pe_label"];a=b(this.selector+"_pe_label");a.length&&(this.idLabel=a);a=c.trigger;if(c.separateNameFields)if("first_name"==a)var d=["first_name","middle_name","last_name"];else a="last_name",d=["last_name","middle_name","first_name"];else a="full_name",d=["full_name"];c.trigger=
a;this.triggerRow=b(this._rowSelector(a));this.trigger=b(this.selector+"_"+a);this.nameFields=d;var e="father_name grandfather_name year_of_birth date_of_birth gender occupation mobile_phone home_phone email".split(" ");c.tags.forEach(function(f){-1==e.indexOf(f)&&e.push(f)});this.personFields=e;this._arrangeFormRows();this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=b(this.element),c=this.selector,d=this.options;this._unbindEvents();this.pendingAC=
!1;var e=this.throbber;e&&e.remove();e=b('<div class="throbber input_throbber"></div>');e.hide().insertAfter(this.trigger);this.throbber=e;var f=this.idLabel;f&&(e=b('<div class="throbber input_throbber"></div>'),e.hide().insertAfter(f),this.idLabelThrobber=e);(e=a.val())?(isNaN(e-0)||(this.data={id:e},this._serialize()),this.data.id?(this._disableInputs(),this._toggleActions({undo:!1})):(this._enableAutocomplete(),this._toggleActions({edit:!1,clear:!1}))):(this._serialize(),this._enableAutocomplete(),
this._toggleActions({edit:!1,clear:!1}));b(c+"_edit_bar").removeClass("hide").show();d.lookupDuplicates&&(d=this.fieldName+"_duplicates",b("#"+d).length||(d='<div id="'+d+'" class="req"></div>',"div"==this.formStyle?b(c+"_box_bottom").before(d):b(c+"_box_bottom1").before(d)));this._bindEvents();a.trigger("addPersonReady")},_arrangeFormRows:function(){var a=b(this.element),c=this.selector,d=b(c+"__row").hide();if("div"==this.formStyle){b(c+"_box_bottom").removeClass("hide").show().insertAfter(d);var e=
this,f=this.topFields.concat(this.nameFields).concat(this.personFields).reverse();f.forEach(function(h){d.after(b(e._rowSelector(h)))});b(f.map(this._rowSelector,this).join(",")).removeClass("hide").show()}else b(c+"__row1").hide();c=b(c+"_title__row");a=a.next(".error_wrapper");d.after(a).after(c.removeClass("hide").show())},_allFields:function(){return this.topFields.concat(this.nameFields).concat(this.personFields)},_fieldMap:function(){var a={pe_label:"pe_label",email:"email",mobile_phone:"mphone",
home_phone:"hphone",gender:"sex",date_of_birth:"dob",year_of_birth:"year_of_birth",father_name:"father_name",grandfather_name:"grandfather_name",occupation:"occupation",organisation_id:"org_id"};this.options.separateNameFields&&(a.first_name="first_name",a.middle_name="middle_name",a.last_name="last_name");this.options.tags.forEach(function(c){a.hasOwnProperty(c)||(a[c]=c)});return a},_rowSelector:function(a){return this.selector+"_"+a+"__row"},_readInputs:function(){var a=this.selector,c={},d;this._allFields().forEach(function(e){d=
b(a+"_"+e);d.length&&(c[e]=d.val())});this.data=c},_updateInputs:function(){var a=this.selector,c=this.data,d;this._allFields().forEach(function(e){d=b(a+"_"+e);d.length&&c.hasOwnProperty(e)&&d.val(c[e])})},_serialize:function(){b(this.element).val(JSON.stringify(this.data))},_deserialize:function(){var a=b(this.element).val(),c=a-0;this.data=isNaN(c)?JSON.parse(a):{id:c}},_toggleActions:function(a){var c={edit:".edit-action",clear:".clear-action",undo:".undo-action"},d=this.selector,e;for(e in a){var f=
b(d+"_edit_bar "+c[e]);a[e]?f.removeClass("hide").show():f.hide()}},_toggleDatePickerTrigger:function(a){var c=b(this.selector+"_date_of_birth__row .calendar-clear-btn"),d=b(this.selector+"_date_of_birth__row .ui-datepicker-trigger");a?(d.removeClass("hide").show(),c.removeClass("hide").show()):(d.hide(),c.hide())},_enableInputs:function(a){var c=this.selector;(a?this.options.editableFields:this._allFields()).forEach(function(d){b(c+"_"+d).prop("disabled",!1)});this._toggleDatePickerTrigger(!0)},
_disableInputs:function(){var a=this.selector;this._allFields().forEach(function(c){b(a+"_"+c).prop("disabled",!0)});this._toggleDatePickerTrigger(!1);this._toggleActions({edit:!0,clear:!0,undo:!1})},_reset:function(a){var c=this.topFields.concat(this.personFields);a||(c=c.concat(this.nameFields));var d=this.selector;c.forEach(function(e){b(d+"_"+e).prop("disabled",!1).val("")});this._toggleDatePickerTrigger(!0);a?this._readInputs():this.data={};this._serialize()},_clear:function(){this.previousSelection=
b.extend({},this.data);this._reset();this._enableAutocomplete();this._toggleActions({edit:!1,clear:!1,undo:!0})},_edit:function(){this.previousSelection=b.extend({},this.data);this._enableInputs(!0);this.trigger.autocomplete("destroy");this.edited=!0;this._toggleActions({edit:!1,clear:!1,undo:!0})},_undo:function(){var a=this.previousSelection;this.pendingAC&&(this.pendingAC.abort(),this.pendingAC=!1,this.throbber.hide());this.edited=!1;a&&Object.values(a).length?(this.data=b.extend({},this.previousSelection),
this._serialize(),this._updateInputs(),this._disableInputs()):this._reset();this._clearDuplicates()},_clearError:function(){b(this.selector+"_title__row").next(".error_wrapper").fadeOut("slow",function(){S3.hideAlerts()})},_fullName:function(a){return a.label!==k?a.label:a.name},_autocompleteLabel:function(a){if(a.label!==k)return a.label;var c=a.name,d=[a.job,a.org].filter(function(e){return e});d.length&&(c+=" ("+d.join(",")+")");this.idLabel&&(a=a.pe_label)&&(c+=' <span class="pe-label">['+a+"]</span> ");
return c},_enableAutocomplete:function(){var a=this.trigger;if(!a.attr("autocomplete")){var c=this.options,d=this;this.acURL=S3.Ap.concat("/"+c.c+"/"+c.f+"/search_ac");this.idLabel&&(this.acURL+="?label=1");var e=a.autocomplete({delay:c.delay,minLength:c.chars,source:function(f,h){d.pendingAC&&d.pendingAC.abort();d.pendingAC=b.ajax({url:d.acURL,data:{term:f.term}}).done(function(g){0===g.length?delete d.data.id:g.push({id:0,value:"",label:i18n.none_of_the_above});h(g)})},search:function(){d.throbber.show();
return!0},response:function(f,h,g){d.throbber.hide();return g},focus:function(){return!1},select:function(f,h){f=h.item;f.id?(c.separateNameFields||a.val(d._fullName(f)),d._selectPerson(f.id)):delete d.data.id;return!1}}).data("ui-autocomplete");e&&(e._renderItem=function(f,h){var g=d._autocompleteLabel(h);return b("<li>").data("item.autocomplete",h).append("<a>"+g+"</a>").appendTo(f)})}},_selectPerson:function(a){var c=this.options,d=this.selector,e=c.trigger,f;this.nameFields.forEach(function(p){f=
b(d+"_"+p).prop("disabled",!1);p!=e&&f.val("")});this._reset(!0);var h=this,g=this.trigger,l=S3.Ap.concat("/"+c.c+"/"+c.f+"/"+a+"/lookup.json");this.idLabel&&(l+="?label=1");this.throbber.show();g.val()||g.attr("placeholder",i18n.loading+"...");b.getJSONS3(l,function(p){try{h.data.id=a,c.separateNameFields||(h.data.full_name=g.val()),h._processReponse(p)}catch(u){h._reset(!0)}h.throbber.hide();g.removeAttr("placeholder")})},_processReponse:function(a){var c=this._fieldMap(),d=this.data,e;for(e in c){var f=
c[e]||e;a.hasOwnProperty(f)&&(d[e]=a[f])}this._serialize();this.previousSelection=b.extend({},this.data);this._updateInputs();this._disableInputs()},lookupIDLabel:function(){var a=this.idLabel;if(a){var c=a.val();if(c){var d=a.data("lookup");d&&(d.abort(),a.data("lookup",null));var e=this.options;d="";e.separateNameFields||(d="&name=1");var f=this,h=this.idLabelThrobber.show();c=S3.Ap.concat("/"+e.c+"/"+e.f+"/lookup.json?search=1&label=1"+d+"&~.pe_label="+c);d=b.getJSONS3(c,function(g){g.pe_label&&
(f.data.id=g.id,e.separateNameFields||(f.data.full_name=g.name),f._processReponse(g));a.data("lookup",null);h.hide()});a.data("lookup",d)}}},lookupContact:function(a){this._reset();var c=this.options,d=this.trigger,e=this;a=S3.Ap.concat("/org/site/"+a+"/site_contact_person");this.throbber.show();d.val()||d.attr("placeholder",i18n.loading+"...");b.getJSONS3(a,function(f){try{e.data.id=f.id;if(!c.separateNameFields){var h=f.name;d.val(h);e.data.full_name=h}e._processReponse(f)}catch(g){e._reset()}e.throbber.hide();
d.removeAttr("placeholder")})},_checkDuplicates:function(){var a=this.options,c=this._fieldMap(),d=this.selector,e=this.data,f={};if(!e.id){if(a.separateNameFields){if(!e.first_name)return;this.nameFields.forEach(function(l){(h=e[l])&&(f[c[l]||l]=h)})}else{var h=e.full_name;if(!h)return;f.name=h}this.personFields.forEach(function(l){(h=e[l])&&(f[c[l]||l]=h)});var g=S3.Ap.concat("/pr/person/check_duplicates");b.ajaxS3({url:g,data:f,type:"POST",dataType:"json",success:function(l){b(d+"_results").remove();
if(l.length){var p=i18n.dupes_found.replace("_NUM_",l.length)+' <i class="'+a.downIcon+'"> </i>';b(d+"_duplicates").html(p).data("results",l).show()}else b(d+"_duplicates").data("results",[]).hide()}})}},_displayDuplicates:function(){var a=this.options,c=this.selector;if(!b(c+"_results").length){var d=function(q,r){var t=b("<div>").addClass("card_1_line");r&&t.append(b("<label>").html(r));return t.append(q)},e=function(q,r){var t=b('<button type="button" class="fright">');r&&t.append(b('<i class="'+
r+'">'));return t.append(q)};c=b(c+"_duplicates");var f=c.data("results"),h=b('<div id="'+this.fieldName+'_results">'),g,l,p,u;f.forEach(function(q){l=q.name;g=b('<div class="dl-item">').data({id:q.id,name:l});p=b('<img width="50" height="50" class="media-object">');u=q.image?"/default/download/"+q.image:"/static/img/blank-user.gif";p.attr("src",S3.Ap.concat(u));g.append(b('<a class="fleft">').append(p));q.org&&g.append(d(q.org));g.append(d(l));q.father_name&&i18n.father_name_label&&g.append(d(q.father_name,
i18n.father_name_label));q.grandfather_name&&i18n.grandfather_name_label&&g.append(d(q.grandfather_name,i18n.grandfather_name_label));["year_of_birth","dob","email","phone"].forEach(function(r){(r=q[r])&&g.append(d(r))});g.append(e(i18n.Yes,a.yesIcon));h.append(g)});f=b('<div class="dl-item">').append(e(i18n.No,a.noIcon));h.append(f);c.after(h);b("html,body").animate({scrollTop:c.offset().top},250)}},_selectDuplicate:function(a,c){var d=this.selector,e=b(d+"_duplicates");a&&c?(b(d+"_full_name").val(c),
this._clearDuplicates(),e.data("submit")?(this.data={id:a},this._serialize(),e.closest("form").off(this.eventNamespace).submit()):(this.options.separateNameFields&&this.trigger.val(""),this._selectPerson(a))):(this._clearDuplicates(),e.data("submit")&&e.closest("form").off(this.eventNamespace).submit())},_clearDuplicates:function(){var a=this.selector;b(a+"_duplicates").data("results",[]).empty();b(a+"_results").remove()},_onFormSubmit:function(a){var c=this.selector;if(this.options.lookupDuplicates&&
(c=b(c+"_duplicates"),c.data("results").length))return c.data("submit",!0),this._displayDuplicates(),!1;if(this.edited){var d=this;c=this.data.id;this._readInputs();this.data.id=c;this.nameFields.forEach(function(e){delete d.data[e]})}else this.data.id?this.data={id:this.data.id}:this._readInputs();this._serialize();b(a).off(this.eventNamespace).submit();return!0},_bindEvents:function(){var a=b(this.element),c=this.options,d=this.selector,e=this.eventNamespace,f=this;a.closest("form").on("submit"+
e,function(g){g.preventDefault();return f._onFormSubmit(this)});b(d+"_edit_bar .edit-action").on("click"+e,function(){f._clearError();f._edit()});b(d+"_edit_bar .clear-action").on("click"+e,function(){f._clearError();f._clear()});b(d+"_edit_bar .undo-action").on("click"+e,function(){f._clearError();f._undo()});b(d+"_organisation_id").change(function(){f.acURL=m(f.acURL,{"~.organisation_id":b(this).val()})});b(d+"_title__row").next(".error_wrapper").one("click"+e,function(){f._clearError();return!1});
var h=this.nameFields.concat(this.personFields);b(h.map(function(g){return d+"_"+g}).join(",")).on("change"+e,function(){f.data.id||(f._readInputs(),f._serialize(),c.lookupDuplicates&&f._checkDuplicates())});c.lookupDuplicates&&(b(d+"_duplicates").data("results",[]).on("click"+e,function(){f._displayDuplicates()}),a.closest("form").on("click"+e,d+"_results .dl-item",function(){var g=b(this),l=g.data("id");g=g.data("name");f._selectDuplicate(l,g)}),a.on("change"+e,function(){a.val()&&f._clearDuplicates()}));
if(h=this.idLabel)h.on("input"+e,function(){var g=b(this),l=g.data("lookupTimeout");l&&clearTimeout(l);l=setTimeout(function(){f.lookupIDLabel()},c.delay);g.data("lookupTimeout",l)}),h.on("blur"+this.eventNamespace,function(){var g=b(this),l=g.data("lookup"),p=g.data("lookupTimeout");l&&(l.abort(),g.data("lookup",null),f.idLabelThrobber.hide());p&&clearTimeout(p)});return!0},_unbindEvents:function(){var a=b(this.element),c=this.selector,d=this.eventNamespace;a.off(d);a.closest("form").off(d);b(c+
"_edit_bar .edit-action").off(d);b(c+"_edit_bar .clear-action").off(d);b(c+"_edit_bar .undo-action").off(d);b(c+"_duplicates").off(d);a=this.nameFields.concat(this.personFields);b(a.map(function(e){return c+"_"+e}).join(",")).off(d);(a=this.idLabel)&&a.off(d);return!0}})})(jQuery);
