/*
 2024 (c) Sahana Software Foundation
 @license MIT
*/
(function(b,n){var p=0;b.widget("supply.registerDistribution",{options:{ajaxURL:"",tablename:"supply_distribution",showPicture:!0,showPictureLabel:"Show Picture",hidePictureLabel:"Hide Picture",selectDistributionSetLabel:"Select Distribution Set",noDistributionSetsLabel:"No distribution item sets available",noItemsLabel:"No items available",distributeLabel:"Distribution",returnLabel:"Return",itemLabel:"Item",quantityLabel:"Quantity",packLabel:"Pack",lossLabel:"Loss",loanLabel:"Loan"},_create:function(){this.id=
p;p+=1;this.eventNamespace=".registerDistribution"},_init:function(){const a=b(this.element),c=a.attr("id"),d="#"+this.options.tablename;this.idPrefix=d;this.orgHeader=b("#"+c+"-org-header");this.orgSelect=b("#"+c+"-org-select");this.distributionSetHeader=b("#"+c+"-event-type-header");this.distributionSetSelect=b("#"+c+"-event-type-select");this.pictureContainer=b("#"+c+"-picture");this.personRow=b(d+"_person__row",a);this.flagInfoRow=b(d+"_flaginfo__row",a);this.detailsRow=b(d+"_details__row",a);
this.personContainer=b(".controls",this.personRow);this.flagInfoContainer=b(".controls",this.flagInfoRow);this.detailsContainer=b(".controls",this.detailsRow);this.distributionSet=b('input[type="hidden"][name="distset"]',a);this.flagInfo=b("input[type=hidden][name=flags]",a);this.imageURL=b('input[type="hidden"][name="image"]',a);this.actionDetails=b('input[type="hidden"][name="actions"]',a);this.permissionInfo=b("input[type=hidden][name=permitted]",a);this.actionableInfo=b("input[type=hidden][name=actionable]",
a);this.submitLabel=b(".submit-btn",a).first().val();this.profilePicture=null;this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){const a=this.options;this._unbindEvents();if(!a.ajaxURL)throw Error("registerDistribution: no ajaxURL provided");this._clearForm();this._updateDistributionSet();this._bindEvents()},_checkID:function(){var a=this.orgHeader,c=b(this.element);const d=this.idPrefix;this._clearForm(!1,!0);var e=b(d+"_label"),g=e.val().trim();a=a.data("selected");
e.val(g);if(g){c=b('input[type=hidden][name="_formkey"]',c).val();e=this._getDistributionSet();g={a:"check",k:c,l:g,o:a,t:e?e.id:null};a=this.options.ajaxURL;var h=b('<div class="inline-throbber">').insertAfter(this.personContainer),l=this;b.ajaxS3({url:a,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(g),success:function(k){h.remove();k.a&&b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+k.a+"</div></div>").hide().insertAfter(b(d+
"_label").closest(".controls")).slideDown("fast");if(k.p){l._showPerson(k.p);k.b&&(l.imageURL.val(k.b),l.profilePicture=k.b,l._showProfilePicture());var f=l.flagInfo;k.f?f.val(JSON.stringify(k.f)):f.val("[]");f=l.permissionInfo;k.s!==n?f.val(JSON.stringify(k.s)):f.val("false");f=l.actionableInfo;var m=k.u;f.length&&(m!==n?f.val(JSON.stringify(m)):f.val(""),l._renderItemSelection());l._showFlagInfo()}k.e&&S3.showAlert(k.e,"error");k.w&&S3.showAlert(k.w,"warning");k.c&&S3.showAlert(k.c,"success")},
error:function(){h.remove();l._clearForm(!0,!1)}})}},_registerDistribution:function(){var a=this.orgHeader.data("selected");this._clearAlert();var c=b(this.element);let d=this.idPrefix;var e=b(d+"_label");let g=e.val().trim(),h=this.distributionSet.val();e.val(g);if(g&&h){a={a:"register",k:b('input[type=hidden][name="_formkey"]',c).val(),l:g,o:a,t:h};c=this.options.ajaxURL;e=b(d+"_person__row .controls");var l=b('<div class="inline-throbber">').insertAfter(e),k=this;e=this.actionDetails;e.length&&
(e=e.val(),a.d=e?JSON.parse(e):{});b.ajaxS3({url:c,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(a),success:function(f){l.remove();f.a?b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+f.a+"</div></div>").hide().insertAfter(b(d+"_label")).slideDown("fast"):k._clearForm();f.e?S3.showAlert(f.e,"error",!1):f.c&&S3.showAlert(f.c,"success",!1)},error:function(){l.remove();k._clearForm(!0)}})}},_showPerson:function(a){this.personRow.show();
this.personContainer.empty().html(a).removeClass("hide").show()},_removePerson:function(){this.personRow.hide();this.personContainer.empty()},_showFlagInfo:function(){this.flagInfoRow.hide();var a=this.flagInfo;let c=this.flagInfoContainer.empty().removeClass("has-flaginfo");a=a.length?JSON.parse(a.val()):[];if(a.length){this.flagInfoRow.removeClass("hide").show();c.addClass("has-flaginfo");let d=b('<div class="checkpoint-advise">').hide();a.forEach(function(e){let g=b('<div class="checkpoint-instructions">').appendTo(d);
b("<h4>"+e.n+"</h4>").appendTo(g);e.i&&b("<p>"+e.i+"</p>").appendTo(g)});d.appendTo(c).slideDown("fast")}},_removeFlagInfo:function(){this.flagInfoRow.hide();this.flagInfoContainer.empty();this.flagInfo.val("[]")},_showProfilePicture:function(){var a=b(this.element),c=this.options,d=this.profilePicture;this._removeProfilePicture();if(d){var e=b('<button class="small secondary button toggle-picture" type="button">'),g=b('<div class="button-row">').append(e);e.text(c.showPictureLabel);e=this.pictureContainer;
e.length||(this.pictureContainer=e=b('<div class="panel profile-picture">').appendTo(a));e.append(g).data("url",d);c.showPicture&&this._togglePicture()}},_removeProfilePicture:function(){this.imageURL.val("");this.profilePicture=null;this.pictureContainer.empty()},_togglePicture:function(){b(this.element);var a=this.options,c=this.pictureContainer;if(c.length){var d=c.find(".image-row"),e=c.data("url"),g=c.find("button.toggle-picture");d.length?(d.remove(),g.text(a.showPictureLabel)):e&&(d=b("<img>").attr("src",
e),d=b('<div class="image-row">').append(d),c.prepend(d),g.text(a.hidePictureLabel))}},_showItemSelection:function(){this.detailsContainer.removeClass("hide").show();this.detailsRow.removeClass("hide").show()},_hideItemSelection:function(){this.detailsRow.hide()},_removeItemSelection:function(){this.detailsRow.hide();this.detailsContainer.empty()},_renderItemSelection:function(){var a=this.options;this._removeItemSelection();var c=this.actionableInfo.val();if(c){var d=JSON.parse(c);c=d.distribute;
var e=d.return;d=b('<div class="distribution-details">');c.items&&c.items.length?this._renderItemTable(a.distributeLabel,"distribute",c.items).appendTo(d):c.msg&&this._renderItemTable(a.distributeLabel,"distribute",null,c.msg).appendTo(d);e&&e.length&&this._renderItemTable(a.returnLabel,"return",e).appendTo(d);d.children().length||(a=b('<span class="msg">').text(a.noItemsLabel),b('<div class="blocked">').append(a).appendTo(d));d.appendTo(this.detailsContainer);this._showItemSelection();this._toggleSubmit(!0)}},
_renderItemTable:function(a,c,d,e){let g=b('<table class="item-table">'),h=b("<thead>").appendTo(g),l=b("<tbody>").appendTo(g),k=b('<tr class="item-title">').appendTo(h);b('<th colspan="5">').text(a).appendTo(k);let f=this;d?(f._renderItemHeader(c).appendTo(h),d.forEach(function(m){f._renderItemRow(m,c).appendTo(l)})):e&&f._renderMessageRow(e).appendTo(l);return g},_renderItemHeader:function(a){const c=this.options;let d=b("<th>"),e=b('<tr class="item-header">').append(b("<th>")).append(b("<th>").text(c.itemLabel)).append(b("<th>").text(c.quantityLabel)).append(d).append(b("<th>").text(c.packLabel));
"return"==a&&d.text(c.lossLabel);return e},_renderItemRow:function(a,c){var d=this.options;let e=a.quantity-0;isNaN(e)&&(e=a.max-0||0);let g=b('<tr class="dist-item">').data({mode:a.mode||("return"==c?"RET":null),itemID:a.id,packID:a.pack_id,quantity:e,max:a.max,itemQ:e,lossQ:0});var h=b('<input type="checkbox" class="select-item">');b("<td>").append(h).appendTo(g);h=b("<div>").text(a.name);h=b("<td>").append(h).appendTo(g);"LOA"==a.mode&&b('<div class="dist-mode">').text(d.loanLabel).appendTo(h);
d=b('<input type="number" min="0" class="item-q">').val(e).prop("disabled",!0);b("<td>").append(d).appendTo(g);"return"==c?(c=b('<input type="number" min="0" class="loss-q" value="0">').prop("disabled",!0),b("<td>").append(c).appendTo(g)):b("<td>").appendTo(g);a=b("<div>").text(a.pack);b("<td>").append(a).appendTo(g);return g},_renderMessageRow:function(a){return b("<tr>").append(b('<td class="blocked-msg" colspan="5">').text(a))},_updateActionDetails:function(){var a=!1,c=[],d=[],e={d:c,r:d};b(".dist-item.selected",
this.detailsContainer).each(function(){let g=b(this),h=g.data();if(b(".invalidinput",g).length)a=!0;else if(h.itemQ||h.lossQ)"RET"==h.mode?d.push([h.itemID,h.packID,"RET",h.itemQ,h.lossQ]):c.push([h.itemID,h.packID,h.mode,h.itemQ])});a||!c.length&&!d.length?this.actionDetails.val(""):this.actionDetails.val(JSON.stringify(e))},_checkActionable:function(){return!!this.actionDetails.val()},_selectItem:function(a){a=b(a);const c=a.closest("tr.dist-item"),d=c.data("quantity");b(".error",c).remove();a.prop("checked")?
(b(".item-q, .loss-q",c).removeClass("invalidinput"),b(".item-q",c).val(d).prop("disabled",!1),b(".loss-q",c).val(0).prop("disabled",!1),c.addClass("selected").data({itemQ:d,lossQ:0})):(b(".item-q, .loss-q",c).removeClass("invalidinput").prop("disabled",!0),c.removeClass("selected").data({itemQ:0,lossQ:0}));this._updateActionDetails();this._toggleSubmit(!0)},_changeQuantity:function(a){var c=b(a);a=c.closest("tr.dist-item");c.removeClass("invalidinput");b(".error",a).remove();var d=c.val();if(d){d=
Math.abs(parseInt(d-0));c.val(d);var e=d,g=a.data("max"),h=!1;if(g){let l;l=c.hasClass("loss-q")?b(".item-q",a):b(".loss-q",a);l.length&&l.val()&&(e+=l.val()-0||0);e>g&&(e=0,d>g?(c.addClass("invalidinput"),c.after(b('<div class="error">').text("max "+g)),h=!0):l.length&&(e=g-d),l.length&&l.removeClass("invalidinput").val(e))}h?a.data({itemQ:0,lossQ:0}):(c=b(".item-q",a).val()-0||0,d=b(".loss-q",a).val()-0||0,a.data({itemQ:c,lossQ:d}));this._updateActionDetails();this._toggleSubmit(!0)}else c.removeClass("invalidinput").val("")},
_toggleSubmit:function(a){var c=b(this.element),d=[".check-btn",".submit-btn"],e=this.permissionInfo,g=!0;a&&(a=!1,e.length&&(e=e.val())&&(a=JSON.parse(e)),a&&(g=this._checkActionable()),d.reverse());e=c.find(d[0]);c.find(d[1]).prop("disabled",!0).hide().insertAfter(e);e.prop("disabled",!g).hide().removeClass("hide").show()},_clearAlert:function(){b(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast");b(".error_wrapper").fadeOut("fast").remove()},_clearForm:function(a,c){b(".inline-throbber").remove();
a||this._clearAlert();c||b(this.idPrefix+"_label").val("");this._removePerson();this._removeFlagInfo();this._removeItemSelection();this._removeProfilePicture();this.actionableInfo.val("");this.actionDetails.val("");b(".submit-btn").val(this.submitLabel);this._toggleSubmit(!1);a=b(this.idPrefix+"_label");a.trigger("focus").val(a.val())},_getDistributionSet:function(){const a=this.distributionSet.val();if(!a)return null;let c=b("a.event-type-select",this.distributionSetSelect).filter(function(){return b(this).data("id")==
a});return c.length?{id:c.data("id")||null,name:c.data("name")||null}:null},_setDistributionSet:function(a,c){this.distributionSet.val(a);b(".event-type-name",this.distributionSetHeader).text(c);this._updateDistributionSet();this._clearForm(!1,!0);this._checkID();b(this.idPrefix+"_person__row .controls").text()&&this._toggleSubmit(!0)},_clearDistributionSet:function(){this.distributionSet.val("");this._updateDistributionSet();this._toggleSubmit(!1)},_updateDistributionSet:function(){let a=this.distributionSetHeader,
c=b("a.event-type-select",this.distributionSetSelect).length,d=this.distributionSet.val();var e=this.options;d?a.removeClass("challenge"):(e=0<c?e.selectDistributionSetLabel:e.noDistributionSetsLabel,b(".event-type-name",a).text(e));0==c?a.addClass("empty").addClass("disabled"):1==c&&d?a.removeClass("empty").addClass("disabled"):(a.removeClass("empty").removeClass("disabled"),d||a.addClass("challenge"))},_populateDistributionSets:function(a){let c=this.distributionSetSelect.empty(),d=a.sets;(a=a.default)||
1!=d.length||(a=d[0]);d.forEach(function(e){let g=e[0];e=e[1];b('<a class="secondary button event-type-select">').text(e).appendTo(c).data({id:g,name:e})});a?this._setDistributionSet(a[0],a[1]):this._clearDistributionSet()},_selectOrg:function(a){let c=a.data("id");a=a.data("name");let d=this.orgHeader,e=this.orgSelect;this._clearForm();d.data("selected",c).addClass("selected");b("h4.org-name",d).text(a);let g=b('<div class="inline-throbber">'),h=this.distributionSetHeader.addClass("disabled"),l=
b(".event-type-name",h).hide().after(g),k=this;b.ajaxS3({url:this.options.ajaxURL+"?org="+c,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(f){k._populateDistributionSets(f);g.remove();l.show();1<f.sets.length&&h.removeClass("disabled")},error:function(){g.remove()}});e.slideUp("fast")},_selectDistributionSet:function(a){let c=a.data("id");a=a.data("name");this._setDistributionSet(c,a);this.distributionSetSelect.slideUp("fast")},_bindEvents:function(){const a=
b(this.element);var c=this.idPrefix;const d=this.eventNamespace,e=this;let g=this.orgHeader,h=this.orgSelect,l=this.distributionSetHeader,k=this.distributionSetSelect;g.on("click"+d,function(f){f.preventDefault();f.stopPropagation();if(g.hasClass("disabled"))return!1;k.slideUp("fast",function(){h.hasClass("hide")?h.hide().removeClass("hide").slideDown("fast"):h.slideToggle("fast")})});h.on("click"+d,"a.org-select",function(f){f.preventDefault();f.stopPropagation();e._selectOrg(b(this))});l.on("click"+
d,function(f){f.preventDefault();f.stopPropagation();if(l.hasClass("disabled"))return!1;h.slideUp("fast",function(){k.hasClass("hide")?k.hide().removeClass("hide").slideDown("fast"):k.slideToggle("fast")})});k.on("click"+d,"a.event-type-select",function(f){f.preventDefault();f.stopPropagation();e._selectDistributionSet(b(this))});this.pictureContainer.on("click"+d,".toggle-picture",function(f){f.preventDefault();e._togglePicture()});a.off(d).on("submit"+d,function(f){f.preventDefault();return!1});
a.find("a.cancel-action, .clear-btn").on("click"+d,function(f){f.preventDefault();e._clearForm()});b(".qrscan-btn",a).on("click"+d,function(f){e._clearForm()});a.find(".check-btn").on("click"+d,function(f){f.preventDefault();e._checkID()});a.find(".submit-btn").off(d).on("click"+d,function(f){f.preventDefault();e._registerDistribution()});c=b(c+"_label");c.on("input"+d,function(f){e._clearForm(!1,!0)});b(a).on("change"+d,".select-item",function(){e._selectItem(this)});b(a).on("input"+d,".item-q, .loss-q",
function(){e._changeQuantity(this)});c.on("keyup"+d,function(f){f.preventDefault();f.stopPropagation();switch(f.which){case 13:e._checkID();break;case 27:e._clearForm()}});return!0},_unbindEvents:function(){const a=b(this.element),c=this.eventNamespace,d=this.idPrefix;this.orgHeader.off(c);this.orgSelect.off(c);this.distributionSetHeader.off(c);this.distributionSetSelect.off(c);b(d+"_label").off(c);a.find("a.cancel-action").off(c);a.find(".check-btn").off(c);a.find(".submit-btn").off(c);a.off(c);
return!0}})})(jQuery);
