/*
 2021-2023 (c) Sahana Software Foundation
 @license MIT
*/
(function(c,l){var k=0;c.widget("s3.registerPresence",{options:{tableName:"site_presence",ajaxURL:"",noPictureAvailable:"No picture available",statusIn:"present",statusOut:"not present",statusNone:"-",statusLabel:"Status",sendOriginalQRInput:!0},_create:function(){c(this.element);this.id=k;k+=1;this.eventNamespace=".registerPresence"},_init:function(){this.idPrefix="#"+this.options.tableName;this.personData=c(this.element).find("input[type=hidden][name=data]");this.labelInput=c(this.idPrefix+"_label");
this.hiddenInput=this.labelInput.siblings(".qrinput-hidden");this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var a=this.personData.val();a&&"null"!=a?this._showPersonData(JSON.parse(a)):this._clearForm();this._bindEvents()},_getLabel:function(){var a=this.labelInput;let b=this.hiddenInput,d=this.options,e=a.val().trim();a.val(e);d.sendOriginalQRInput&&(a=b.val())&&(e=a);return e},_checkID:function(){var a=this.idPrefix,b=this._getLabel();
if(b){this._clearForm(!1,!0);a=c(a+"_person__row .controls").empty();var d=c('<div class="inline-throbber">').insertAfter(a);c("#submit_record__row").find(".button").prop("disabled",!0);var e=this;a=this.options.ajaxURL;b={m:"STATUS",l:b,k:this._formkey()};c.ajaxS3({url:a,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(b),success:function(f){d.remove();c("#submit_record__row").find(".button").prop("disabled",!1);f.e?e._showInputError(f.e):(f.q&&e._showInputError(f.q),
e._showPersonData(f),(f=f.m)&&S3.showAlert(f[0],f[1]))},error:function(){d.remove();c("#submit_record__row").find(".button").prop("disabled",!1);e._clearForm(!0,!1)}})}},_register:function(a){var b=this.idPrefix,d=this._getLabel();if(d){this._clearAlert();b=c(b+"_person__row .controls");var e=c('<div class="inline-throbber">').insertAfter(b);c("#submit_record__row").find(".button").prop("disabled",!0);var f=!!c.trim(b.html()).length,h=this;b=this.options.ajaxURL;a={m:a,l:d,k:this._formkey()};c.ajaxS3({url:b,
type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(a),success:function(g){e.remove();c("#submit_record__row").find(".button").prop("disabled",!1);g.e?h._showInputError(g.e):(g.a&&!f?h._showPersonData(g):h._clearForm(),(g=g.m)&&S3.showAlert(g[0],g[1]))},error:function(){e.remove();c("#submit_record__row").find(".button").prop("disabled",!1);h._clearForm(!0,!1)}})}},_showPersonData:function(a){var b=this.idPrefix,d=c(b+"_person__row .controls"),e=c(b+"_status__row .controls");
b=c(b+"_info__row .controls");d.html(a.d).removeClass("hide").show();this._showProfilePicture(a.p);d=this._statusMsg(a.s);e.append(d).removeClass("hide").show();a.i?1==a.s&&this._toggleAction("check-in-btn","off"):this._toggleAction("check-in-btn","deny");a.o?2==a.s&&this._toggleAction("check-out-btn","off"):this._toggleAction("check-out-btn","deny");a.a&&b.html(a.a).removeClass("hide").show()},_showInputError:function(a){let b=this.labelInput;a=c('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+
a+"</div></div>").hide();let d=b.closest(".controls");d.length?a.appendTo(d).slideDown():a.insertAfter(b).slideDown()},_statusMsg:function(a){var b=this.options,d=c('<div class="check-in-status">');c('<span class="status-label">'+b.statusLabel+": </span>").appendTo(d);var e=c('<span class="status-message">').appendTo(d);switch(a){case "IN":e.html(b.statusIn);break;case "OUT":e.html(b.statusOut);break;default:e.html(b.statusNone)}return d},_clearForm:function(a,b){var d=this.idPrefix;c(".inline-throbber").remove();
a||this._clearAlert();b||(this.hiddenInput.val(""),this.labelInput.val("").trigger("focus"));c(d+"_person__row .controls").hide().empty();c(d+"_status__row .controls").hide().empty();c(d+"_info__row .controls").hide().empty();this._hideProfilePicture();this._toggleAction("check-in-btn","on");this._toggleAction("check-out-btn","on")},_clearAlert:function(){c(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast").remove();c(".error_wrapper").fadeOut("fast").remove()},_showProfilePicture:function(a){var b=
c("#profile-picture").empty();b=c('<div class="panel">').hide().appendTo(b);a=a?c("<img>").attr("src",a):c("<p>").text(this.options.noPictureAvailable);b.append(a).show()},_hideProfilePicture:function(){c("#profile-picture").empty()},_toggleAction:function(a,b){var d=c("button."+a),e=d.text();if(d.length)switch(d.siblings(".disabled-"+a).remove(),b){case "off":d.prop("disabled",!0).show();break;case "deny":a=c('<button class="small alert button disabled-'+a+'" disabled="disabled"><i class="fa fa-ban"></i>'+
e+"</button>");d.prop("disabled",!0).hide().after(a);break;default:d.prop("disabled",!1).show()}},_formkey:function(){var a=c('input[name="formkey"]',c(this.element)),b=null;a.length&&(b=a.first().val());return b},_bindEvents:function(){var a=this,b=c(this.element),d=this.eventNamespace;b.find(".check-btn").on("click"+d,function(e){e.preventDefault();a._checkID()});b.find(".check-in-btn").off(d).on("click"+d,function(e){e.preventDefault();a._register("IN")});b.find(".check-out-btn").off(d).on("click"+
d,function(e){e.preventDefault();a._register("OUT")});b.find("a.cancel-action, .clear-btn").on("click"+d,function(e){e.preventDefault();a._clearForm()});c(".qrscan-btn",b).on("click"+d,function(e){a._clearForm()});b=this.labelInput;b.on("input"+d,function(e){a._clearForm(!1,!0)});b.on("keypress"+d,function(e){if(13==e.which)return e.preventDefault(),!1});b.on("keyup"+d,function(e){e.preventDefault();switch(e.which){case 27:a._clearForm();break;case 13:a._checkID()}});return!0},_unbindEvents:function(){var a=
c(this.element),b=this.eventNamespace;c(this.idPrefix+"_label").off(b);a.find(".check-btn").off(b);a.find(".check-in-btn").off(b);a.find(".check-out-btn").off(b);a.find("a.cancel-action, .clear-btn").off(b);return!0}})})(jQuery);
