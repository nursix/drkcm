/*
 2015-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
(function(d,I){var J=0,k={},q={},p={};d.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=J;J+=1;this.eventNamespace=".locationselector"},_init:function(){var b=d(this.element),a=this.options,c=b.attr("id");if(!c)throw"Location selector widget: real input field without id";this.fieldname=c;this.input=b;this.data=null;this._storeHierarchyData(a.labels,
a.locations);this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var b=this._deserialize();this._renderWidget();var a="#"+this.fieldname,c=this.options;d(a+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var e=d(a+"_postcode").data("k");this.postcodeToAddress=e?e:!1;e=d(a+"_L0__row");if(e.length){var h=[];for(m in k){var f=k[m];0===f.l&&(f.i=m,h.push(f))}h.sort(function(v,w){return v.n.localeCompare(w.n)});for(var g=
d(a+"_L0"),l=0,n=h.length;l<n;l++){f=h[l];var m=f.i;m='<option value="'+m+'">'+f.n+"</option>";g.append(m)}this.postcodeToAddress||(e.removeClass("hide").show(),e=d(a+"_L0__row1"),e.length&&e.removeClass("hide").show())}var t;this.postcodeToAddress&&!b.address&&(t=!0);var u=this;e=b.L0;h=b.L1;m=b.L2;g=b.L3;l=b.L4;n=b.L5;var r;[e,h||m,m||g,g||l,l||n,n].forEach(function(v,w){v&&(r=r?r.then(function(){return u.lxSelect(w,v,!0,t)}):u.lxSelect(w,v,!0,t))});this.lx=[e,h,m,g,l,n].join("|");e=b.address;d(a+
"_address").val(e);e?(d(a+"_address__row").removeClass("hide").show(),d(a+"_address__row1").removeClass("hide").show()):this.postcodeToAddress||(d(a+"_address__row").removeClass("hide").show(),d(a+"_address__row1").removeClass("hide").show());d(a+"_postcode").val(b.postcode);d(a+"_postcode__row").removeClass("hide").show();d(a+"_postcode__row1").removeClass("hide").show();this.postcodeToAddress&&(d(a+"_postcode_to_address__row").removeClass("hide").show(),d(a+"_postcode_to_address__row1").removeClass("hide").show());
d(a+"_lat").val(b.lat).latloninput({type:"lat",mode:c.latlonMode});d(a+"_lat__row").removeClass("hide").show();d(a+"_lat__row1").removeClass("hide").show();d(a+"_lon").val(b.lon).latloninput({type:"lon",mode:c.latlonMode});d(a+"_lon__row").removeClass("hide").show();d(a+"_lon__row1").removeClass("hide").show();e=d(a+"_map_icon__row").removeClass("hide").show();b.lat||b.lon||b.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):c.featureRequired?this._showMap():c.openMapOnLoad&&e.is(":visible")&&
"#sub_"!=a.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var b=this.fieldname,a="#"+b,c=this.options.reverseLx,e=d(a+"_map_icon__row .map_wrapper");e.attr("id",this.fieldname+"_map_wrapper");var h=d(a+"__row"),f=this.input.next(".error_wrapper").addClass("error_top"),g=d(a+"_map_icon__row"),l=d(a+"_L0__row"),n=d(a+"_postcode__row");if(h.is(".control-group, .form-row")){b=
d(a+"_L1__row");var m=d(a+"_L2__row"),t=d(a+"_L3__row"),u=d(a+"_L4__row"),r=d(a+"_L5__row"),v=d(a+"_address__row"),w=d(a+"_postcode_to_address__row"),y=d(a+"_lat__row"),x=d(a+"_lon__row");a=d(a+"_latlon_toggle__row");c?h.hide().after(e).after(g).after(a).after(x).after(y).after(l).after(b).after(m).after(t).after(u).after(r).after(w).after(n).after(v).after(f):h.hide().after(e).after(g).after(a).after(x).after(y).after(w).after(n).after(v).after(r).after(u).after(t).after(m).after(b).after(l).after(f)}else h.parent().is(".inline-form")?
h.show():(d(a+"__row1").hide(),h.hide().after(f),g.detach(),h.siblings('[id^="'+b+'"][id$="__row"]').last().after(e).after(g));if(f.length)f.one("click"+this.eventNamespace,function(){var z=d(this);z.fadeOut("slow",function(){z.remove()})})},_lxSelectFinal:function(b){b?this._serialize():this._collectData();this._zoomMap()},lxSelect:function(b,a,c,e){var h=d.Deferred(),f=this,g="#"+f.fieldname,l=f.options,n=d(g+"_L"+b),m;a?(n.val(a).trigger("change","implicit"),n.hasClass("multiselect")&&n.multiselect("instance")&&
n.multiselect("refresh")):a=parseInt(n.val(),10);if(0===b){var t=f._readLabels(a),u=q.d,r=["1","2","3","4","5"],v,w,y;t.then(function(K){for(y=0;5>y;y++)m=r[y],v=K[m]||u[m],x=g+"_L"+m,n=d(x),w=l.showLabels?n.hasClass("required")?"<div>"+v+':<span class="req"> *</span></div>':v+":":"",d(x+"__row label").html(w),d(x+"__row1 label").html(w),d(x+' option[value=""]').html(i18n.select+" "+v),n.hasClass("multiselect")&&n.multiselect("instance")&&n.multiselect("refresh")})}t=l.hideLx;for(m=b+1;6>m;m++){var x=
g+"_L"+m;t?(d(x+"__row").hide(),d(x+"__row1").hide()):d(x+" option").remove('[value != ""]');d(x).val("").trigger("change","implicit")}if(a){var z=!1,A=b+1,E=d(g+"_L"+A+"__row");E.length||(z=!0,A++,E=d(g+"_L"+A+"__row"));if(E.length){var B;t=!1;if(d(g+"_L"+b+' option[value="'+a+'"]').hasClass("missing")){var C=k[a];C.i=a;var F=[C]}else for(B in F=[],t=!0,k)if(k[B].f==a){t=!1;break}f._readHierarchy(t,a,A,z).then(function(){if(0==F.length)for(B in k)C=k[B],C.f==a&&(C.i=B,F.push(C));var K=F.length;if(K){F.sort(function(L,
M){return L.n.localeCompare(M.n)});var G=g+"_L"+A;var D=d(G),H=d(G+' option[value=""]').html();d(G+" option").remove('[value != ""]');B=null;for(y=0;y<K;y++)C=F[y],B=C.i,G=a==B?' selected="selected"':"",z=C.l==A?"":' class="missing"',G='<option value="'+B+'"'+G+z+">"+C.n+"</option>",D.append(G);e||(E.removeClass("hide").show(),d(g+"_L"+A+"__row1").removeClass("hide").show());D.hasClass("multiselect")&&(H={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:H,multiple:!1},D.hasClass("search")?
(D.multiselect(H).multiselectfilter({label:"",placeholder:i18n.search}),d(".ui-multiselect-header").show()):(H.header=!1,D.multiselect(H)));D=f.data["L"+A];H=F.map(function(L){return L.i});D&&-1!=H.indexOf(""+D)?f.lxSelect(A,D,c):1==K&&B&&f.lxSelect(A,B,c)}f._lxSelectFinal(c);h.resolve()})}else f.useGeocoder&&!c&&f._geocodeDecision(),f._lxSelectFinal(c),h.resolve()}else f._lxSelectFinal(c),h.resolve();return h.promise()},_collectData:function(b){var a=this.data,c="#"+this.fieldname,e=this._lookupParent(),
h=d(c+"_address").val(),f=d(c+"_postcode").val();a.address=h;a.postcode=f;if(a.specific)a.id=a.specific,a.parent=e;else{var g=a.lat,l=a.lon,n=a.wkt;h||f||g||l||n?(a.id=null,a.parent=e):(a.id=e,a.parent=null)}this._serialize();d(c+"_lat").val(a.lat).trigger("setvalue");d(c+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.trigger("change",b&&"user"||"implicit")},_collectLx:function(){var b=this.data,a="#"+this.fieldname,c;
for(c=0;6>c;c++){var e=d(a+"_L"+c);e.length&&(e=e.val(),b["L"+c]=e?parseInt(e,10):null)}this._serialize()},_hasData:function(){var b=this.data,a=!1;b.specific||b.address||b.postcode||b.lat||b.lon||b.wkt?a=!0:[b.L0,b.L1,b.L2,b.L3,b.L4,b.L5].join("|")!=this.lx&&(a=!0);return a},_lookupParent:function(){this._collectLx();for(var b=this.data,a,c=5;-1<c;c--)if(a=b["L"+c])return a;return(b=k.d)?b.i:null},_readLabels:function(b){b||="d";var a=d.Deferred(),c=q[b];if(c==I){var e=S3.Ap.concat("/gis/hdata/"+
b);d.ajaxS3({url:e,dataType:"json",success:function(h){c={};try{for(var f in h)c[f]=h[f];q[b]=c}catch(g){}a.resolve(c)},error:function(h,f,g){(h="UNAUTHORIZED"==g?i18n.gis_requires_login:h.responseText)&&s3_debug(h);a.reject()}})}else a.resolve(c);return a.promise()},_readHierarchy:function(b,a,c,e){var h=""+a+";"+c+";"+e,f=p[h];if(f!==I)return f;var g=d.Deferred();if(b){b="#"+this.fieldname;var l=d(b+"_L"+c),n=!1;l.hide();if(l.hasClass("multiselect")){n=!0;var m=d(b+"_L"+c+"__row button").hide()}var t=
d(b+"_L"+c+"__throbber").removeClass("hide").show();a=e?S3.Ap.concat("/gis/ldata/"+a+"/"+c):S3.Ap.concat("/gis/ldata/"+a);d.ajaxS3({url:a,dataType:"json",success:function(u){for(var r in u)k[r]=u[r];t.hide();n?m.removeClass("hide").show():l.removeClass("hide").show();g.resolve()},error:function(u,r,v){if(u="UNAUTHORIZED"==v?i18n.gis_requires_login:u.responseText)s3_debug(u),S3.showAlert(u,"error");t.hide();n?m.removeClass("hide").show():l.removeClass("hide").show();g.reject()}})}else g.resolve();
return f=p[h]=g.promise()},_geocodeDecision:function(){var b="#"+this.fieldname,a=this.data;this._collectData();if(S3.gis.geocodeDecisionPlugin)S3.gis.geocodeDecisionPlugin(b,a,this);else if(a.address){a=["1","2","3","4","5"];for(var c=0,e;5>c;c++)if(e=d(b+"_L"+a[c]),e.length&&!e.val()&&1<e[0].options.length)return;d(b+"_geocode .geocode_success,"+b+"_geocode .geocode_fail").hide();var h=this;a=this.eventNamespace;this.input.data("manually_geocoded")?d(b+"_geocode button").removeClass("hide").show().unbind(a).bind("click"+
a,function(){d(this).hide();h._geocode()}):this._geocode()}},_geocode:function(){for(var b=this.fieldname,a=this,c="#"+b,e=d(c+"_geocode .geocode_fail").hide(),h=d(c+"_geocode .geocode_success").hide(),f=d(c+"_geocode .throbber").removeClass("hide").show(),g=this.data,l={address:g.address},n="postcode L0 L1 L2 L3 L4 L5".split(" "),m=0,t,u;7>m;m++)t=n[m],(u=g[t])&&(l[t]=u);l.k=d(c+"_geocode button").data("k");c=S3.Ap.concat("/gis/geocode");d.ajaxS3({url:c,type:"POST",data:l,dataType:"json",success:function(r){var v=
r.lat,w=r.lon;if(v||w){g.lat=parseFloat(v);g.lon=parseFloat(w);a._collectData();v=S3.gis;if(v.maps&&(w=v.maps["location_selector_"+b])){r=w.s3.draftLayer;r.removeAllFeatures();var y=new OpenLayers.Geometry.Point(g.lon,g.lat);y.transform(v.proj4326,w.getProjectionObject());v=new OpenLayers.Feature.Vector(y);r.addFeatures([v]);a._zoomMap()}f.hide();h.html(i18n.address_mapped).removeClass("hide").show()}else f.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(r)},error:function(r,
v,w){r="UNAUTHORIZED"==w?i18n.gis_requires_login:r.responseText;f.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(r)}})},_geocodeReverse:function(){var b=this,a="#"+this.fieldname,c=d(a+"_geocode .geocode_fail").hide(),e=d(a+"_geocode .geocode_success").hide(),h=d(a+"_geocode .throbber").removeClass("hide").show(),f=this.data;f={lat:f.lat,lon:f.lon};f.k=d(a+"_geocode button").data("k");a=S3.Ap.concat("/gis/geocode_r");d.ajaxS3({async:!1,url:a,type:"POST",data:f,dataType:"json",
success:function(g){var l=g.L0,n=g.L1,m=g.L2,t=g.L3,u=g.L4;g=g.L5;if(l){b.useGeocoder=!1;var r;[l,n||m,m||t,t||u,u||g,g].forEach(function(v,w){v&&(r=r?r.then(function(){return b.lxSelect(w,v)}):b.lxSelect(w,v))});b.useGeocoder=!0;h.hide();e.html(i18n.location_found).removeClass("hide").show()}else h.hide(),c.html(i18n.location_not_found).removeClass("hide").show()},error:function(g,l,n){g="UNAUTHORIZED"==n?i18n.gis_requires_login:g.responseText;h.hide();c.html(i18n.location_not_found).removeClass("hide").show();
s3_debug(g)}})},_latlonInput:function(){var b=this.fieldname,a=this.data,c="#"+b,e=d(c+"_lat").val();c=d(c+"_lon").val();e||c?(e=e?parseFloat(e):0,c=c?parseFloat(c):0,a.lat=e,a.lon=c,a.wkt=null,this.input.data("manually_geocoded",!0)):(a.lat=null,a.lon=null,a.wkt||this.input.data("manually_geocoded",!1));this._serialize();e=S3.gis;e.maps&&(b=e.maps["location_selector_"+b])&&(c=b.s3.draftLayer,c.removeAllFeatures(),null!==a.lat&&null!==a.lon&&(a=new OpenLayers.Geometry.Point(a.lon,a.lat),a.transform(e.proj4326,
b.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),c.addFeatures([a]),b.s3.lastDraftFeature=a),this._zoomMap())},_postcodeToAddress:function(){this._collectData();var b=this.fieldname,a=this,c="#"+b,e=this.data,h=e.postcode;if(h){d(c+"_address_menu").remove();var f=d(c+"_postcode__row .geocode_fail").hide(),g=d(c+"_postcode__row .throbber").removeClass("hide").show();f.length||(d(c+"_postcode__row .columns").append('<div class="geocode_fail hide"></div>'),f=d(c+"_postcode__row .geocode_fail"));
g.length||(d(c+"_postcode__row .columns").append('<div class="throbber"></div>'),g=d(c+"_postcode__row .throbber"));d.ajaxS3({url:S3.Ap.concat("/gis/postcode_to_address"),type:"POST",data:{postcode:h,k:a.postcodeToAddress},dataType:"json",success:function(l){var n=l.addresses;if(n&&n.length){g.hide();for(var m='<ul id="'+b+'_address_menu">',t=0;t<n.length;t++)m+="<li><div>"+n[t]+"</div></li>";m+="</ul>";d(c+"_postcode").after(m);d(c+"_address_menu").menu({select:function(u,r){e.address=r.item[0].innerText;
d(c+"_address").val(e.address);e.lat=parseFloat(l.lat);e.lon=parseFloat(l.lon);a._collectData();d(c+"_address__row").removeClass("hide").show();d(c+"_address__row1").removeClass("hide").show();d(c+"_address_menu").menu("destroy").remove();r=S3.gis;if(r.maps){var v=r.maps["location_selector_"+b];if(v){u=v.s3.draftLayer;u.removeAllFeatures();var w=new OpenLayers.Geometry.Point(e.lon,e.lat);w.transform(r.proj4326,v.getProjectionObject());r=new OpenLayers.Feature.Vector(w);u.addFeatures([r]);a._zoomMap()}}u=
l.L0;r=l.L1;v=l.L2;w=l.L3;var y=l.L4,x=l.L5;if(u){d(c+"_L0__row").removeClass("hide").show();d(c+"_L0__row1").removeClass("hide").show();var z;[u,r||v,v||w,w||y,y||x,x].forEach(function(A,E){A&&(z=z?z.then(function(){return a.lxSelect(E,A,!0)}):a.lxSelect(E,A,!0))})}}})}else g.hide(),f.html(i18n.no_addresses_found).removeClass("hide").show(),s3_debug(l)},error:function(l,n,m){l="UNAUTHORIZED"==m?i18n.gis_requires_login:l.responseText;g.hide();f.html(l).removeClass("hide").show();s3_debug(l)}})}},
_showMap:function(b){var a=this.fieldname,c=this.eventNamespace,e=this,h="#"+a;d(h+"_map_icon").unbind(c).bind("click"+c,function(){e._hideMap()});d(h+"_map_icon span").html(i18n.hide_map);c=d(h+"_map_wrapper").hide().removeClass("hide").slideDown("medium");c.length&&b&&d("html,body").animate({scrollTop:c.offset().top},250);var f=this.input;d.when(this._jsLoaded()).then(function(){var g=S3.gis,l="location_selector_"+a;var n=g.maps[l]?g.maps[l]:g.show_map(l);e._zoomMap();var m=e.data;l=m.lat;var t=
m.lon,u=m.wkt;if(l||t||u)n.s3.draftLayer.removeAllFeatures(),u!=I&&u?(l={internalProjection:n.getProjectionObject(),externalProjection:g.proj4326},l=(new OpenLayers.Format.WKT(l)).read(u)):(l=new OpenLayers.Geometry.Point(parseFloat(t),parseFloat(l)),l.transform(g.proj4326,n.getProjectionObject()),l=new OpenLayers.Feature.Vector(l)),n.s3.draftLayer.addFeatures([l]),n.s3.lastDraftFeature=l;l=n.controls;t=0;for(var r=l.length;t<r;t++)if("OpenLayers.Control.DrawFeature"==l[t].CLASS_NAME){var v=l[t];
break}v&&(n.s3.pointPlaced=function(w){d(h+"_geocode .geocode_fail").hide();d(h+"_geocode .geocode_success").hide();var y=w.geometry;if("OpenLayers.Geometry.Point"==y.CLASS_NAME)w=y.getBounds().getCenterLonLat(),w.transform(n.getProjectionObject(),g.proj4326),m.wkt=null,m.lat=w.lat,m.lon=w.lon,!m.address&&e.useGeocoder&&e._geocodeReverse();else{y={internalProjection:n.getProjectionObject(),externalProjection:g.proj4326};m.radius=null;var x=new OpenLayers.Geometry.LinearRing(w.geometry.components[0].components);
x=new OpenLayers.Geometry.Polygon([x]);if(1E3==x.getVertices().length){var z=(new OpenLayers.Feature.Vector(x,null)).geometry.getBounds();x=z.right;var A=(z.bottom+z.top)/2;z=new OpenLayers.Geometry.Point((z.left+x)/2,A);x=new OpenLayers.Geometry.Point(x,A);x=new OpenLayers.Geometry.LineString([z,x]);x=parseFloat(x.getLength());m.radius=x}u=(new OpenLayers.Format.WKT(y)).write(w);m.wkt=u;m.lat=null;m.lon=null}f.data("manually_geocoded",!0);e._collectData(!0);e._removeErrors();"sub_"==a.substring(0,
4)&&f.parent().find("div.map_wrapper").trigger("change")})},function(g){s3_debug(g)},function(g){s3_debug(g)})},_hideMap:function(){var b=this.fieldname,a=this.eventNamespace,c="#"+b,e=this;d(c+"_map_icon").unbind(a).bind("click"+a,function(f){e._showMap(f)});d(c+"_map_wrapper").slideUp("medium");a=this.data;if(a.specific)var h=i18n.show_map_view;else if(h=i18n.show_map_add,S3.gis.maps&&(b=S3.gis.maps["location_selector_"+b]))b.s3.draftLayer.removeAllFeatures(),a.lat=null,a.lon=null,a.wkt=null,this.input.data("manually_geocoded",
!1),this._collectData();d(c+"_map_icon span").html(h)},_zoomMap:function(b){var a=this.fieldname,c=S3.gis;if(c.maps&&(a=c.maps["location_selector_"+a])){var e=this.data;c=e.lat;var h=e.lon;e=e.wkt;if(c&&h)c=OpenLayers.Bounds.fromArray([h,c,h,c]);else if(e)c=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(e))).geometry.getBounds();else{b||=this._lookupParent()||"d";c=k[b].b;if(!c||!c.length)for(h=k[b].f,b=4;h&&b&&(b--,h=k[h],!(c=h.b)&&0!==h.l);)h=h.f;c&&=OpenLayers.Bounds.fromArray(c)}c&&
S3.gis.zoomBounds(a,c,this.options.minBBOX)}},_validate:function(){var b=this.fieldname;this._removeErrors();var a="#"+b,c=this.data;if(b=this.options.featureRequired){var e=!1;switch(b){case "latlon":e=c.lat||c.lon;break;case "wkt":e=c.wkt;break;default:e=c.lat||c.lon||c.wkt}if(!e)return this._fieldError(d(a+"_map_icon"),i18n.map_feature_required),!1}var h=function(m){return m.hasClass("multiselect")?m.next("button.ui-multiselect").is(":visible"):m.is(":visible")},f=!1;b="L5 L4 L3 L2 L1 L0".split(" ");
for(e=0;6>e;e++){var g=b[e];var l=a+"_"+g;var n=d(l);if(n.length&&n.hasClass("required")&&h(n)&&!c[g]){this._fieldError(n,i18n.enter_value);f=!0;break}}["address","postcode"].forEach(function(m){l=a+"_"+m;n=d(l);n.length&&n.hasClass("required")&&h(n)&&!c[m]&&(this._fieldError(n,i18n.enter_value),f=!0)},this);return!f},_serialize:function(){var b=JSON.stringify(this.data);this.input.val(b);return b},_deserialize:function(){var b=this.input.val();return this.data=JSON.parse(b)},_storeHierarchyData:function(b,
a){var c;if(a)for(c in a)k[c]=a[c];if(b)for(c in b)q[c]=b[c]},_jsLoaded:function(){var b=new jQuery.Deferred;setTimeout(function c(){S3.gis.maps!=I?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(c,500))},1);return b.promise()},_fieldError:function(b,a){b.addClass("invalidinput").after('<div class="error" style="display: block;">'+a+"</div>");d(".invalidinput").get(0).scrollIntoView()},_removeErrors:function(b){b||(b="#"+this.fieldname,b=b+"_L0,"+b+"_L1,"+
b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon");d(b).removeClass("invalidinput").siblings(".error").remove()},_bindEvents:function(){var b=this.fieldname,a=this.eventNamespace,c=this,e="#"+b;d(e+"_L0").bind("change"+a,function(){c._removeErrors(this);c.lxSelect(0)});d(e+"_L1").bind("change"+a,function(){c._removeErrors(this);c.lxSelect(1)});d(e+"_L2").bind("change"+a,function(){c._removeErrors(this);c.lxSelect(2)});d(e+"_L3").bind("change"+a,function(){c._removeErrors(this);
c.lxSelect(3)});d(e+"_L4").bind("change"+a,function(){c._removeErrors(this);c.lxSelect(4)});d(e+"_L5").bind("change"+a,function(){c._removeErrors(this);c.lxSelect(5)});d(e+"_address").bind("change"+a,function(){c._removeErrors(this);c.useGeocoder?c._geocodeDecision():c._collectData()});d(e+"_postcode").bind("change"+a,function(){c._removeErrors(this);c.useGeocoder?c._geocodeDecision():c.postcodeToAddress?c._postcodeToAddress():c._collectData()});d(e+"_postcode_to_address").bind("click"+a,function(){d(e+
"_address__row").removeClass("hide").show();d(e+"_address__row1").removeClass("hide").show();d(e+"_L0__row").removeClass("hide").show();d(e+"_L0__row1").removeClass("hide").show();var f=c.data,g=f.L2,l=f.L3,n=f.L4,m=f.L5,t;[f.L0,f.L1||g,g||l,l||n,n||m,m].forEach(function(u,r){u&&(t=t?t.then(function(){return c.lxSelect(r,u,!0)}):c.lxSelect(r,u,!0))});d(this).hide()});d(e+"_lat,"+e+"_lon").bind("change"+a,function(){c._latlonInput()});d(e+"_latlon_toggle").bind("click"+a,function(){var f=d(this).data("mode")||
c.options.latlonMode;if("dms"==f){f="decimal";var g=i18n.latlon_mode.dms}else f="dms",g=i18n.latlon_mode.decimal;d(e+"_lat").latloninput("option",{mode:f});d(e+"_lon").latloninput("option",{mode:f});d(this).html(g).data("mode",f)});if("sub_"==b.substring(0,4))this.input.closest(".inline-form").bind("validate"+a+this.id,function(f){c._validate()||f.preventDefault()});else{var h=this.input.closest("form");h.bind("submit"+a+this.id,function(f){f.preventDefault();c._validate()&&h.unbind(a+c.id).submit()})}return!0},
_unbindEvents:function(){var b="#"+this.fieldname,a=this.eventNamespace;d(b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_postcode_to_address,"+b+"_map_icon,"+b+"_latlon_toggle").unbind(a);this.input.next(".error_wrapper").unbind(a);this.input.closest("form").unbind(a+this.id);return!0}})})(jQuery);
(function(d,I){var J=0;d.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=J;J+=1;this.eventNamespace=".latloninput"},_init:function(){d(this.element).hide();this.refresh()},_destroy:function(){d(this.element).show();d.Widget.prototype.destroy.call(this)},_setOption:function(k,q){this._super(k,q);"mode"==k&&this.refresh()},refresh:function(){this._unbindEvents();var k=d(this.element),q=this.options;this.defaultValue=k.val();
if(!this.input){var p=d("<div>").hide().insertAfter(k),b=d('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=b;var a=q.labels,c=d('<input type="text" class="integer dms-input" size="5">'),e=d('<span class="dms-label">'+a.deg+"</span>"),h=d('<input type="text" class="integer dms-input" size="5">'),f=d('<span class="dms-label">'+a.min+"</span>"),g=d('<input type="text" class="double dms-input" size="8">');a=d('<span class="dms-label">'+a.sec+"</span>");this.degInput=c;this.minInput=
h;this.secInput=g;this.dmsInput=c=d("<span>").append(c).append(e).append(h).append(f).append(g).append(a).hide();this.input=p.append(b).append(c).show()}this._removeErrors();"dms"==q.mode?(k=this._getDMS(),this.degInput.val(k.d),this.minInput.val(k.m),this.secInput.val(k.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(k.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var k=d(this.element).val();if(isNaN(parseFloat(k))||!isFinite(k))return{d:"",
m:"",s:""};var q=Math.abs(k);q=60*(q-parseInt(q,10));if(1E-10>Math.abs(q-Math.round(q))){q=Math.round(q);var p=0}else p=60*(q-parseInt(q,10)),1E-10>Math.abs(p-Math.round(p))&&(p=Math.round(p));return{d:parseInt(k,10),m:parseInt(q,10),s:p}},_showError:function(k,q){"all"==k?this.input.find("input").addClass("invalidinput"):k&&k.addClass("invalidinput");q&&this.input.append('<div class="error">'+q+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var k=90;var q=i18n.latlon_error.lat}else k=180,q=i18n.latlon_error.lon;var p=this.degInput.val(),b=this.minInput.val(),a=this.secInput.val(),c=[];if(""===p&&""===b&&""===a)return"";p=parseInt(p,10)||0;b=parseInt(b,10)||0;a=parseFloat(a)||0;60<=Math.abs(b)&&(this._showError(this.minInput),c.push(i18n.latlon_error.min));60<=Math.abs(a)&&(this._showError(this.secInput),c.push(i18n.latlon_error.sec));b=Math.abs(p)+b/60+a/3600;
if(!c.length&&b>k||p>k)this._showError("all"),c.push(q);return c.length?(this._showError(null,c.join(", ")),null):(0>p?-1:1)*b},_validateDecimal:function(){this._removeErrors();var k=this.options.type,q=i18n.latlon_error.format;if("lat"==k){var p=90;var b=i18n.latlon_error.lat}else p=180,b=i18n.latlon_error.lon;var a=this.decimalInput.val();if(""===a)return"";a=this._parse(a,k);null===a?this._showError(this.decimalInput,q):Math.abs(a)>p&&(this._showError(this.decimalInput,b),a=null);return a},_parse:function(k,
q){var p="lat"==q?{N:1,S:-1}:{E:1,W:-1};var b=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,a=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,c=q=0,e=0;if(k.match(b))return a=k.replace(b,"$1|$2|$3").split("|"),(k=a[0]||a[2])&&(k=p[k]),q=parseFloat(a[1]),k&&Math.abs(q)!=q&&(k=null),k&&(q*=k),q;if(k.match(a)){a=k.replace(a,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(k=a[0]||a[7])&&
(k=p[k]);p=[];b=[];var h,f;for(f=1;6>f;f+=2){var g=a[f];(h=a[f+1])?(p.push(parseFloat(g)||0),b.push(h)):g&&(p.push(parseFloat(g)),b.push(null))}if(a=p.length){for(f=1;f<a;f++)p[f]=Math.abs(p[f]);g=p[0];Math.abs(g)!=g&&(k=1);if(1==a)h=b[0],'"'==h?e=p[0]:"'"==h?c=p[0]:h&&"\u00b0"!=h||(q=p[0]);else if(2==a)if(a=b[0],b=b[1],"\u00b0"==a)q=p[0],'"'==b?e=p[1]:"'"!=b&&b||(c=p[1]);else if(a){if("'"!=a||b&&'"'!=b)return null;c=p[0];e=p[1]}else'"'==b?(c=p[0],e=p[1]):"'"!=b&&b||(q=p[0],c=p[1]);else{if(b[0]&&
"\u00b0"!=b[0]||b[1]&&"'"!=b[1]||b[2]&&'"'!=b[2])return null;q=p[0];c=p[1];e=p[2]}q=q+c/60+e/3600;k&&(q*=k);return q}}return null},_bindEvents:function(){var k=this,q=this.eventNamespace;this.dmsInput.find("input").bind("change"+q,function(){var p=k._validateDMS();null!==p?d(k.element).val(p).change():d(k.element).val(k.defaultValue).change()});this.decimalInput.bind("change"+q,function(){var p=k._validateDecimal();null!==p?(d(k.element).val(p).change(),k.decimalInput.val(p)):d(k.element).val(k.defaultValue).change()});
d(this.element).bind("setvalue"+q,function(){k.refresh()});return!0},_unbindEvents:function(){var k=this.eventNamespace;this.input&&this.input.find("input").unbind(k);d(this.element).unbind(k);return!0}})})(jQuery);
