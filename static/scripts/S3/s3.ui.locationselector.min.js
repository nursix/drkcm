/*
 2015-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,x,v){b instanceof String&&(b=String(b));for(var f=b.length,l=0;l<f;l++){var p=b[l];if(x.call(v,p,l,b))return{i:l,v:p}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,x,v){if(b==Array.prototype||b==Object.prototype)return b;b[x]=v.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var x=0;x<b.length;++x){var v=b[x];if(v&&v.Math==Math)return v}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,x){var v=$jscomp.propertyToPolyfillSymbol[x];if(null==v)return b[x];v=b[v];return void 0!==v?v:b[x]};
$jscomp.polyfill=function(b,x,v,f){x&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,x,v,f):$jscomp.polyfillUnisolated(b,x,v,f))};$jscomp.polyfillUnisolated=function(b,x,v,f){v=$jscomp.global;b=b.split(".");for(f=0;f<b.length-1;f++){var l=b[f];if(!(l in v))return;v=v[l]}b=b[b.length-1];f=v[b];x=x(f);x!=f&&null!=x&&$jscomp.defineProperty(v,b,{configurable:!0,writable:!0,value:x})};
$jscomp.polyfillIsolated=function(b,x,v,f){var l=b.split(".");b=1===l.length;f=l[0];f=!b&&f in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var p=0;p<l.length-1;p++){var c=l[p];if(!(c in f))return;f=f[c]}l=l[l.length-1];v=$jscomp.IS_SYMBOL_NATIVE&&"es6"===v?f[l]:null;x=x(v);null!=x&&(b?$jscomp.defineProperty($jscomp.polyfills,l,{configurable:!0,writable:!0,value:x}):x!==v&&(void 0===$jscomp.propertyToPolyfillSymbol[l]&&(v=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[l]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(l):$jscomp.POLYFILL_PREFIX+v+"$"+l),$jscomp.defineProperty(f,$jscomp.propertyToPolyfillSymbol[l],{configurable:!0,writable:!0,value:x})))};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(x,v){return $jscomp.findInternal(this,x,v).v}},"es6","es3");
(function(b,x){var v=0,f={},l={},p={};b.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=v;v+=1;this.eventNamespace=".locationselector"},_init:function(){var c=b(this.element),a=this.options,d=c.attr("id");if(!d)throw"Location selector widget: real input field without id";this.fieldname=d;this.input=c;this.data=null;this._storeHierarchyData(a.labels,
a.locations);this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var c=this._deserialize();this._renderWidget();var a="#"+this.fieldname,d=this.options;b(a+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var e=b(a+"_postcode").data("k");this.postcodeToAddress=e?e:!1;e=b(a+"_L0__row");if(e.length){var k=[];for(n in f){var g=f[n];0===g.l&&(g.i=n,k.push(g))}k.sort(function(w,y){return w.n.localeCompare(y.n)});for(var h=
b(a+"_L0"),m=0,q=k.length;m<q;m++){g=k[m];var n=g.i;n='<option value="'+n+'">'+g.n+"</option>";h.append(n)}this.postcodeToAddress||(e.removeClass("hide").show(),e=b(a+"_L0__row1"),e.length&&e.removeClass("hide").show())}var t;this.postcodeToAddress&&!c.address&&(t=!0);var u=this;e=c.L0;k=c.L1;n=c.L2;h=c.L3;m=c.L4;q=c.L5;var r;[e,k||n,n||h,h||m,m||q,q].forEach(function(w,y){w&&(r=r?r.then(function(){return u.lxSelect(y,w,!0,t)}):u.lxSelect(y,w,!0,t))});this.lx=[e,k,n,h,m,q].join("|");e=c.address;b(a+
"_address").val(e);e?(b(a+"_address__row").removeClass("hide").show(),b(a+"_address__row1").removeClass("hide").show()):this.postcodeToAddress||(b(a+"_address__row").removeClass("hide").show(),b(a+"_address__row1").removeClass("hide").show());b(a+"_postcode").val(c.postcode);b(a+"_postcode__row").removeClass("hide").show();b(a+"_postcode__row1").removeClass("hide").show();this.postcodeToAddress&&(b(a+"_postcode_to_address__row").removeClass("hide").show(),b(a+"_postcode_to_address__row1").removeClass("hide").show());
b(a+"_lat").val(c.lat).latloninput({type:"lat",mode:d.latlonMode});b(a+"_lat__row").removeClass("hide").show();b(a+"_lat__row1").removeClass("hide").show();b(a+"_lon").val(c.lon).latloninput({type:"lon",mode:d.latlonMode});b(a+"_lon__row").removeClass("hide").show();b(a+"_lon__row1").removeClass("hide").show();e=b(a+"_map_icon__row").removeClass("hide").show();c.lat||c.lon||c.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):d.featureRequired?this._showMap():d.openMapOnLoad&&e.is(":visible")&&
"#sub_"!=a.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var c=this.fieldname,a="#"+c,d=this.options.reverseLx,e=b(a+"_map_icon__row .map_wrapper");e.attr("id",this.fieldname+"_map_wrapper");var k=b(a+"__row"),g=this.input.next(".error_wrapper").addClass("error_top"),h=b(a+"_map_icon__row"),m=b(a+"_L0__row"),q=b(a+"_postcode__row");if(k.is(".control-group, .form-row")){c=
b(a+"_L1__row");var n=b(a+"_L2__row"),t=b(a+"_L3__row"),u=b(a+"_L4__row"),r=b(a+"_L5__row"),w=b(a+"_address__row"),y=b(a+"_postcode_to_address__row"),A=b(a+"_lat__row"),z=b(a+"_lon__row");a=b(a+"_latlon_toggle__row");d?k.hide().after(e).after(h).after(a).after(z).after(A).after(m).after(c).after(n).after(t).after(u).after(r).after(y).after(q).after(w).after(g):k.hide().after(e).after(h).after(a).after(z).after(A).after(y).after(q).after(w).after(r).after(u).after(t).after(n).after(c).after(m).after(g)}else k.parent().is(".inline-form")?
k.show():(b(a+"__row1").hide(),k.hide().after(g),h.detach(),k.siblings('[id^="'+c+'"][id$="__row"]').last().after(e).after(h));if(g.length)g.one("click"+this.eventNamespace,function(){var B=b(this);B.fadeOut("slow",function(){B.remove()})})},_lxSelectFinal:function(c){c?this._serialize():this._collectData();this._zoomMap()},lxSelect:function(c,a,d,e){var k=b.Deferred(),g=this,h="#"+g.fieldname,m=g.options,q=b(h+"_L"+c),n;a?(q.val(a).trigger("change","implicit"),q.hasClass("multiselect")&&q.multiselect("instance")&&
q.multiselect("refresh")):a=parseInt(q.val(),10);if(0===c){var t=g._readLabels(a),u=l.d,r=["1","2","3","4","5"],w,y,A;t.then(function(K){for(A=0;5>A;A++)n=r[A],w=K[n]||u[n],z=h+"_L"+n,q=b(z),y=m.showLabels?q.hasClass("required")?"<div>"+w+':<span class="req"> *</span></div>':w+":":"",b(z+"__row label").html(y),b(z+"__row1 label").html(y),b(z+' option[value=""]').html(i18n.select+" "+w),q.hasClass("multiselect")&&q.multiselect("instance")&&q.multiselect("refresh")})}t=m.hideLx;for(n=c+1;6>n;n++){var z=
h+"_L"+n;t?(b(z+"__row").hide(),b(z+"__row1").hide()):b(z+" option").remove('[value != ""]');b(z).val("").trigger("change","implicit")}if(a){var B=!1,C=c+1,G=b(h+"_L"+C+"__row");G.length||(B=!0,C++,G=b(h+"_L"+C+"__row"));if(G.length){var D;t=!1;if(b(h+"_L"+c+' option[value="'+a+'"]').hasClass("missing")){var E=f[a];E.i=a;var H=[E]}else for(D in H=[],t=!0,f)if(f[D].f==a){t=!1;break}g._readHierarchy(t,a,C,B).then(function(){if(0==H.length)for(D in f)E=f[D],E.f==a&&(E.i=D,H.push(E));var K=H.length;if(K){H.sort(function(L,
M){return L.n.localeCompare(M.n)});var I=h+"_L"+C;var F=b(I),J=b(I+' option[value=""]').html();b(I+" option").remove('[value != ""]');D=null;for(A=0;A<K;A++)E=H[A],D=E.i,I=a==D?' selected="selected"':"",B=E.l==C?"":' class="missing"',I='<option value="'+D+'"'+I+B+">"+E.n+"</option>",F.append(I);e||(G.removeClass("hide").show(),b(h+"_L"+C+"__row1").removeClass("hide").show());F.hasClass("multiselect")&&(J={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:J,multiple:!1},F.hasClass("search")?
(F.multiselect(J).multiselectfilter({label:"",placeholder:i18n.search}),b(".ui-multiselect-header").show()):(J.header=!1,F.multiselect(J)));F=g.data["L"+C];J=H.map(function(L){return L.i});F&&-1!=J.indexOf(""+F)?g.lxSelect(C,F,d):1==K&&D&&g.lxSelect(C,D,d)}g._lxSelectFinal(d);k.resolve()})}else g.useGeocoder&&!d&&g._geocodeDecision(),g._lxSelectFinal(d),k.resolve()}else g._lxSelectFinal(d),k.resolve();return k.promise()},_collectData:function(c){var a=this.data,d="#"+this.fieldname,e=this._lookupParent(),
k=b(d+"_address").val(),g=b(d+"_postcode").val();a.address=k;a.postcode=g;if(a.specific)a.id=a.specific,a.parent=e;else{var h=a.lat,m=a.lon,q=a.wkt;k||g||h||m||q?(a.id=null,a.parent=e):(a.id=e,a.parent=null)}this._serialize();b(d+"_lat").val(a.lat).trigger("setvalue");b(d+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.trigger("change",c&&"user"||"implicit")},_collectLx:function(){var c=this.data,a="#"+this.fieldname,d;
for(d=0;6>d;d++){var e=b(a+"_L"+d);e.length&&(e=e.val(),c["L"+d]=e?parseInt(e,10):null)}this._serialize()},_hasData:function(){var c=this.data,a=!1;c.specific||c.address||c.postcode||c.lat||c.lon||c.wkt?a=!0:[c.L0,c.L1,c.L2,c.L3,c.L4,c.L5].join("|")!=this.lx&&(a=!0);return a},_lookupParent:function(){this._collectLx();for(var c=this.data,a,d=5;-1<d;d--)if(a=c["L"+d])return a;return(c=f.d)?c.i:null},_readLabels:function(c){c||(c="d");var a=b.Deferred(),d=l[c];if(d==x){var e=S3.Ap.concat("/gis/hdata/"+
c);b.ajaxS3({url:e,dataType:"json",success:function(k){d={};try{for(var g in k)d[g]=k[g];l[c]=d}catch(h){}a.resolve(d)},error:function(k,g,h){(k="UNAUTHORIZED"==h?i18n.gis_requires_login:k.responseText)&&s3_debug(k);a.reject()}})}else a.resolve(d);return a.promise()},_readHierarchy:function(c,a,d,e){var k=""+a+";"+d+";"+e,g=p[k];if(g!==x)return g;var h=b.Deferred();if(c){c="#"+this.fieldname;var m=b(c+"_L"+d),q=!1;m.hide();if(m.hasClass("multiselect")){q=!0;var n=b(c+"_L"+d+"__row button").hide()}var t=
b(c+"_L"+d+"__throbber").removeClass("hide").show();a=e?S3.Ap.concat("/gis/ldata/"+a+"/"+d):S3.Ap.concat("/gis/ldata/"+a);b.ajaxS3({url:a,dataType:"json",success:function(u){for(var r in u)f[r]=u[r];t.hide();q?n.removeClass("hide").show():m.removeClass("hide").show();h.resolve()},error:function(u,r,w){if(u="UNAUTHORIZED"==w?i18n.gis_requires_login:u.responseText)s3_debug(u),S3.showAlert(u,"error");t.hide();q?n.removeClass("hide").show():m.removeClass("hide").show();h.reject()}})}else h.resolve();
return g=p[k]=h.promise()},_geocodeDecision:function(){var c="#"+this.fieldname,a=this.data;this._collectData();if(S3.gis.geocodeDecisionPlugin)S3.gis.geocodeDecisionPlugin(c,a,this);else if(a.address){a=["1","2","3","4","5"];for(var d=0,e;5>d;d++)if(e=b(c+"_L"+a[d]),e.length&&!e.val()&&1<e[0].options.length)return;b(c+"_geocode .geocode_success,"+c+"_geocode .geocode_fail").hide();var k=this;a=this.eventNamespace;this.input.data("manually_geocoded")?b(c+"_geocode button").removeClass("hide").show().unbind(a).bind("click"+
a,function(){b(this).hide();k._geocode()}):this._geocode()}},_geocode:function(){for(var c=this.fieldname,a=this,d="#"+c,e=b(d+"_geocode .geocode_fail").hide(),k=b(d+"_geocode .geocode_success").hide(),g=b(d+"_geocode .throbber").removeClass("hide").show(),h=this.data,m={address:h.address},q="postcode L0 L1 L2 L3 L4 L5".split(" "),n=0,t,u;7>n;n++)t=q[n],(u=h[t])&&(m[t]=u);m.k=b(d+"_geocode button").data("k");d=S3.Ap.concat("/gis/geocode");b.ajaxS3({url:d,type:"POST",data:m,dataType:"json",success:function(r){var w=
r.lat,y=r.lon;if(w||y){h.lat=parseFloat(w);h.lon=parseFloat(y);a._collectData();w=S3.gis;if(w.maps&&(y=w.maps["location_selector_"+c])){r=y.s3.draftLayer;r.removeAllFeatures();var A=new OpenLayers.Geometry.Point(h.lon,h.lat);A.transform(w.proj4326,y.getProjectionObject());w=new OpenLayers.Feature.Vector(A);r.addFeatures([w]);a._zoomMap()}g.hide();k.html(i18n.address_mapped).removeClass("hide").show()}else g.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(r)},error:function(r,
w,y){r="UNAUTHORIZED"==y?i18n.gis_requires_login:r.responseText;g.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(r)}})},_geocodeReverse:function(){var c=this,a="#"+this.fieldname,d=b(a+"_geocode .geocode_fail").hide(),e=b(a+"_geocode .geocode_success").hide(),k=b(a+"_geocode .throbber").removeClass("hide").show(),g=this.data;g={lat:g.lat,lon:g.lon};g.k=b(a+"_geocode button").data("k");a=S3.Ap.concat("/gis/geocode_r");b.ajaxS3({async:!1,url:a,type:"POST",data:g,dataType:"json",
success:function(h){var m=h.L0,q=h.L1,n=h.L2,t=h.L3,u=h.L4;h=h.L5;if(m){c.useGeocoder=!1;var r;[m,q||n,n||t,t||u,u||h,h].forEach(function(w,y){w&&(r=r?r.then(function(){return c.lxSelect(y,w)}):c.lxSelect(y,w))});c.useGeocoder=!0;k.hide();e.html(i18n.location_found).removeClass("hide").show()}else k.hide(),d.html(i18n.location_not_found).removeClass("hide").show()},error:function(h,m,q){h="UNAUTHORIZED"==q?i18n.gis_requires_login:h.responseText;k.hide();d.html(i18n.location_not_found).removeClass("hide").show();
s3_debug(h)}})},_latlonInput:function(){var c=this.fieldname,a=this.data,d="#"+c,e=b(d+"_lat").val();d=b(d+"_lon").val();e||d?(e=e?parseFloat(e):0,d=d?parseFloat(d):0,a.lat=e,a.lon=d,a.wkt=null,this.input.data("manually_geocoded",!0)):(a.lat=null,a.lon=null,a.wkt||this.input.data("manually_geocoded",!1));this._serialize();e=S3.gis;e.maps&&(c=e.maps["location_selector_"+c])&&(d=c.s3.draftLayer,d.removeAllFeatures(),null!==a.lat&&null!==a.lon&&(a=new OpenLayers.Geometry.Point(a.lon,a.lat),a.transform(e.proj4326,
c.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),d.addFeatures([a]),c.s3.lastDraftFeature=a),this._zoomMap())},_postcodeToAddress:function(){this._collectData();var c=this.fieldname,a=this,d="#"+c,e=this.data,k=e.postcode;if(k){b(d+"_address_menu").remove();var g=b(d+"_postcode__row .geocode_fail").hide(),h=b(d+"_postcode__row .throbber").removeClass("hide").show();g.length||(b(d+"_postcode__row .columns").append('<div class="geocode_fail hide"></div>'),g=b(d+"_postcode__row .geocode_fail"));
h.length||(b(d+"_postcode__row .columns").append('<div class="throbber"></div>'),h=b(d+"_postcode__row .throbber"));b.ajaxS3({url:S3.Ap.concat("/gis/postcode_to_address"),type:"POST",data:{postcode:k,k:a.postcodeToAddress},dataType:"json",success:function(m){var q=m.addresses;if(q&&q.length){h.hide();for(var n='<ul id="'+c+'_address_menu">',t=0;t<q.length;t++)n+="<li><div>"+q[t]+"</div></li>";n+="</ul>";b(d+"_postcode").after(n);b(d+"_address_menu").menu({select:function(u,r){e.address=r.item[0].innerText;
b(d+"_address").val(e.address);e.lat=parseFloat(m.lat);e.lon=parseFloat(m.lon);a._collectData();b(d+"_address__row").removeClass("hide").show();b(d+"_address__row1").removeClass("hide").show();b(d+"_address_menu").menu("destroy").remove();r=S3.gis;if(r.maps){var w=r.maps["location_selector_"+c];if(w){u=w.s3.draftLayer;u.removeAllFeatures();var y=new OpenLayers.Geometry.Point(e.lon,e.lat);y.transform(r.proj4326,w.getProjectionObject());r=new OpenLayers.Feature.Vector(y);u.addFeatures([r]);a._zoomMap()}}u=
m.L0;r=m.L1;w=m.L2;y=m.L3;var A=m.L4,z=m.L5;if(u){b(d+"_L0__row").removeClass("hide").show();b(d+"_L0__row1").removeClass("hide").show();var B;[u,r||w,w||y,y||A,A||z,z].forEach(function(C,G){C&&(B=B?B.then(function(){return a.lxSelect(G,C,!0)}):a.lxSelect(G,C,!0))})}}})}else h.hide(),g.html(i18n.no_addresses_found).removeClass("hide").show(),s3_debug(m)},error:function(m,q,n){m="UNAUTHORIZED"==n?i18n.gis_requires_login:m.responseText;h.hide();g.html(m).removeClass("hide").show();s3_debug(m)}})}},
_showMap:function(c){var a=this.fieldname,d=this.eventNamespace,e=this,k="#"+a;b(k+"_map_icon").unbind(d).bind("click"+d,function(){e._hideMap()});b(k+"_map_icon span").html(i18n.hide_map);d=b(k+"_map_wrapper").hide().removeClass("hide").slideDown("medium");d.length&&c&&b("html,body").animate({scrollTop:d.offset().top},250);var g=this.input;b.when(this._jsLoaded()).then(function(){var h=S3.gis,m="location_selector_"+a;var q=h.maps[m]?h.maps[m]:h.show_map(m);e._zoomMap();var n=e.data;m=n.lat;var t=
n.lon,u=n.wkt;if(m||t||u)q.s3.draftLayer.removeAllFeatures(),u!=x&&u?(m={internalProjection:q.getProjectionObject(),externalProjection:h.proj4326},m=(new OpenLayers.Format.WKT(m)).read(u)):(m=new OpenLayers.Geometry.Point(parseFloat(t),parseFloat(m)),m.transform(h.proj4326,q.getProjectionObject()),m=new OpenLayers.Feature.Vector(m)),q.s3.draftLayer.addFeatures([m]),q.s3.lastDraftFeature=m;m=q.controls;t=0;for(var r=m.length;t<r;t++)if("OpenLayers.Control.DrawFeature"==m[t].CLASS_NAME){var w=m[t];
break}w&&(q.s3.pointPlaced=function(y){b(k+"_geocode .geocode_fail").hide();b(k+"_geocode .geocode_success").hide();var A=y.geometry;if("OpenLayers.Geometry.Point"==A.CLASS_NAME)y=A.getBounds().getCenterLonLat(),y.transform(q.getProjectionObject(),h.proj4326),n.wkt=null,n.lat=y.lat,n.lon=y.lon,!n.address&&e.useGeocoder&&e._geocodeReverse();else{A={internalProjection:q.getProjectionObject(),externalProjection:h.proj4326};n.radius=null;var z=new OpenLayers.Geometry.LinearRing(y.geometry.components[0].components);
z=new OpenLayers.Geometry.Polygon([z]);if(1E3==z.getVertices().length){var B=(new OpenLayers.Feature.Vector(z,null)).geometry.getBounds();z=B.right;var C=(B.bottom+B.top)/2;B=new OpenLayers.Geometry.Point((B.left+z)/2,C);z=new OpenLayers.Geometry.Point(z,C);z=new OpenLayers.Geometry.LineString([B,z]);z=parseFloat(z.getLength());n.radius=z}u=(new OpenLayers.Format.WKT(A)).write(y);n.wkt=u;n.lat=null;n.lon=null}g.data("manually_geocoded",!0);e._collectData(!0);e._removeErrors();"sub_"==a.substring(0,
4)&&g.parent().find("div.map_wrapper").trigger("change")})},function(h){s3_debug(h)},function(h){s3_debug(h)})},_hideMap:function(){var c=this.fieldname,a=this.eventNamespace,d="#"+c,e=this;b(d+"_map_icon").unbind(a).bind("click"+a,function(g){e._showMap(g)});b(d+"_map_wrapper").slideUp("medium");a=this.data;if(a.specific)var k=i18n.show_map_view;else if(k=i18n.show_map_add,S3.gis.maps&&(c=S3.gis.maps["location_selector_"+c]))c.s3.draftLayer.removeAllFeatures(),a.lat=null,a.lon=null,a.wkt=null,this.input.data("manually_geocoded",
!1),this._collectData();b(d+"_map_icon span").html(k)},_zoomMap:function(c){var a=this.fieldname,d=S3.gis;if(d.maps&&(a=d.maps["location_selector_"+a])){var e=this.data;d=e.lat;var k=e.lon;e=e.wkt;if(d&&k)d=OpenLayers.Bounds.fromArray([k,d,k,d]);else if(e)d=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(e))).geometry.getBounds();else{c||(c=this._lookupParent()||"d");d=f[c].b;if(!d||!d.length)for(k=f[c].f,c=4;k&&c&&(c--,k=f[k],!(d=k.b)&&0!==k.l);)k=k.f;d&&(d=OpenLayers.Bounds.fromArray(d))}d&&
S3.gis.zoomBounds(a,d,this.options.minBBOX)}},_validate:function(){var c=this.fieldname;this._removeErrors();var a="#"+c,d=this.data;if(c=this.options.featureRequired){var e=!1;switch(c){case "latlon":e=d.lat||d.lon;break;case "wkt":e=d.wkt;break;default:e=d.lat||d.lon||d.wkt}if(!e)return this._fieldError(b(a+"_map_icon"),i18n.map_feature_required),!1}var k=function(n){return n.hasClass("multiselect")?n.next("button.ui-multiselect").is(":visible"):n.is(":visible")},g=!1;c="L5 L4 L3 L2 L1 L0".split(" ");
for(e=0;6>e;e++){var h=c[e];var m=a+"_"+h;var q=b(m);if(q.length&&q.hasClass("required")&&k(q)&&!d[h]){this._fieldError(q,i18n.enter_value);g=!0;break}}["address","postcode"].forEach(function(n){m=a+"_"+n;q=b(m);q.length&&q.hasClass("required")&&k(q)&&!d[n]&&(this._fieldError(q,i18n.enter_value),g=!0)},this);return!g},_serialize:function(){var c=JSON.stringify(this.data);this.input.val(c);return c},_deserialize:function(){var c=this.input.val();return this.data=JSON.parse(c)},_storeHierarchyData:function(c,
a){var d;if(a)for(d in a)f[d]=a[d];if(c)for(d in c)l[d]=c[d]},_jsLoaded:function(){var c=new jQuery.Deferred;setTimeout(function d(){S3.gis.maps!=x?c.resolve("loaded"):"pending"===c.state()&&(c.notify("waiting for JS to load..."),setTimeout(d,500))},1);return c.promise()},_fieldError:function(c,a){c.addClass("invalidinput").after('<div class="error" style="display: block;">'+a+"</div>");b(".invalidinput").get(0).scrollIntoView()},_removeErrors:function(c){c||(c="#"+this.fieldname,c=c+"_L0,"+c+"_L1,"+
c+"_L2,"+c+"_L3,"+c+"_L4,"+c+"_L5,"+c+"_address,"+c+"_postcode,"+c+"_map_icon");b(c).removeClass("invalidinput").siblings(".error").remove()},_bindEvents:function(){var c=this.fieldname,a=this.eventNamespace,d=this,e="#"+c;b(e+"_L0").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(0)});b(e+"_L1").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(1)});b(e+"_L2").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(2)});b(e+"_L3").bind("change"+a,function(){d._removeErrors(this);
d.lxSelect(3)});b(e+"_L4").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(4)});b(e+"_L5").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(5)});b(e+"_address").bind("change"+a,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d._collectData()});b(e+"_postcode").bind("change"+a,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d.postcodeToAddress?d._postcodeToAddress():d._collectData()});b(e+"_postcode_to_address").bind("click"+a,function(){b(e+
"_address__row").removeClass("hide").show();b(e+"_address__row1").removeClass("hide").show();b(e+"_L0__row").removeClass("hide").show();b(e+"_L0__row1").removeClass("hide").show();var g=d.data,h=g.L2,m=g.L3,q=g.L4,n=g.L5,t;[g.L0,g.L1||h,h||m,m||q,q||n,n].forEach(function(u,r){u&&(t=t?t.then(function(){return d.lxSelect(r,u,!0)}):d.lxSelect(r,u,!0))});b(this).hide()});b(e+"_lat,"+e+"_lon").bind("change"+a,function(){d._latlonInput()});b(e+"_latlon_toggle").bind("click"+a,function(){var g=b(this).data("mode")||
d.options.latlonMode;if("dms"==g){g="decimal";var h=i18n.latlon_mode.dms}else g="dms",h=i18n.latlon_mode.decimal;b(e+"_lat").latloninput("option",{mode:g});b(e+"_lon").latloninput("option",{mode:g});b(this).html(h).data("mode",g)});if("sub_"==c.substring(0,4))this.input.closest(".inline-form").bind("validate"+a+this.id,function(g){d._validate()||g.preventDefault()});else{var k=this.input.closest("form");k.bind("submit"+a+this.id,function(g){g.preventDefault();d._validate()&&k.unbind(a+d.id).submit()})}return!0},
_unbindEvents:function(){var c="#"+this.fieldname,a=this.eventNamespace;b(c+"_L0,"+c+"_L1,"+c+"_L2,"+c+"_L3,"+c+"_L4,"+c+"_L5,"+c+"_address,"+c+"_postcode,"+c+"_postcode_to_address,"+c+"_map_icon,"+c+"_latlon_toggle").unbind(a);this.input.next(".error_wrapper").unbind(a);this.input.closest("form").unbind(a+this.id);return!0}})})(jQuery);
(function(b,x){var v=0;b.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=v;v+=1;this.eventNamespace=".latloninput"},_init:function(){b(this.element).hide();this.refresh()},_destroy:function(){b(this.element).show();b.Widget.prototype.destroy.call(this)},_setOption:function(f,l){this._super(f,l);"mode"==f&&this.refresh()},refresh:function(){this._unbindEvents();var f=b(this.element),l=this.options;this.defaultValue=f.val();
if(!this.input){var p=b("<div>").hide().insertAfter(f),c=b('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=c;var a=l.labels,d=b('<input type="text" class="integer dms-input" size="5">'),e=b('<span class="dms-label">'+a.deg+"</span>"),k=b('<input type="text" class="integer dms-input" size="5">'),g=b('<span class="dms-label">'+a.min+"</span>"),h=b('<input type="text" class="double dms-input" size="8">');a=b('<span class="dms-label">'+a.sec+"</span>");this.degInput=d;this.minInput=
k;this.secInput=h;this.dmsInput=d=b("<span>").append(d).append(e).append(k).append(g).append(h).append(a).hide();this.input=p.append(c).append(d).show()}this._removeErrors();"dms"==l.mode?(f=this._getDMS(),this.degInput.val(f.d),this.minInput.val(f.m),this.secInput.val(f.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(f.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var f=b(this.element).val();if(isNaN(parseFloat(f))||!isFinite(f))return{d:"",
m:"",s:""};var l=Math.abs(f);l=60*(l-parseInt(l,10));if(1E-10>Math.abs(l-Math.round(l))){l=Math.round(l);var p=0}else p=60*(l-parseInt(l,10)),1E-10>Math.abs(p-Math.round(p))&&(p=Math.round(p));return{d:parseInt(f,10),m:parseInt(l,10),s:p}},_showError:function(f,l){"all"==f?this.input.find("input").addClass("invalidinput"):f&&f.addClass("invalidinput");l&&this.input.append('<div class="error">'+l+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var f=90;var l=i18n.latlon_error.lat}else f=180,l=i18n.latlon_error.lon;var p=this.degInput.val(),c=this.minInput.val(),a=this.secInput.val(),d=[];if(""===p&&""===c&&""===a)return"";p=parseInt(p,10)||0;c=parseInt(c,10)||0;a=parseFloat(a)||0;60<=Math.abs(c)&&(this._showError(this.minInput),d.push(i18n.latlon_error.min));60<=Math.abs(a)&&(this._showError(this.secInput),d.push(i18n.latlon_error.sec));c=Math.abs(p)+c/60+a/3600;
if(!d.length&&c>f||p>f)this._showError("all"),d.push(l);return d.length?(this._showError(null,d.join(", ")),null):(0>p?-1:1)*c},_validateDecimal:function(){this._removeErrors();var f=this.options.type,l=i18n.latlon_error.format;if("lat"==f){var p=90;var c=i18n.latlon_error.lat}else p=180,c=i18n.latlon_error.lon;var a=this.decimalInput.val();if(""===a)return"";a=this._parse(a,f);null===a?this._showError(this.decimalInput,l):Math.abs(a)>p&&(this._showError(this.decimalInput,c),a=null);return a},_parse:function(f,
l){var p="lat"==l?{N:1,S:-1}:{E:1,W:-1};var c=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,a=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,d=l=0,e=0;if(f.match(c))return a=f.replace(c,"$1|$2|$3").split("|"),(f=a[0]||a[2])&&(f=p[f]),l=parseFloat(a[1]),f&&Math.abs(l)!=l&&(f=null),f&&(l*=f),l;if(f.match(a)){a=f.replace(a,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(f=a[0]||a[7])&&
(f=p[f]);p=[];c=[];var k,g;for(g=1;6>g;g+=2){var h=a[g];(k=a[g+1])?(p.push(parseFloat(h)||0),c.push(k)):h&&(p.push(parseFloat(h)),c.push(null))}if(a=p.length){for(g=1;g<a;g++)p[g]=Math.abs(p[g]);h=p[0];Math.abs(h)!=h&&(f=1);if(1==a)k=c[0],'"'==k?e=p[0]:"'"==k?d=p[0]:k&&"\u00b0"!=k||(l=p[0]);else if(2==a)if(a=c[0],c=c[1],"\u00b0"==a)l=p[0],'"'==c?e=p[1]:"'"!=c&&c||(d=p[1]);else if(a){if("'"!=a||c&&'"'!=c)return null;d=p[0];e=p[1]}else'"'==c?(d=p[0],e=p[1]):"'"!=c&&c||(l=p[0],d=p[1]);else{if(c[0]&&
"\u00b0"!=c[0]||c[1]&&"'"!=c[1]||c[2]&&'"'!=c[2])return null;l=p[0];d=p[1];e=p[2]}l=l+d/60+e/3600;f&&(l*=f);return l}}return null},_bindEvents:function(){var f=this,l=this.eventNamespace;this.dmsInput.find("input").bind("change"+l,function(){var p=f._validateDMS();null!==p?b(f.element).val(p).change():b(f.element).val(f.defaultValue).change()});this.decimalInput.bind("change"+l,function(){var p=f._validateDecimal();null!==p?(b(f.element).val(p).change(),f.decimalInput.val(p)):b(f.element).val(f.defaultValue).change()});
b(this.element).bind("setvalue"+l,function(){f.refresh()});return!0},_unbindEvents:function(){var f=this.eventNamespace;this.input&&this.input.find("input").unbind(f);b(this.element).unbind(f);return!0}})})(jQuery);
