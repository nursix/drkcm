/*
 2018-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(c,n){var l=0;c.widget("s3.anonymize",{options:{ajaxURL:null,nextURL:null},_create:function(){this.id=l;l+=1;this.eventNamespace=".anonymize"},_init:function(){var a=c(this.element);this.container=a.find(".anonymize-dialog");this.submitButton=a.find(".anonymize-submit");this.cancelButton=a.find(".anonymize-cancel");this.confirmCB=a.find('input[name="anonymize_confirm"]').first();this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();
this._bindEvents()},_showDialog:function(){var a=this.options,b=this.eventNamespace,d=this.container,k=this.cancelButton,e=this.submitButton,f=this.confirmCB,g=this,h=d.removeClass("hide").show().dialog({autoOpen:!1,modal:!0,closeText:"",open:function(){c(".ui-widget-overlay").off(b).on("click"+b,function(){h.dialog("close")});k.off(b).on("click"+b,function(){h.dialog("close")});f.off(b).on("click"+b,function(){c(this).prop("checked")?e.prop("disabled",!1):e.prop("disabled",!0)});e.off(b).on("click"+
b,function(){g._anonymize(d).then(function(m){d.find(".anonymize-form").hide();d.find(".anonymize-success").removeClass("hide").show();if(m)try{S3ClearNavigateAwayConfirm()}finally{a.nextURL?window.location=a.nextURL:window.location.reload(!0)}else h.dialog("close")},function(){h.dialog("close")})})},close:function(){f.prop("checked",!1);e.prop("disabled",!0);d.hide()}});h.dialog("open")},_anonymize:function(a){var b=c.Deferred(),d=this.cancelButton.hide(),k=this.submitButton.prop("disabled",!0),
e=c('<div class="inline-throbber">').css({display:"inline-block","margin-left":"1rem"}).insertAfter(d),f=function(){e.remove();d.show();k.prop("disabled",!1)},g=[];a.find(".anonymize-rule").each(function(){c(this).prop("checked")&&g.push(c(this).attr("name"))});if(!g.length)return b.resolve(!1);a=a.find('input[name="action-key"]').first().val();a=JSON.stringify({apply:g,key:a});c.ajaxS3({type:"POST",url:this.options.ajaxURL,data:a,dataType:"json",contentType:"application/json; charset=utf-8",success:function(){f();
b.resolve(!0)},error:function(){f();b.reject()}});return b.promise()},_bindEvents:function(){var a=this,b=this.eventNamespace;c(this.element).find(".anonymize-btn").off(b).on("click"+b,function(){a._showDialog()});return!0},_unbindEvents:function(){var a=this.eventNamespace;c(this.element).off(a);return!0}})})(jQuery);
