/*
 2015-2021 (c) Sahana Software Foundation
 @license MIT
*/
(function(b,r){var l=0;b.widget("s3.embeddedComponent",{options:{ajaxURL:null,fieldname:null,component:null,recordID:null,autocomplete:!1},_create:function(){this.id=l;l+=1;this.eventNamespace=".embeddedComponent";this.eventNamespaceID=this.eventNamespace+this.id},_init:function(){var a=this.options.fieldname;this.input=b(this.element);this.fieldname=a;this.selectBtn=b("#"+a+"-select");this.editBtn=b("#"+a+"-edit");this.clearBtn=b("#"+a+"-clear");this.loadThrobber=this.selectBtn.siblings(".throbber");
this.selectRow=b("#"+a+"-select-row");this.dummyInput=b("#dummy_"+a);this.autocompleteRow=b("#"+a+"-autocomplete-row");this.autocompleteLabel=b("#"+a+"-autocomplete-label");this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();this.dummyInput.hide();var a=this.options.recordID;"None"!=a&&(this.input.val(a),this.select(a));0<this.input.val()&&(this.clearBtn.removeClass("hide").show(),this.editBtn.removeClass("hide").show(),this._disableEmbedded());
this._bindEvents()},select:function(a){"undefined"==typeof a?a=this.input.val():this.input.val(a);this.selectBtn.hide();this.clearBtn.hide();this.loadThrobber.removeClass("hide").show();this._clear();var d=this.options.component,c=this;b.getJSONS3(this.options.ajaxURL+a+".s3json?show_ids=true",function(h){try{var k=h["$_"+d][0];c._disableEmbedded();c.input.val(k["@id"]);var p=RegExp("^[$|@].*"),q=RegExp("^[$]k_.*"),e;for(e in k){if(e.match(p))if(e.match(q))var g="#"+d+"_"+e.slice(3);else continue;
else g="#"+d+"_"+e;try{var f=k[e];if(f.hasOwnProperty("@id"))b(g).val(eval(f["@id"]));else if(f.hasOwnProperty("@value")){try{var m=JSON.parse(f["@value"])}catch(n){m=f["@value"]}b(g).val(m)}else b(g).val(f)}catch(n){}}}catch(n){c.input.val("")}c.loadThrobber.hide();c.selectBtn.removeClass("hide").show();c.editBtn.removeClass("hide").show();c.clearBtn.removeClass("hide").show();(h=c.options.postprocess)&&eval(h)});c.autocompleteRow.hide();c.selectRow.removeClass("hide").show()},_clear:function(){var a=
b(this.input);a.closest("form").find(".embedded-"+this.fieldname).each(function(){b(this).find("input, select, textarea").prop("disabled",!1).val("")});a.val("");this.clearBtn.hide();this.editBtn.hide();(a=this.options.postprocess)&&eval(a)},_edit:function(){this._enableEmbedded();this.editBtn.hide()},_enableEmbedded:function(){b(this.element).closest("form").find(".embedded-"+this.fieldname).each(function(){b(this).find("input, select, textarea").prop("disabled",!1)})},_disableEmbedded:function(){b(this.element).closest("form").find(".embedded-"+
this.fieldname).each(function(){b(this).find("input, select, textarea").prop("disabled",!0)})},_onFormSubmission:function(){S3ClearNavigateAwayConfirm();this._enableEmbedded()},_bindEvents:function(){var a=this,d=this.eventNamespace;this.input.closest("form").on("submit"+this.eventNamespaceID,function(){a._onFormSubmission();return!0});this.selectBtn.on("click"+d,function(){a.selectRow.hide();a.autocompleteRow.removeClass("hide").show();a.autocompleteLabel.removeClass("hide").show();a.dummyInput.removeClass("hide").show().trigger("focus")});
this.editBtn.on("click"+d,function(){a._edit()});this.clearBtn.on("click"+d,function(){a._clear()});this.dummyInput.on("focusout"+d,function(){a.input.val();b(this).hide();a.autocompleteLabel.hide();a.selectRow.removeClass("hide").show();0<a.input.val()&&a.clearBtn.removeClass("hide").show()});if(!this.options.autocomplete)this.dummyInput.on("change"+d,function(){var c=b(this).val();c&&a.input.val(c).trigger("change")});this.input.on("change"+d,function(){var c=b(this).val();c&&a.select(c)});return!0},
_unbindEvents:function(){var a=this.eventNamespace;this.input.closest("form").off(this.eventNamespaceID);this.selectBtn.off(a);this.editBtn.off(a);this.clearBtn.off(a);this.dummyInput.off(a);return!0}})})(jQuery);
