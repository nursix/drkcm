/*
 2020 (c) Sahana Software Foundation
 @license MIT
*/
(function(f,n){function h(a){this.initMatrix();a!==n&&this.applyRules(a)}h.prototype.initMatrix=function(){var a=[[],[],[],[],[],[],[]];a.forEach(function(c){for(var b=0;24>b;b++)c.push(!1)});this.matrix=a};h.prototype.applyRules=function(a){var c=this.matrix;a.forEach(function(b){if("WEEKLY"==b.f&&1==b.i){var d=b.e[0];0===d&&(d=24);b.d.forEach(function(e){for(var g=b.s[0];g<d;g++)c[e][g]=!0})}})};h.prototype.getRules=function(){var a={},c=this;this.matrix.forEach(function(p,l){c.getIntervals(p).forEach(function(k){k=
k[0]+":"+k[1];a.hasOwnProperty(k)?a[k].push(l):a[k]=[l]})});var b=[],d;for(d in a){var e=a[d],g=d.split(":");e={f:"WEEKLY",i:1,d:e,s:[parseInt(g[0]),0,0],e:[parseInt(g[1]),0,0]};b.push(e)}return b};h.prototype.setSelected=function(a,c,b){this.matrix[a][c]=!!b};h.prototype.isSelected=function(a,c){return!!this.matrix[a][c]};h.prototype.getIntervals=function(a){var c=[],b=null,d=null;a.forEach(function(e,g){e?(null===b?b=d=g:d=g,23==g&&(c.push([b,0]),b=d=null)):null!==b&&(d+=1,24==d&&(d=0),c.push([b,
d]),b=d=null)});return c};var m=0;f.widget("s3.weeklyHours",{options:{weekdays:{0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"},firstDoW:1,hours:[0,23],ticks:3,icons:"fa",iconSelected:"fa-check-square-o",iconDeselected:"fa-square-o"},_create:function(){this.id=m;m+=1;this.eventNamespace=".weeklyHours"},_init:function(){this.refresh()},_destroy:function(){this._unbindEvents();var a=f(this.raster);a&&a.remove();f(this.element).show();f.Widget.prototype.destroy.call(this)},
refresh:function(){var a=this.element;this._unbindEvents();this._deserialize(!1);var c=this._renderRaster();a.hide().after(c);this._bindEvents()},_serialize:function(){var a=f(this.element),c=this.hoursMatrix.getRules();c.length?a.val(JSON.stringify(c)):a.val("")},_deserialize:function(a){var c=f(this.element).val(),b=[];if(c)try{b=JSON.parse(c)}catch(d){}this.hoursMatrix=new h(b);a&&this._updateRaster()},_renderRaster:function(){var a=this.options,c=a.weekdays;a=a.firstDoW;for(var b=f("<table>").addClass("wh-raster").append(this._renderHeader()),
d=a;d<a+7;d++){var e=d%7;c.hasOwnProperty(e)&&b.append(this._renderRow(e))}return this.raster=b},_renderHeader:function(){var a=this.options,c=a.hours,b=0,d=23;c.constructor===Array&&2==c.length&&(b=c[0]-0,d=c[1]-0);for(c=f("<tr>").append(f("<td>"));b<d+1;b++){var e=b.toString();10>b&&(e="0"+e);e=f("<td>").addClass("wh-hour-header").text(e);var g=a.ticks;g&&0<b&&0===b%g&&e.addClass("wh-tick");c.append(e)}return f("<thead>").append(c)},_renderRow:function(a){var c=this.options,b=c.weekdays;b=f("<td>").addClass("wh-day").text(b[a]);
b=f("<tr>").append(b);var d=c.hours,e=0;c=23;d.constructor===Array&&2==d.length&&(e=d[0]-0,c=d[1]-0);for(d=e;d<c+1;d++)b.append(this._renderHour(a,d));return b},_renderHour:function(a,c){var b=this.options,d=this.hoursMatrix.isSelected(a,c);a=f("<td>").data({day:a,hour:c,selected:d}).addClass("wh-hour");if(b.icons){var e=f("<i>").addClass(b.icons);d?e.addClass(b.iconSelected):e.addClass(b.iconDeselected);a.append(e)}d?a.addClass("wh-on"):a.addClass("wh-off");(b=b.ticks)&&0<c&&0===c%b&&a.addClass("wh-tick");
return a},_updateRaster:function(){var a=this.hoursMatrix,c=this;f("td.wh-hour",this.raster).each(function(){var b=f(this),d=b.data("day"),e=b.data("hour");c._selectHour(b,a.isSelected(d,e))})},_selectHour:function(a,c){a=f(a);if(a.data("selected")!==c){a.data("selected",c);this.hoursMatrix.setSelected(a.data("day"),a.data("hour"),c);var b=this.options,d=f("i."+b.icons,a);c?(a.removeClass("wh-off").addClass("wh-on"),d.removeClass(b.iconDeselected).addClass(b.iconSelected)):(a.removeClass("wh-on").addClass("wh-off"),
d.removeClass(b.iconSelected).addClass(b.iconDeselected))}},_bindEvents:function(){var a=f(this.raster),c=this.eventNamespace,b=this;f(document).on("mouseup"+c+" touchend"+c,function(){a.off("mouseenter"+c);b._serialize()});a.on("mousedown"+c+" touchstart"+c,".wh-hour",function(d){d.preventDefault();d=f(this).trigger("focus");var e=d.hasClass("wh-off"),g=".wh-off";e||(g=".wh-on");b._selectHour(d,e);a.off("mouseenter"+c).on("mouseenter"+c,".wh-hour"+g,function(){b._selectHour(f(this),e)})});return!0},
_unbindEvents:function(){var a=f(this.raster),c=this.eventNamespace;f(document).off(c);a.off(c);return!0}})})(jQuery);
