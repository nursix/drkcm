/*
 2021 (c) Sahana Software Foundation
 @license MIT
*/
(function(d,r){var m=0;d.widget("s3.qrInput",{options:{workerPath:null,inputPattern:null,inputIndex:null,keepOriginalInput:!1},_create:function(){this.id=m;m+=1;this.eventNamespace=".qrInput"},_init:function(){this.container=d(this.element).closest(".qrinput");this.scanButton=d(".qrscan-btn",this.container);this.hiddenInput=d(this.element).siblings(".qrinput-hidden");let b=this.options.workerPath;b&&(QrScanner.WORKER_PATH=b);this.refresh()},_destroy:function(){let b=this.scanner,c=this.videoInput;
b&&(b.destroy(),this.scanner=null);c&&(c.remove(),this.videoInput=null);d.Widget.prototype.destroy.call(this)},refresh:function(){let b=d(this.element),c=this.hiddenInput,a=this;this._unbindEvents();d(".error_wrapper",this.container).appendTo(this.container);a.scanButton.length&&QrScanner.hasCamera().then(function(f){let l=a.scanButton;if(f){l.prop("disabled",!1);var e;f=d('<div class="qrinput-scan">');var n=d('<div class="qrinput-success">').html('<i class="fa fa-check">').hide().appendTo(f),p=d('<div class="qrinput-invalid">').html('<i class="fa fa-times">').hide().appendTo(f),
h=d("<video>").appendTo(f);h.css({width:"300",height:"300"});var q=f.dialog({title:"Scan QR Code",autoOpen:!1,modal:!0,classes:{"ui-dialog":"qrinput-dialog"},close:function(){e&&(e.stop(),e.destroy(),e=null)}}),t=window.navigator.vibrate;l.on("click",function(){p.hide();n.hide();h.show();q.dialog("open");e=new QrScanner(h.get(0),function(k){e.stop();h.hide();t&&window.navigator.vibrate(100);let g="";try{g=a._parse(k)}catch(u){g=!1}!1===g?(g=k="",p.show()):n.show();a.options.keepOriginalInput||(k=
g);b.val(g).trigger("change"+a.eventNamespace);c.val(k).trigger("change"+a.eventNamespace);setTimeout(function(){q.dialog("close")},400)},function(){});e.start()})}else l.prop("disabled",!0)});this._bindEvents()},_clearInput:function(){this.hiddenInput.val("").trigger("change"+this.eventNamespace);d(this.element).val("").trigger("change"+this.eventNamespace)},_parse:function(b){var c=this.options,a=c.inputPattern;if(!b||!a)return b;a=(a=(new RegExp(a,"g")).exec(b))?(c=c.inputIndex)||0===c?"string"==
typeof c?a.groups[c]:a[c]:b:!1;a===r&&(a=!1);return a},_bindEvents:function(){let b=d(this.element),c=this.eventNamespace,a=this;d(".clear-btn",b.closest(".qrinput")).off(c).on("click"+c,function(){a._clearInput()});b.off(c).on("input",function(){a.hiddenInput.val(b.val().trim())});return!0},_unbindEvents:function(){let b=d(this.element),c=this.eventNamespace;b.off(c);d(".clear-btn",b.closest(".qrinput")).off(c);return!0}})})(jQuery);
