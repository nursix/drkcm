/*
 2021 (c) Sahana Software Foundation
 @license MIT
*/
(function(c,n){var k=0;c.widget("s3.qrInput",{options:{workerPath:null,inputPattern:null,inputIndex:null},_create:function(){this.id=k;k+=1;this.eventNamespace=".qrInput"},_init:function(){this.container=c(this.element).closest(".qrinput");this.scanButton=c(".qrscan-btn",this.container);let a=this.options.workerPath;a&&(QrScanner.WORKER_PATH=a);this.refresh()},_destroy:function(){let a=this.scanner,b=this.videoInput;a&&(a.destroy(),this.scanner=null);b&&(b.remove(),this.videoInput=null);c.Widget.prototype.destroy.call(this)},
refresh:function(){let a=c(this.element),b=this;this._unbindEvents();c(".error_wrapper",this.container).appendTo(this.container);b.scanButton.length&&QrScanner.hasCamera().then(function(d){let g=b.scanButton;if(d){g.prop("disabled",!1);var e;d=c('<div class="qrinput-scan">');var l=c('<div class="qrinput-success">').html('<i class="fa fa-check">').hide().appendTo(d),f=c("<video>").appendTo(d);f.css({width:"300",height:"300"});var m=d.dialog({title:"Scan QR Code",autoOpen:!1,modal:!0,classes:{"ui-dialog":"qrinput-dialog"},
close:function(){e&&(e.stop(),e.destroy(),e=null)}});g.on("click",function(){f.show();l.hide();m.dialog("open");e=new QrScanner(f.get(0),function(h){e.stop();f.hide();l.show();window.navigator.vibrate(100);try{h=b._parse(h)}catch(p){}a.val(h).trigger("change"+b.eventNamespace);setTimeout(function(){m.dialog("close")},400)},function(){});e.start()})}else g.prop("disabled",!0)});this._bindEvents()},_clearInput:function(){c(this.element).val("").trigger("change"+this.eventNamespace)},_parse:function(a){var b=
this.options;let d=b.inputPattern;if(!a||!d)return a;(a=(new RegExp(d,"g")).exec(a))?(b=b.inputIndex,a="string"==typeof b?a.groups[b]:a[b]):a="";return a},_bindEvents:function(){let a=c(this.element),b=this.eventNamespace,d=this;c(".clear-btn",a.closest(".qrinput")).on("click"+b,function(){d._clearInput()});return!0},_unbindEvents:function(){let a=c(this.element),b=this.eventNamespace;c(".clear-btn",a.closest(".qrinput")).off(b);return!0}})})(jQuery);
