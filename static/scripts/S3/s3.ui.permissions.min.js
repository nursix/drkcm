/*
 2018-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var l=0;return function(){return l<b.length?{done:!1,value:b[l++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,l,g){if(b==Array.prototype||b==Object.prototype)return b;b[l]=g.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var l=0;l<b.length;++l){var g=b[l];if(g&&g.Math==Math)return g}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,l){var g=$jscomp.propertyToPolyfillSymbol[l];if(null==g)return b[l];g=b[g];return void 0!==g?g:b[l]};
$jscomp.polyfill=function(b,l,g,n){l&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,l,g,n):$jscomp.polyfillUnisolated(b,l,g,n))};$jscomp.polyfillUnisolated=function(b,l,g,n){g=$jscomp.global;b=b.split(".");for(n=0;n<b.length-1;n++){var p=b[n];if(!(p in g))return;g=g[p]}b=b[b.length-1];n=g[b];l=l(n);l!=n&&null!=l&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:l})};
$jscomp.polyfillIsolated=function(b,l,g,n){var p=b.split(".");b=1===p.length;n=p[0];n=!b&&n in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var a=0;a<p.length-1;a++){var c=p[a];if(!(c in n))return;n=n[c]}p=p[p.length-1];g=$jscomp.IS_SYMBOL_NATIVE&&"es6"===g?n[p]:null;l=l(g);null!=l&&(b?$jscomp.defineProperty($jscomp.polyfills,p,{configurable:!0,writable:!0,value:l}):l!==g&&(void 0===$jscomp.propertyToPolyfillSymbol[p]&&(g=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[p]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(p):$jscomp.POLYFILL_PREFIX+g+"$"+p),$jscomp.defineProperty(n,$jscomp.propertyToPolyfillSymbol[p],{configurable:!0,writable:!0,value:l})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(b){if(b)return b;var l=function(a,c){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};l.prototype.toString=function(){return this.$jscomp$symbol$id_};var g="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",n=0,p=function(a){if(this instanceof p)throw new TypeError("Symbol is not a constructor");return new l(g+(a||"")+"_"+n++,a)};return p},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(b){if(b)return b;b=Symbol("Symbol.iterator");for(var l="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),g=0;g<l.length;g++){var n=$jscomp.global[l[g]];"function"===typeof n&&"function"!=typeof n.prototype[b]&&$jscomp.defineProperty(n.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return b},"es6",
"es3");$jscomp.iteratorPrototype=function(b){b={next:b};b[Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,l){b instanceof String&&(b+="");var g=0,n=!1,p={next:function(){if(!n&&g<b.length){var a=g++;return{value:l(a,b[a]),done:!1}}n=!0;return{done:!0,value:void 0}}};p[Symbol.iterator]=function(){return p};return p};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(l){return l})}},"es6","es3");
(function(b,l){var g={rm_Add:"Add",rm_AddRule:"Add Rule",rm_AllEntities:"All Entities",rm_AllRecords:"All Records",rm_AssignedEntities:"Assigned Entities",rm_Cancel:"Cancel",rm_CollapseAll:"Collapse All",rm_ConfirmDeleteRule:"Do you want to delete this rule?",rm_Default:"default",rm_DeleteRule:"Delete",rm_ExpandAll:"Expand All",rm_NoAccess:"No access",rm_NoRestrictions:"No restrictions",rm_Others:"Others",rm_OwnedRecords:"Owned Records",rm_Page:"Page",rm_RestrictedTables:"Restricted Tables",rm_Scope:"Scope",
rm_SystemTables:"System Tables",rm_Table:"Table",rm_UnrestrictedTables:"Unrestricted Tables"},n=function(a){var c,d=a[3];d?!0!==d&&(c=d):!0!==a[2]&&(c=a[1]+"/"+(a[2]||"*"));return c},p=0;b.widget("s3.permissionEdit",{options:{fRules:!1,tRules:!1,useRealms:!1,permissions:[{l:"CREATE",b:1,o:!1},{l:"READ",b:2,o:!0},{l:"UPDATE",b:4,o:!0},{l:"DELETE",b:8,o:!0}],modules:{},models:{},defaultPermissions:{},icons:{expanded:"fa fa-caret-down",collapsed:"fa fa-caret-right"}},_create:function(){this.id=p;p+=
1;this.eventNamespace=".permissionEdit"},_init:function(){var a=b(this.element).attr("id");this.input=b("#"+a+"-input");this.tableWidth=this.options.useRealms?5:4;for(var c in g)g[c]=i18n[c]||g[c];this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=b(this.element),c=this.options;this._unbindEvents();this._deserialize();var d=this._ruleSets(),e=b(".rm-rules",a).first(),f=this,m=d.pages,k=b(".rm-page-rules",a);this._renderExpandCollapseAll().appendTo(k);
Object.keys(c.modules).sort().forEach(function(h){c.modules[h][1]&&f._ruleTable("p",h,m[h]).appendTo(k)});m._other.length&&this._ruleTable("p","_other",m._other).appendTo(k);c.tRules&&(m=d.tables,k=b(".rm-table-rules",a),this._renderExpandCollapseAll().appendTo(k),Object.keys(c.models).sort().forEach(function(h){"_system"!=h&&f._ruleTable("t",h,m[h]).appendTo(k)}),this._ruleTable("t","_system",m._system).appendTo(k),m._other.length&&this._ruleTable("t","_other",m._other).appendTo(k));e.tabs().removeClass("hide").show();
this._bindEvents()},_deserialize:function(){try{this.rules=JSON.parse(this.input.val())}catch(a){this.rules=[],this._serialize()}},_serialize:function(){var a=this.rules.filter(function(c){return null!==c[0]&&(0!==c[0]||!c[7])});this.input.val(JSON.stringify(a)).change()},_ruleSets:function(){var a={_other:[]},c={_other:[]},d=this.options;this.rules.forEach(function(e){var f;if(f=e[3]){var m=c;var k=d.models;f=f.split("_")[0]}else{m=a;k=d.modules;f=e[1];var h=e[2];f="default"!=f||"table"!=h&&"tables"!=
h?f:"default/dt"}k.hasOwnProperty(f)?m[f]===l&&(m[f]=[]):f="_other";m[f].push(e)});return{pages:a,tables:c}},_renderExpandCollapseAll:function(){var a=b('<span class="action-lnk rm-expand-all">'),c=b('<span class="action-lnk rm-collapse-all">');a.text(g.rm_ExpandAll);c.text(g.rm_CollapseAll);return b('<div class="rm-toggle-all">').append(a).append(c)},_ruleTable:function(a,c,d){d||(d=[]);var e=b('<table class="rm-module-rules">').data({module:c});e.append(this._ruleTableHeader(c)).append(this._ruleTableBody(a,
c,d)).append(this._ruleTableFooter(a,c,d));this._indicateNumRules(e,d.length);return e},_ruleTableHeader:function(a){var c=b('<thead class="rm-module-header">'),d=b("<th>").attr("colspan",this.tableWidth),e=this.options.icons;if(e){var f=b('<i class="'+e.expanded+'">').hide();e=b('<i class="'+e.collapsed+'">');b('<div class="rm-module-toggle">').append(f).append(e).appendTo(d)}switch(a){case "_system":f="SYSTEM";a=g.rm_SystemTables;break;case "_other":f="*";a=g.rm_Others;break;case "s3dt":f="S3DT";
a=g.rm_DynamicTables;break;default:f="default/dt"==a?"DEFAULT":a.toLocaleUpperCase(),a=this.options.modules.hasOwnProperty(a)?this.options.modules[a][0]:""}b('<div class="rm-module-prefix">').text(f).appendTo(d);b('<div class="rm-module-title">').text(a).appendTo(d);b('<div class="rm-module-numrules">').appendTo(d);b("<tr>").append(d).appendTo(c);return c},_ruleTableBody:function(a,c,d){var e=this.options,f=b("<tbody>").hide(),m=!0,k=d.map(n);if("t"==a){if(c=e.models[c])for(var h in c)c[h]&&-1==k.indexOf(h)&&
d.push([null,null,null,h,null,null,null,!1]);k=g.rm_Table;0===d.length&&(m=!1,f.append(this._defaultRule(!1)))}else{h="default/dt"==c;var r;for(r in e.defaultPermissions)if((a=h?"default/tables"==r||"default/table"==r:r.slice(0,c.length+1)==c+"/")&&-1==k.indexOf(r)){a=r.split("/");var v=a[1];if("*"==v)v=null;else if(!e.fRules)continue;d.push([null,a[0],v,null,null,null,null,!1])}k=g.rm_Page;0===d.length&&(m=!1,f.append(this._defaultRule(!0)))}c=b('<tr class="rm-rule-labels">').hide().appendTo(f);
c.append("<th>"+k+"</th>").append("<th>"+g.rm_AllRecords+"</th>").append("<th>"+g.rm_OwnedRecords+"</th>");e.useRealms&&b("<th>").text(g.rm_Scope).appendTo(c);c.append("<th></th>");if(m){c.show();d=d.sort(function(q,t){q=q.slice(1,4).join(" ");t=t.slice(1,4).join(" ");return q===t?0:q>t&&1||-1});var u=this;d.forEach(function(q){u._ruleTableRow(q).appendTo(f)})}return f},_ruleTableFooter:function(a,c,d){var e=b("<tfoot>").hide();if("_other"!=c){c=b('<tr class="rm-module-add">');var f=b("<td>").attr("colspan",
this.tableWidth);b('<span class="action-lnk rm-add-rule">').text(g.rm_AddRule).appendTo(f);"t"!=a&&!this.options.fRules&&d.length&&c.hide();c.append(f).appendTo(e)}return e},_ruleTableRow:function(a){var c=b('<tr class="rm-rule">').data({rule:a}),d=this.options,e=n(a);if(e)b('<td class="rm-rule-target">').text(e).appendTo(c);else{var f=this._targetSelector(a);b('<td class="rm-rule-target">').append(f).appendTo(c)}e&&null===a[0]?(c.addClass("rm-default-permissions"),a=this._defaultPermissions(e),a.oACL?
(b("<td>").text(a.uACL).appendTo(c),b("<td>").text(a.oACL).appendTo(c)):b("<td>").attr("colspan",2).text(a.uACL).appendTo(c),d.useRealms&&b("<td>").appendTo(c),d=b('<a class="rm-add-rule action-lnk">'),b("<td>").append(d.text(g.rm_AddRule)).appendTo(c)):(f=this._permissionSelector(a),c.append(f.uACL).append(f.oACL),d.useRealms&&b("<td>").append(this._scopeSelector(a)).appendTo(c),e?(d=b('<a class="rm-delete-rule delete-btn-ajax">'),b("<td>").append(d.text(g.rm_DeleteRule)).appendTo(c)):(d=b('<a class="rm-submit-rule action-btn">'),
a=b('<span class="rm-cancel-add action-lnk">'),b("<td>").append(d.text(g.rm_Add)).append(a.text(g.rm_Cancel)).appendTo(c)));return c},_targetSelector:function(a){var c=this.options,d=b("<div>"),e=a[1],f=function(q,t){t===l&&(t=q);return b('<option value="'+q+'">').text(t)},m=function(){return b('<option value="">').prop("selected",!0).prop("disabled",!0).hide()};if(a[3]){var k=c.models[e],h=b("<optgroup>").attr("label",g.rm_RestrictedTables),r=b("<optgroup>").attr("label",g.rm_UnrestrictedTables),
v=0,u=0;Object.keys(k).sort().forEach(function(q){k[q]?(v+=1,h.append(f(q))):(u+=1,r.append(f(q)))});a=b("<select>").append(m());v&&a.append(h);u&&a.append(r)}else"_other"==e?(a=b('<input type="text" size="20">'),a.data("pattern",/^(\w+)(\/(\*|[\w]+))?$/)):"default/dt"==e?(a=b("<select>"),a.append(m()).append(f("default/table")).append(f("default/tables"))):(d.append("<span>"+e+" / </span>"),a=b('<input type="text" size="10">'),a.data("pattern",/^(\w+|\*)$/));a.addClass("rm-target-select").appendTo(d);
return d},_validateTarget:function(a){var c=a.val(),d=a.data("pattern");d.lastIndex=0;if(c&&d&&!d.exec(c))return a.addClass("rm-invalid"),!1;a.removeClass("rm-invalid");return!0},_defaultPermissions:function(a){var c=this.options,d=c.defaultPermissions[a];a={};var e=" ("+g.rm_Default+")";if(d!==l){var f=d[0];d=d[1]&~f;var m=function(k){var h=[];c.permissions.forEach(function(r){k&r.b&&h.push(r.l)});return h.join(", ")};f&&(a.uACL=m(f)+e);d&&(a.oACL=m(d)+e)}a.uACL||(a.uACL=g.rm_NoAccess+e);return a},
_defaultRule:function(a){a=a?g.rm_NoAccess:g.rm_NoRestrictions;a=b("<td>").attr("colspan",this.tableWidth).text(a);return b('<tr class="rm-default-rule">').append(a)},_permissionSelector:function(a){var c=b('<td class="rm-permission-all">'),d=b('<td class="rm-permission-own">');this.options.permissions.forEach(function(e){var f=b('<input class="rm-permission" type="checkbox">'),m=b('<input class="rm-permission" type="checkbox">');b("<label>").append(f).append(e.l).appendTo(c);b("<label>").append(m).append(e.l).css({visibility:e.o&&
"visible"||"hidden"}).appendTo(d);var k=a[5]&e.b;m.prop("checked",k);m.data({bit:e.b,selected:k,implied:!1});k=a[4]&e.b;f.prop("checked",k);f.data({bit:e.b,selected:k,implied:!1});m.data("implied",k);k&&m.prop({checked:!0,disabled:!0});f.data("imply",m)});return{uACL:c,oACL:d}},_scopeSelector:function(a){var c=b('<select class="rm-scope-select">'),d=b('<option value="">').text(g.rm_AssignedEntities),e=b('<option value="any">').text(g.rm_AllEntities);if(a)switch(a[6]){case "any":e.prop("selected",
!0);break;default:d.prop("selected",!0),a[6]=null}c.append(d).append(e);return b("<div>").append(c)},_addRule:function(a){var c=this.options,d=a.closest(".rm-module-rules"),e=d.data("module"),f=c.models[e],m=this;b("tfoot .rm-rule",b(this.element)).each(function(){m._cancelAdd(b(this))});var k=a.closest(".rm-rule");if(k.length){var h=k.data("rule");h=(a=h[3])?[0,null,null,a,0,0,null,!1]:[0,h[1],h[2],null,0,0,null,!1];if(c=c.defaultPermissions[n(h)])h[4]=c[0],h[5]=c[1];this.rules.push(h);c=this._ruleTableRow(h);
k.after(c).remove();a&&(f[a]+=1);this._serialize()}else f=!0,a.closest(".rm-table-rules").length?h=[0,e,null,!0,0,0,null,!1]:c.fRules?h=[0,e,!0,null,0,0,null,!1]:b("tbody .rm-rule",d).length||(h=[0,e,null,null,0,0,null,!1],f=!1),h&&(c=this._ruleTableRow(h),f?a.closest(".rm-module-add").hide().after(c):(this.rules.push(h),b("tbody",d).append(c),a.closest(".rm-module-add").hide())),b(".rm-default-rule",d).hide(),b(".rm-rule-labels",d).show()},_submitAdd:function(a){var c=a.closest(".rm-module-rules"),
d=a.data("rule"),e=null,f=null,m=null,k=b(".rm-target-select",a).val().replace(/\s/,"");if(d[3]){if(m=k,!m)return}else{e=d[1];f=k;var h="_other"==e;if("default/dt"==e||h){if(k=/^(\w+)(\/(\*|[\w]+))?$/.exec(k))e=k[1],f=k[3];else return;if(h)for(h=b(".rm-module-rules",a.closest(".rm-page-rules")),k=h.length;k--;){var r=b(h[k]);if(r.data("module")==e){c=r;break}}}if(!f||"*"==f)f=null;else if(!/^\w+$/.exec(f))return}d[1]=e&&e.toLowerCase();d[2]=f&&f.toLowerCase();d[3]=m&&m.toLowerCase();var v,u,q;b("tbody .rm-rule",
c).each(function(){var t=b(this),w=t.data("rule");if(!v){a:{var x=null===d[0]||null===w[0]?[1,2,3]:[1,2,3,6];for(var z=x.length,y;z--;)if(y=x[z],d[y]!==w[y]){x=!1;break a}x=!0}x?(u=w,q=v=t):q||(m?w[3]>m&&(q=t):w[2]&&(f&&w[2]>f||!f)&&(q=t))}});if(u&&null!==u[0])u.splice(1,d.length-1),u.push.apply(u,d.slice(1)),d=u;else if(this.rules.push(d),e=d[3])h=this.options.models[c.data("module")],h[e]=h[e]!==l?h[e]+1:1;this._serialize();e=this._ruleTableRow(d);q?e.insertBefore(q):e.appendTo(b("tbody",c));v&&
v.remove();this._indicateNumRules(c,b("tbody .rm-rule",c).length);a.siblings(".rm-module-add").show();a.remove()},_cancelAdd:function(a){var c=a.closest(".rm-module-rules");0===b("tbody .rm-rule",c).length&&(b(".rm-rule-labels",c).hide(),b(".rm-default-rule",c).show());a.siblings(".rm-module-add").show();a.remove()},_updateRule:function(a,c){if(a=a.data("rule")){for(var d in c){var e=c[d];if(e!==l)switch(d){case "c":a[1]=e;break;case "f":a[2]=e;break;case "t":a[3]=e;break;case "uACL":a[4]=e;break;
case "oACL":a[5]=e;break;case "scope":a[6]=e;break;case "deleted":a[7]=!!e}}this._serialize()}},_deleteRule:function(a){if(confirm(g.rm_ConfirmDeleteRule)){var c=this.options,d=a.closest(".rm-module-rules"),e=!1,f=a.data("rule");f[7]=!0;this._serialize();var m=f[3];if(m){var k=this.rules.filter(function(h){return h[3]==m&&!h[7]});k.length||(k=d.data("module"),c=c.models[k],--c[m],0<c[m]&&(c=[null,null,null,m,null,null,null,!1],this._ruleTableRow(c).insertBefore(a)))}else k=this.rules.filter(function(h){return h[1]==
f[1]&&h[2]==f[2]&&!h[7]}),!k.length&&c.defaultPermissions[n(f)]&&(c=[null,f[1],f[2],null,null,null,null,!1],this._ruleTableRow(c).insertBefore(a)),e=!0;c=b(".rm-rule",d).length-1;c||(this._defaultRule(e).insertBefore(a),b(".rm-rule-labels",d).hide(),b(".rm-module-add",d).show());this._indicateNumRules(d,c);a.remove()}},_updatePermissions:function(a){this._updateRule(a,{uACL:this._getPermissions(b(".rm-permission-all",a)),oACL:this._getPermissions(b(".rm-permission-own",a))})},_getPermissions:function(a){var c=
0;b(".rm-permission",a).each(function(){var d=b(this);!d.data("implied")&&d.data("selected")&&(d=d.data("bit"))&&(c|=d)});return c},_indicateNumRules:function(a,c){var d=b(".rm-module-numrules",a);c?(d.text("["+c+"]"),a.addClass("hasrules")):(d.empty(),a.removeClass("hasrules"))},_toggleRuleTable:function(a){a.hasClass("rm-expanded")?(b("tbody, tfoot",a).hide(),a.removeClass("rm-expanded")):(b("tbody, tfoot",a).show(),a.addClass("rm-expanded"));b(".rm-module-toggle i",a).toggle()},_toggleAll:function(a,
c){var d=this;c?b(".rm-module-rules:not(.rm-expanded)",a).each(function(e,f){d._toggleRuleTable(b(f))}):b(".rm-module-rules.rm-expanded",a).each(function(e,f){d._toggleRuleTable(b(f))})},_permissionChanged:function(a){if(a.data("implied"))a.prop({checked:!0,disabled:!0});else if(a.prop("disabled"))a.prop({disabled:!1,checked:a.data("selected")});else{var c=a.prop("checked"),d=a.data("imply");a.data({selected:c});d&&d.length&&d.data("implied",c).change()}this._updatePermissions(a.closest(".rm-rule"))},
_scopeChanged:function(a){var c=a.closest(".rm-rule").data("rule");switch(a.val()){case "any":c[6]="any";break;default:c[6]=null}this._serialize()},_bindEvents:function(){var a=b(this.element),c=this.eventNamespace,d=this;b(".rm-table-rules, .rm-page-rules",a).on("click"+c,".rm-expand-all",function(){d._toggleAll(b(this).closest(".rm-table-rules, .rm-page-rules"),!0);return!1}).on("click"+c,".rm-collapse-all",function(){d._toggleAll(b(this).closest(".rm-table-rules, .rm-page-rules"),!1);return!1});
b(".rm-module-rules",a).on("click"+c,".rm-module-header",function(){d._toggleRuleTable(b(this).closest(".rm-module-rules"));return!1}).on("change"+c,".rm-permission",function(){d._permissionChanged(b(this));return!1}).on("change"+c,".rm-scope-select",function(){d._scopeChanged(b(this));return!1}).on("click"+c,".rm-delete-rule",function(){d._deleteRule(b(this).closest(".rm-rule"));return!1}).on("click"+c,".rm-add-rule",function(){d._addRule(b(this))}).on("click"+c,".rm-cancel-add",function(){d._cancelAdd(b(this).closest(".rm-rule"))}).on("click"+
c,".rm-submit-rule",function(){d._submitAdd(b(this).closest(".rm-rule"))}).on("input"+c,"input.rm-target-select",function(){d._validateTarget(b(this))});return!0},_unbindEvents:function(){var a=b(this.element),c=this.eventNamespace;b(".rm-module-rules, .rm-table-rules, .rm-page-rules",a).off(c);return!0}})})(jQuery);
