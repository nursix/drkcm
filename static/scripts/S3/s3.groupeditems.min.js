/*
 2015-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(f,r){var q=0;f.widget("s3.groupedItems",{options:{ajaxURL:null,renderGroupHeaders:!1,totalsLabel:"TOTAL"},_create:function(){f(this.element);this.id=q;q+=1;this.eventNamespace=".groupeditems"},_init:function(){var a=f(this.element);this.widget_id=a.attr("id");this.items=a.find(".gi-data").first();this.refresh()},_destroy:function(){f.Widget.prototype.destroy.call(this)},refresh:function(){var a=f(this.element);a.find(".gi-throbber").show();this._unbindEvents();this.data||this._deserialize();
var b=this.data,c=a.find(".gi-table");b.e?(c.hide(),c.empty(),a.find(".gi-empty").show()):(a.find(".gi-empty").hide(),c.empty(),b=this._renderTable(b),c.append(b).show());this._bindEvents();a.find(".gi-throbber").css("visibility","hidden")},_renderTable:function(a){var b=f('<table class="groupeditems">');this._renderTableHeader(a).appendTo(b);this._renderGroup(b,a);this._renderTableFooter(a).appendTo(b);return b},_renderTableHeader:function(a){var b=f("<thead>"),c=f('<tr class="gi-column-headers">').appendTo(b),
d=a.c;a=a.l;for(var g,h=0,k=d.length;h<k;h++)g=a[d[h]],f("<th>").html(g).appendTo(c);return b},_renderTableFooter:function(a){var b=this.options,c=f("<tfoot>"),d=f('<tr class="gi-column-totals">'),g=a.t,h=!1;for(l in g){h=!0;break}if(h){a=a.c;for(var k=null,e=0,p=0,n=a.length;p<n;p++){if(!k){if(!g.hasOwnProperty(a[p])){e++;continue}1<e&&(k=f('<td class="gi-column-totals-label" colspan="'+e+'">'),f("<span> "+b.totalsLabel+"</span>").appendTo(k),k.appendTo(d))}var l=f("<td>").appendTo(d);(h=g[a[p]])&&
l.html(h)}d.appendTo(c)}return c},_renderGroup:function(a,b,c,d){"undefined"==typeof c&&(c=b);"undefined"==typeof d&&(d=0);this.options.renderGroupHeaders&&0<d&&this._renderGroupHeader(a,b,c,d);var g=c.d,h=c.i,k;if(g){var e=0;for(k=g.length;e<k;e++)this._renderGroup(a,b,g[e],d+1)}else if(h)for(e=0,k=h.length;e<k;e++)this._renderItem(a,b,h[e],d);0<d&&this._renderGroupFooter(a,b,c,d)},_renderGroupHeader:function(a,b,c,d){b=b.c;c=c.v;d=f('<tr class="gi-group-header gi-level-'+d+'">');f('<td colspan="'+
b.length+'">').html(c).appendTo(d);d.appendTo(a)},_renderGroupFooter:function(a,b,c,d){var g=this.options,h=c.t,k=!1;for(e in h){k=!0;break}b=b.c;c=c.v;d=f('<tr class="gi-group-footer gi-level-'+d+'">');if(!k&&!g.renderGroupHeaders)f('<td colspan="'+b.length+'">').html(c).appendTo(d),d.appendTo(a);else if(k){k=0;var e=null;for(var p,n,l=0,m=b.length;l<m;l++){if(!e){if(!h.hasOwnProperty(b[l])){k++;continue}1<k&&(e=f('<td class="gi-group-footer-label" colspan="'+k+'">'),g.renderGroupHeaders||e.html(c),
f('<span class="gi-group-footer-inline-label"> '+g.totalsLabel+"</span>").appendTo(e),e.appendTo(d))}n=f("<td>").appendTo(d);(p=h[b[l]])&&n.html(p)}d.appendTo(a)}},_renderItem:function(a,b,c,d){d=f('<tr class="gi-item gi-level-'+d+'">');b=b.c;for(var g,h,k=0,e=b.length;k<e;k++)h=f("<td>"),(g=c[b[k]])&&h.html(g),h.appendTo(d);d.appendTo(a)},reload:function(a,b,c){c="undefined"!=typeof c?c:!0;"undefined"==typeof b&&(b=this._getFilters());var d=this,g=!1;f(this.element).find(".gi-throbber").css("visibility",
"visible");if(a||b)g=this._updateAjaxURL(a,b);g||c?f.ajax({url:this.options.ajaxURL,dataType:"json"}).done(function(h){d.items.val(JSON.stringify(h));d.data=null;d.refresh()}).fail(function(h,k,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:h.responseText;console.log(msg)}):d.refresh()},_getFilters:function(){var a=f("#"+this.widget_id+"-filter-form");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(b){return null}},_updateAjaxURL:function(a,b){var c=this.options.ajaxURL;if(!c)return!1;
var d=c.split("?");if(1<d.length){var g=d[1];var h=g.split("&")}else h=[];var k=[];c=!1;if(a)for(var e in a)g=a[e],g=e+"="+g,c||-1!=f.inArray(g,h)||(c=!0),k.push(g);e={};g={};var p;if(b){var n=0;for(p=b.length;n<p;n++){var l=b[n];var m=l[0];l=l[1];null===l?e[m]||(g[m]=!0):(g[m]&&(g[m]=!1),l=m+"="+encodeURIComponent(l),e[m]?e[m].push(l):e[m]=[l])}}n=0;for(p=h.length;n<p;n++)l=h[n].split("="),1<l.length&&(m=decodeURIComponent(l[0]),l=decodeURIComponent(l[1]),g[m]?c=!0:e[m]?c||-1!=f.inArray(m+"="+l,
e[m])||(c=!0):a&&a.hasOwnProperty(m)||k.push(h[n]));for(m in e)for(n=0,p=e[m].length;n<p;n++)c||-1!=f.inArray(e[m][n],h)||(c=!0),k.push(e[m][n]);a=k.join("&");b=d[0];a&&(b=b+"?"+a);this.options.ajaxURL=b;return c},_serialize:function(){var a=this.items;if(a){var b="";this.data&&(b=JSON.stringify(this.data));a.val(b)}return b},_deserialize:function(){this.data={};var a=this.items;a&&(a=a.val())&&(this.data=JSON.parse(a));return this.data},_bindEvents:function(){var a=this;f(this.element).on("click"+
this.eventNamespace,".gi-export",function(){var b=f(this).data("url"),c=a._getFilters();c&&(b=S3.search.filterURL(b,c));window.open(b)})},_unbindEvents:function(){f(this.element).off(this.eventNamespace)}})})(jQuery);
