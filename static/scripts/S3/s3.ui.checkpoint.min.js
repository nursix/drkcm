/*
 2016-2023 (c) Sahana Software Foundation
 @license MIT
*/
(function(b,q){var r=0;b.widget("dvr.checkPoint",{options:{tablename:"case_event",ajaxURL:"",multiPreselectAll:!0,showPicture:!0,showPictureText:"Show Picture",hidePictureText:"Hide Picture",selectAllText:"Select All",noEventsLabel:"No event types available",selectEventLabel:"Please select an event type"},_create:function(){this.id=r;r+=1;this.eventNamespace=".checkPoint"},_init:function(){var a=b(this.element),d=a.attr("id");this.idPrefix="#"+this.options.tablename;this.orgHeader=b("#"+d+"-org-header");
this.orgSelect=b("#"+d+"-org-select");this.eventTypeHeader=b("#"+d+"-event-type-header");this.eventTypeSelect=b("#"+d+"-event-type-select");this.pictureContainer=b("#"+d+"-picture");d=this.idPrefix;this.personRow=b(d+"_person__row",a);this.flagInfoRow=b(d+"_flaginfo__row",a);this.detailsRow=b(d+"_details__row",a);this.familyRow=b(d+"_family__row",a);this.personContainer=b(".controls",this.personRow);this.flagInfoContainer=b(".controls",this.flagInfoRow);this.detailsContainer=b(".controls",this.detailsRow);
this.familyContainer=b(".controls",this.familyRow);this.eventType=a.find('input[type="hidden"][name="event"]');this.flagInfo=b("input[type=hidden][name=flags]",a);this.familyInfo=b("input[type=hidden][name=familyinfo]",a);this.blockingInfo=b('input[type="hidden"][name="intervals"]',a);this.imageURL=b('input[type="hidden"][name="image"]',a);this.actionDetails=b('input[type="hidden"][name="actions"]',a);this.permissionInfo=a.find("input[type=hidden][name=permitted]");this.actionableInfo=a.find("input[type=hidden][name=actionable]");
this.submitLabel=a.find(".submit-btn").first().val();this.profilePicture=null;this.blockedEvents=(a=this.blockingInfo.val())?JSON.parse(a):{};this.blockingMessage=null;this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options;this._unbindEvents();if(!a.ajaxURL)throw Error("checkPoint: no ajaxURL provided");this._clearForm();this._updateEventType();this._bindEvents()},_checkID:function(){var a=this.orgHeader.data("selected");this._clearForm(!1,
!0);var d=b(this.element);let e=this.idPrefix,c=b(e+"_label"),g=c.val().trim();c.val(g);if(g){a={a:"check",k:b('input[type=hidden][name="_formkey"]',d).val(),l:g,o:a,t:null};d=this.options.ajaxURL;var l=b('<div class="inline-throbber">').insertAfter(this.personContainer),k=this;b.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(a),success:function(h){l.remove();h.a&&b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+
h.a+"</div></div>").hide().insertAfter(b(e+"_label").closest(".controls")).slideDown("fast");if(h.p){k._showPerson(h.p);h.b&&(k.imageURL.val(h.b),k.profilePicture=h.b,k._showProfilePicture());var f=k.flagInfo;h.f?f.val(JSON.stringify(h.f)):f.val("[]");f=k.permissionInfo;h.s!==q?f.val(JSON.stringify(h.s)):f.val("false");f=k.actionableInfo;var m=h.u;f.length&&(m!==q?f.val(JSON.stringify(h.u)):(m=!0,f.val("true")));h.d&&k._updateDetails(h.d,m);k.familyInfo.val(JSON.stringify(h.x||[]));k._showFamily();
k.blockedEvents=h.i||{};k.blockingInfo.val(JSON.stringify(k.blockedEvents));k.eventType.val()&&k._toggleSubmit(!0);k._showFlagInfo()}h.e&&S3.showAlert(h.e,"error");h.w&&S3.showAlert(h.w,"warning");h.c&&S3.showAlert(h.c,"success")},error:function(){l.remove();k._clearForm(!0,!1)}})}},_registerEvent:function(){var a=this.orgHeader.data("selected");this._clearAlert();var d=b(this.element);let e=this.idPrefix;var c=b(e+"_label");let g=c.val().trim(),l=this.eventType.val();c.val(g);if(g&&l){a={a:"register",
k:b('input[type=hidden][name="_formkey"]',d).val(),l:g,o:a,t:l};d=this.options.ajaxURL;c=b(e+"_person__row .controls");var k=b('<div class="inline-throbber">').insertAfter(c),h=this;c=b(".family-members",this.familyContainer);if(c.length){let f=[];b(".family-member",c).each(function(){var m=b(this);m.find("input.member-select").prop("checked")&&(m=m.data("member").l)&&f.push(m)});a.l=f}c=this.actionDetails;c.length&&(c=c.val(),a.d=c?JSON.parse(c):[]);a.c=b(e+"comments").val();b.ajaxS3({url:d,type:"POST",
dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(a),success:function(f){k.remove();f.a?b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+f.a+"</div></div>").hide().insertAfter(b(e+"_label")).slideDown("fast"):h._clearForm();f.e?S3.showAlert(f.e,"error",!1):f.c&&S3.showAlert(f.c,"success",!1)},error:function(){k.remove();this._clearForm(!0)}})}},_checkBlockedEvents:function(){var a=this.eventType.val();a=this.blockedEvents[a];
var d=this;this.blockingMessage&&this.blockingMessage.remove();var e=function(c,g){let l=!0;if(c&&(!g||!c[2])){g=b("<h6>").addClass("event-registration-blocked").html(c[0]);c=c[1]?new Date(c[1]):null;let k=new Date;if(null===c||c>k)d.blockingMessage=b("<div>").addClass("small-12-columns").append(g).prependTo(b("#submit_record__row")),l=!1}return l};return b(".family-members",this.familyContainer).length?(a=e(a,!0),!!this._updateFamilyStatus(a)):e(a,!1)},_showPerson:function(a){this.personRow.show();
this.personContainer.empty().html(a).removeClass("hide").show()},_removePerson:function(){this.personRow.hide();this.personContainer.empty()},_showFlagInfo:function(){this.flagInfoRow.hide();var a=this.flagInfo;let d=this.flagInfoContainer.empty().removeClass("has-flaginfo");a=a.length?JSON.parse(a.val()):[];if(a.length){this.flagInfoRow.removeClass("hide").show();d.addClass("has-flaginfo");let e=b('<div class="checkpoint-advise">').hide();a.forEach(function(c){let g=b('<div class="checkpoint-instructions">').appendTo(e);
b("<h4>"+c.n+"</h4>").appendTo(g);c.i&&b("<p>"+c.i+"</p>").appendTo(g)});e.appendTo(d).slideDown("fast")}},_removeFlagInfo:function(){this.flagInfoRow.hide();this.flagInfoContainer.empty();this.flagInfo.val("[]")},_showProfilePicture:function(){var a=b(this.element),d=this.options,e=this.profilePicture;this._removeProfilePicture();if(e){var c=b('<button class="small secondary button toggle-picture" type="button">'),g=b('<div class="button-row">').append(c);c.text(d.showPictureText);c=this.pictureContainer;
c.length||(this.pictureContainer=c=b('<div class="panel profile-picture">').appendTo(a));c.append(g).data("url",e);d.showPicture&&this._togglePicture()}},_removeProfilePicture:function(){this.profilePicture=null;this.pictureContainer.empty()},_togglePicture:function(){b(this.element);var a=this.options,d=this.pictureContainer;if(d.length){var e=d.find(".image-row"),c=d.data("url"),g=d.find("button.toggle-picture");e.length?(e.remove(),g.text(a.showPictureText)):c&&(e=b("<img>").attr("src",c),e=b('<div class="image-row">').append(e),
d.prepend(e),g.text(a.hidePictureText))}},_updatePictureButtons:function(){b(this.element);var a=this.pictureContainer,d=a.data("url");b("button.member-show-picture").removeClass("showing");b(".member-caption").remove();d&&b(".family-member").each(function(){var e=b(this),c=e.data("member");c.p==d&&(e.find("button.member-show-picture").addClass("showing"),a.find(".button-row").before(b('<div class="member-caption">'+c.n+"</div>")))})},_showDetails:function(a){this.detailsRow.show();b(this.idPrefix+
"_details__row").show()},_hideDetails:function(){this.personContainer.text()?this.detailsRow.show():this.detailsRow.hide()},_updateDetails:function(a,d){var e=this.idPrefix;b(e+"_details__row .controls");b(e+"_date__row .controls");var c=this.actionDetails;c.length&&(""!==a.h?c.val(JSON.stringify(a.h)):c.val("[]"));b(e+"_details__row .controls").html(a.d);b(e+"_date__row .controls").html(a.t);this._showDetails(d)},_removeDetails:function(){var a=this.idPrefix;this._hideDetails();this.flagInfo.val("[]");
this.permissionInfo.val("false");b(a+"_flaginfo__row .controls").empty();b(a+"_details__row .controls").empty();b(a+"_date__row .controls").empty();b(a+"_comments").val("");this.blockedEvents={};this.blockingMessage&&this.blockingMessage.remove();this.blockingInfo.val(JSON.stringify(this.blockedEvents))},_showFamily:function(){var a=this._getEventType();if(a&&a.multiple&&(a=this.familyInfo,a.length)){var d=JSON.parse(a.val());a=this.familyContainer.empty();if(d.length){this.familyRow.show();let e=
b('<table class="family-members">').hide();d.forEach(function(c){this._renderFamilyMember(c).appendTo(e)},this);d=this.options;b('<tr class="family-all">').append(b('<td><input class="member-select-all" type="checkbox"/></td>')).append(b('<td colspan="2">'+d.selectAllText+"</td>")).appendTo(e);e.appendTo(a).slideDown("fast")}else this.familyRow.hide()}},_hideFamily:function(){this.familyContainer.empty();this.familyRow.hide();this.profilePicture=this.imageURL.val();this._showProfilePicture()},_removeFamily:function(){this.familyInfo.val("[]");
this.familyContainer.empty();this.familyRow.hide()},_renderFamilyMember:function(a){var d=this.options,e=b('<input class="member-select" type="checkbox">'),c=b('<div class="medium-4 small-12 columns member-id">'+a.l+"</div>"),g=b('<div class="medium-8 small-12 columns member-name">'+a.n+" ("+a.d+")</div>");g=b('<div class="member-info row">').append(c).append(g);c=b('<div class="member-show-picture">');a.p&&b('<button class="tiny secondary button fright member-show-picture" type="button">'+d.showPictureText+
"</button>").appendTo(c);d=b("<td>").append(e);e=b('<td class="member-info">').append(g);c=b("<td>").append(c);return b('<tr class="family-member">').data("member",a).append(d).append(e).append(c)},_updateFamilyStatus:function(a){let d=this.familyContainer,e=b(".family-member",d),c=this.options.multiPreselectAll,g=0,l=this.eventType.val(),k=this._getEventType(),h=new Date;if(k&&k.multiple)return!e.length&&this.familyInfo.val()&&this._showFamily(),b(".family-member",d).each(function(){var f=b(this),
m=f.data("member"),n=m.r,p=!a,t="";if(n&&n.hasOwnProperty(l)){n=n[l];var u=n[1]?new Date(n[1]):null;if(null===u||u>h)p=!0,t=b('<div class="member-message">'+n[0]+"</div>")}f.find(".member-message").remove();p?(f.removeClass("member-selected"),b(".member-select",f).each(function(){b(this).prop("checked",!1).prop("disabled",!0)}),f.addClass("member-blocked"),p=b('<div class="member-message row">'),b('<div class="columns">').append(t).appendTo(p),f.find(".member-info.row").after(p)):(g++,f.removeClass("member-blocked"),
b(".member-select",f).each(function(){b(this).prop("disabled",!1).prop("checked",!(!c&&!m.s));f.addClass("member-selected")}))}),this._updateSelectAll(),this._updatePictureButtons(),g;this._hideFamily();this._updateSelectAll()},_updateSelectAll:function(){var a=0,d=0,e=!0;b(".member-select").each(function(){var g=b(this);g.prop("disabled")||(a++,g.prop("checked")?d++:e=!1)});var c=b(".member-select-all");a?c.prop("disabled",!1).prop("checked",e):c.prop("checked",!1).prop("disabled",!0);c=b(".submit-btn");
b(".member-select").length?(c.val(this.submitLabel+" ("+d+")"),d?c.prop("disabled",!1):c.prop("disabled",!0)):c.val(this.submitLabel)},_selectAll:function(a){var d=0;b(".member-select").each(function(){var e=b(this);e.prop("disabled")||(a?(e.prop("checked",!0).closest("tr.family-member").addClass("member-selected"),d++):e.prop("checked",!1).closest("tr.family-member").removeClass("member-selected"))});this._updateSelectAll()},_toggleSubmit:function(a){var d=b(this.element),e=[".check-btn",".submit-btn"],
c=this.permissionInfo,g=this.actionableInfo;if(a){var l=a=!1;c.length&&(c=c.val())&&(a=JSON.parse(c));a&&(l=!0,g.length&&(g=g.val())&&(l=JSON.parse(g)));a&&l&&(l=this._checkBlockedEvents());a&&l&&e.reverse()}c=d.find(e[0]);d.find(e[1]).prop("disabled",!0).hide().insertAfter(c);c.prop("disabled",!1).hide().removeClass("hide").show()},_clearAlert:function(){b(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast");b(".error_wrapper").fadeOut("fast").remove()},_clearForm:function(a,
d){b(".inline-throbber").remove();a||this._clearAlert();d||b(this.idPrefix+"_label").val("");this._removePerson();this._removeFlagInfo();this._removeDetails();this._removeFamily();this._removeProfilePicture();this.blockingMessage&&this.blockingMessage.remove();this.imageURL.val("");b(".submit-btn").val(this.submitLabel);this._toggleSubmit(!1);a=b(this.idPrefix+"_label");a.trigger("focus").val(a.val())},_getEventType:function(){let a=this.eventType.val();if(!a)return null;let d=b("a.event-type-select",
this.eventTypeSelect).filter(function(){return b(this).data("code")==a});return d.length?{code:d.data("code")||null,name:d.data("name")||null,multiple:"T"==d.data("multiple")}:null},_setEventType:function(a,d){b('input[type="hidden"][name="event"]').val(a);b(".event-type-name",this.eventTypeHeader).text(d);this._updateEventType();this._updateFamilyStatus();b(this.idPrefix+"_person__row .controls").text()&&this._toggleSubmit(!0)},_clearEventType:function(){b('input[type="hidden"][name="event"]').val("");
this._updateEventType();this._toggleSubmit(!1)},_updateEventType:function(){let a=this.eventTypeHeader,d=b("a.event-type-select",this.eventTypeSelect).length,e=b('input[type="hidden"][name="event"]').val();var c=this.options;e?a.removeClass("challenge"):(c=0<d?c.selectEventLabel:c.noEventsLabel,b(".event-type-name",a).text(c));0==d?a.addClass("empty").addClass("disabled"):1==d&&e?a.removeClass("empty").addClass("disabled"):(a.removeClass("empty").removeClass("disabled"),e||a.addClass("challenge"))},
_populateEventTypes:function(a){let d=this.eventTypeSelect.empty(),e=a.types;(a=a.default)||1!=e.length||(a=e[0]);e.forEach(function(c){let g=c[0],l=c[1];c=c[2]?"T":"F";b('<a class="secondary button event-type-select">').text(l).appendTo(d).data({code:g,name:l,multiple:c})});a?this._setEventType(a[0],a[1]):this._clearEventType()},_selectOrg:function(a){let d=a.data("id");a=a.data("name");let e=this.orgHeader,c=this.orgSelect;this._clearForm();e.data("selected",d).addClass("selected");b("h4.org-name",
e).text(a);let g=b('<div class="inline-throbber">'),l=this.eventTypeHeader.addClass("disabled"),k=b(".event-type-name",l).hide().after(g),h=this;b.ajaxS3({url:this.options.ajaxURL+"?org="+d,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(f){h._populateEventTypes(f);g.remove();k.show();1<f.types.length&&l.removeClass("disabled")},error:function(){g.remove()}});c.slideUp("fast")},_selectEventType:function(a){let d=a.data("code");a=a.data("name");this._setEventType(d,
a);this.eventTypeSelect.slideUp("fast")},_bindEvents:function(){var a=b(this.element),d=this.idPrefix,e=this.eventNamespace,c=this;let g=this.orgHeader,l=this.orgSelect,k=this.eventTypeHeader,h=this.eventTypeSelect;g.on("click"+e,function(f){f.preventDefault();f.stopPropagation();if(g.hasClass("disabled"))return!1;h.slideUp("fast",function(){l.hasClass("hide")?l.hide().removeClass("hide").slideDown("fast"):l.slideToggle("fast")})});l.on("click"+e,"a.org-select",function(f){f.preventDefault();f.stopPropagation();
c._selectOrg(b(this))});k.on("click"+e,function(f){f.preventDefault();f.stopPropagation();if(k.hasClass("disabled"))return!1;l.slideUp("fast",function(){h.hasClass("hide")?h.hide().removeClass("hide").slideDown("fast"):h.slideToggle("fast")})});h.on("click"+e,"a.event-type-select",function(f){f.preventDefault();f.stopPropagation();c._selectEventType(b(this))});this.pictureContainer.on("click"+e,".toggle-picture",function(f){f.preventDefault();c._togglePicture()});a.find("a.cancel-action, .clear-btn").on("click"+
e,function(f){f.preventDefault();c._clearForm()});b(".qrscan-btn",a).on("click"+e,function(f){c._clearForm()});a.find(".check-btn").on("click"+e,function(f){f.preventDefault();c._checkID()});a.find(".submit-btn").off(e).on("click"+e,function(f){f.preventDefault();c._registerEvent()});d=b(d+"_label");d.on("input"+e,function(f){c._clearForm(!1,!0)});d.on("keyup"+e,function(f){switch(f.which){case 27:c._clearForm()}});a.on("change"+e,".member-select",function(){var f=b(this),m=f.closest("tr.family-member");
f.is(":checked")?m.addClass("member-selected"):m.removeClass("member-selected");c._updateSelectAll()});a.on("click"+e,".member-info",function(f){f.preventDefault();f=b(this).closest("tr.family-member").find(".member-select").first();f.prop("disabled")||f.prop("checked",!f.prop("checked")).change();return!1});a.on("change"+e,".member-select-all",function(){b(this).is(":checked")?c._selectAll(!0):c._selectAll(!1)});a.on("click"+e,"tr.family-all",function(f){if(!b(f.target).hasClass("member-select-all"))return f.preventDefault(),
f=b(this).find(".member-select-all").first(),f.prop("disabled")||f.prop("checked",!f.prop("checked")).change(),!1});a.on("click"+e,"button.member-show-picture",function(){var f=b(this).closest(".family-member").data("member");f.p?(c.profilePicture=f.p,c._showProfilePicture()):c._removeProfilePicture();c._updatePictureButtons()});return!0},_unbindEvents:function(){var a=b(this.element),d=this.eventNamespace,e=this.idPrefix;this.orgHeader.off(d);this.orgSelect.off(d);b("#event-type-toggle").off(d);
b("#event-type-selector").find("a.event-type-selector").off(d);b(e+"_label").off(d);a.find("a.cancel-action").off(d);a.find(".check-btn").off(d);a.find(".submit-btn").off(d);a.off(d);return!0}})})(jQuery);
