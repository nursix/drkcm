/*
 2016-2023 (c) Sahana Software Foundation
 @license MIT
*/
(function(b,n){var p=0;b.widget("dvr.checkPoint",{options:{tablename:"case_event",ajaxURL:"",showPicture:!0,showPictureText:"Show Picture",hidePictureText:"Hide Picture",selectAllText:"Select All",noEventsLabel:"No event types available",selectEventLabel:"Please select an event type"},_create:function(){this.id=p;p+=1;this.eventNamespace=".checkPoint"},_init:function(){var a=b(this.element),c=a.attr("id");this.idPrefix="#"+this.options.tablename;this.orgHeader=b("#"+c+"-org-header");this.orgSelect=
b("#"+c+"-org-select");this.eventTypeHeader=b("#"+c+"-event-type-header");this.eventTypeSelect=b("#"+c+"-event-type-select");this.pictureContainer=b("#"+c+"-picture");c=this.idPrefix;this.personRow=b(c+"_person__row",a);this.flagInfoRow=b(c+"_flaginfo__row",a);this.detailsRow=b(c+"_details__row",a);this.familyRow=b(c+"_family__row",a);this.personContainer=b(".controls",this.personRow);this.flagInfoContainer=b(".controls",this.flagInfoRow);this.detailsContainer=b(".controls",this.detailsRow);this.familyContainer=
b(".controls",this.familyRow);this.eventType=a.find('input[type="hidden"][name="event"]');this.flagInfo=b("input[type=hidden][name=flags]",a);this.familyInfo=b("input[type=hidden][name=familyinfo]",a);this.blockingInfo=b('input[type="hidden"][name="intervals"]',a);this.imageURL=b('input[type="hidden"][name="image"]',a);this.actionDetails=b('input[type="hidden"][name="actions"]',a);this.permissionInfo=a.find("input[type=hidden][name=permitted]");this.actionableInfo=a.find("input[type=hidden][name=actionable]");
this.submitLabel=a.find(".submit-btn").first().val();this.profilePicture=null;this.blockedEvents=(a=this.blockingInfo.val())?JSON.parse(a):{};this.blockingMessage=null;this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options;this._unbindEvents();if(!a.ajaxURL)throw Error("checkPoint: no ajaxURL provided");this._clearForm();this._updateEventType();this._bindEvents()},_checkID:function(){var a=this.orgHeader.data("selected");this._clearForm(!1,
!0);var c=b(this.element);let e=this.idPrefix,d=b(e+"_label");var g=d.val().trim();d.val(g);if(g){c=b('input[type=hidden][name="_formkey"]',c).val();a={a:"check",l:g,o:a,e:null,k:c};g=this.options.ajaxURL;var k=b('<div class="inline-throbber">').insertAfter(this.personContainer),l=this;b.ajaxS3({url:g,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(a),success:function(h){k.remove();h.a&&b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+
h.a+"</div></div>").hide().insertAfter(b(e+"_label").closest(".controls")).slideDown("fast");if(h.p){l._showPerson(h.p);h.b&&(l.imageURL.val(h.b),l.profilePicture=h.b,l._showProfilePicture());var f=l.flagInfo;h.f?f.val(JSON.stringify(h.f)):f.val("[]");f=l.permissionInfo;h.s!==n?f.val(JSON.stringify(h.s)):f.val("false");f=l.actionableInfo;var m=h.u;f.length&&(m!==n?f.val(JSON.stringify(h.u)):(m=!0,f.val("true")));h.d&&l._updateDetails(h.d,m);l.familyInfo.val(JSON.stringify(h.x||[]));l._showFamily();
l.blockedEvents=h.i||{};l.blockingInfo.val(JSON.stringify(l.blockedEvents));l.eventType.val()&&l._toggleSubmit(!0);l._showFlagInfo()}h.e&&S3.showAlert(h.e,"error");h.w&&S3.showAlert(h.w,"warning");h.m&&S3.showAlert(h.m,"success")},error:function(){k.remove();l._clearForm(!0,!1)}})}},_registerEvent:function(){var a=this.orgHeader.data("selected");this._clearAlert();var c=b(this.element);let e=this.idPrefix,d=b(e+"_label");var g=d.val().trim(),k=this.eventType.val();d.val(g);if(g&&k){c=b('input[type=hidden][name="_formkey"]',
c).val();a={a:"register",l:g,o:a,e:k,k:c};g=this.options.ajaxURL;k=b(e+"_person__row .controls");var l=b('<div class="inline-throbber">').insertAfter(k),h=this;k=b(".family-members",this.familyContainer);if(k.length){let f=[];b(".family-member",k).each(function(){var m=b(this);m.find("input.member-select").prop("checked")&&(m=m.data("member").l)&&f.push(m)});a.l=f}k=this.actionDetails;k.length&&(k=k.val(),a.d=k?JSON.parse(k):[]);a.c=b(e+"comments").val();b.ajaxS3({url:g,type:"POST",dataType:"json",
contentType:"application/json; charset=utf-8",data:JSON.stringify(a),success:function(f){l.remove();f.e?b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+f.e+"</div></div>").hide().insertAfter(b(e+"_label")).slideDown("fast"):h._clearForm();f.a?S3.showAlert(f.a,"error",!1):f.m&&S3.showAlert(f.m,"success",!1)},error:function(){l.remove();this._clearForm(!0)}})}},_checkBlockedEvents:function(){var a=this.eventType.val();a=this.blockedEvents[a];var c=this;this.blockingMessage&&
this.blockingMessage.remove();var e=function(d,g){let k=!0;if(d&&(!g||!d[2])){g=b("<h6>").addClass("event-registration-blocked").html(d[0]);d=d[1]?new Date(d[1]):null;let l=new Date;if(null===d||d>l)c.blockingMessage=b("<div>").addClass("small-12-columns").append(g).prependTo(b("#submit_record__row")),k=!1}return k};return b(".family-members",this.familyContainer).length?(a=e(a,!0),!!this._updateFamilyStatus(a)):e(a,!1)},_showPerson:function(a){this.personRow.show();this.personContainer.empty().html(a).removeClass("hide").show()},
_removePerson:function(){this.personRow.hide();this.personContainer.empty()},_showFlagInfo:function(){this.flagInfoRow.hide();var a=this.flagInfo;let c=this.flagInfoContainer.empty().removeClass("has-flaginfo");a=a.length?JSON.parse(a.val()):[];if(a.length){this.flagInfoRow.removeClass("hide").show();c.addClass("has-flaginfo");let e=b('<div class="checkpoint-advise">').hide();a.forEach(function(d){let g=b('<div class="checkpoint-instructions">').appendTo(e);b("<h4>"+d.n+"</h4>").appendTo(g);d.i&&
b("<p>"+d.i+"</p>").appendTo(g)});e.appendTo(c).slideDown("fast")}},_removeFlagInfo:function(){this.flagInfoRow.hide();this.flagInfoContainer.empty();this.flagInfo.val("[]")},_showProfilePicture:function(){var a=b(this.element),c=this.options,e=this.profilePicture;this._removeProfilePicture();if(e){var d=b('<button class="small secondary button toggle-picture" type="button">'),g=b('<div class="button-row">').append(d);d.text(c.showPictureText);d=this.pictureContainer;d.length||(this.pictureContainer=
d=b('<div class="panel profile-picture">').appendTo(a));d.append(g).data("url",e);c.showPicture&&this._togglePicture()}},_removeProfilePicture:function(){this.profilePicture=null;this.pictureContainer.empty()},_togglePicture:function(){b(this.element);var a=this.options,c=this.pictureContainer;if(c.length){var e=c.find(".image-row"),d=c.data("url"),g=c.find("button.toggle-picture");e.length?(e.remove(),g.text(a.showPictureText)):d&&(e=b("<img>").attr("src",d),e=b('<div class="image-row">').append(e),
c.prepend(e),g.text(a.hidePictureText))}},_updatePictureButtons:function(){b(this.element);var a=this.pictureContainer,c=a.data("url");b("button.member-show-picture").removeClass("showing");b(".member-caption").remove();c&&b(".family-member").each(function(){var e=b(this),d=e.data("member");d.p==c&&(e.find("button.member-show-picture").addClass("showing"),a.find(".button-row").before(b('<div class="member-caption">'+d.n+"</div>")))})},_showDetails:function(a){this.detailsRow.show();b(this.idPrefix+
"_details__row").show()},_hideDetails:function(){this.personContainer.text()?this.detailsRow.show():this.detailsRow.hide()},_updateDetails:function(a,c){var e=this.idPrefix;b(e+"_details__row .controls");b(e+"_date__row .controls");var d=this.actionDetails;d.length&&(""!==a.h?d.val(JSON.stringify(a.h)):d.val("[]"));b(e+"_details__row .controls").html(a.d);b(e+"_date__row .controls").html(a.t);this._showDetails(c)},_removeDetails:function(){var a=this.idPrefix;this._hideDetails();this.flagInfo.val("[]");
this.permissionInfo.val("false");b(a+"_flaginfo__row .controls").empty();b(a+"_details__row .controls").empty();b(a+"_date__row .controls").empty();b(a+"_comments").val("");this.blockedEvents={};this.blockingMessage&&this.blockingMessage.remove();this.blockingInfo.val(JSON.stringify(this.blockedEvents))},_showFamily:function(){var a=this._getEventType();if(a&&a.multiple&&(a=this.familyInfo,a.length)){var c=JSON.parse(a.val());a=this.familyContainer.empty();if(c.length){this.familyRow.show();let e=
b('<table class="family-members">').hide();c.forEach(function(d){this._renderFamilyMember(d).appendTo(e)},this);c=this.options;b('<tr class="family-all">').append(b('<td><input class="member-select-all" type="checkbox"/></td>')).append(b('<td colspan="2">'+c.selectAllText+"</td>")).appendTo(e);e.appendTo(a).slideDown("fast")}else this.familyRow.hide()}},_hideFamily:function(){this.familyContainer.empty();this.familyRow.hide();this.profilePicture=this.imageURL.val();this._showProfilePicture()},_removeFamily:function(){this.familyInfo.val("[]");
this.familyContainer.empty();this.familyRow.hide()},_renderFamilyMember:function(a){var c=this.options,e=b('<input class="member-select" type="checkbox">'),d=b('<div class="medium-4 small-12 columns member-id">'+a.l+"</div>"),g=b('<div class="medium-8 small-12 columns member-name">'+a.n+" ("+a.d+")</div>");g=b('<div class="member-info row">').append(d).append(g);d=b('<div class="member-show-picture">');a.p&&b('<button class="tiny secondary button fright member-show-picture" type="button">'+c.showPictureText+
"</button>").appendTo(d);c=b("<td>").append(e);e=b('<td class="member-info">').append(g);d=b("<td>").append(d);return b('<tr class="family-member">').data("member",a).append(c).append(e).append(d)},_updateFamilyStatus:function(a){let c=this.familyContainer,e=b(".family-member",c),d=this.eventType.val(),g=0,k=new Date,l=this._getEventType();if(l&&l.multiple)return!e.length&&this.familyInfo.val()&&this._showFamily(),b(".family-member",c).each(function(){var h=b(this),f=h.data("member").r,m=!a,q="";
if(f&&f.hasOwnProperty(d)){f=f[d];var r=f[1]?new Date(f[1]):null;if(null===r||r>k)m=!0,q=b('<div class="member-message">'+f[0]+"</div>")}h.find(".member-message").remove();m?(h.removeClass("member-selected"),b(".member-select",h).each(function(){b(this).prop("checked",!1).prop("disabled",!0)}),h.addClass("member-blocked"),m=b('<div class="member-message row">'),b('<div class="columns">').append(q).appendTo(m),h.find(".member-info.row").after(m)):(g++,h.removeClass("member-blocked"),b(".member-select",
h).each(function(){b(this).prop("disabled",!1).prop("checked",!0);h.addClass("member-selected")}))}),this._updateSelectAll(),this._updatePictureButtons(),g;this._hideFamily();this._updateSelectAll()},_updateSelectAll:function(){var a=0,c=0,e=!0;b(".member-select").each(function(){var g=b(this);g.prop("disabled")||(a++,g.prop("checked")?c++:e=!1)});var d=b(".member-select-all");a?d.prop("disabled",!1).prop("checked",e):d.prop("checked",!1).prop("disabled",!0);d=b(".submit-btn");b(".member-select").length?
(d.val(this.submitLabel+" ("+c+")"),c?d.prop("disabled",!1):d.prop("disabled",!0)):d.val(this.submitLabel)},_selectAll:function(a){var c=0;b(".member-select").each(function(){var e=b(this);e.prop("disabled")||(a?(e.prop("checked",!0).closest("tr.family-member").addClass("member-selected"),c++):e.prop("checked",!1).closest("tr.family-member").removeClass("member-selected"))});this._updateSelectAll()},_toggleSubmit:function(a){var c=b(this.element),e=[".check-btn",".submit-btn"],d=this.permissionInfo,
g=this.actionableInfo;if(a){var k=a=!1;d.length&&(d=d.val())&&(a=JSON.parse(d));a&&(k=!0,g.length&&(g=g.val())&&(k=JSON.parse(g)));a&&k&&(k=this._checkBlockedEvents());a&&k&&e.reverse()}d=c.find(e[0]);c.find(e[1]).prop("disabled",!0).hide().insertAfter(d);d.prop("disabled",!1).hide().removeClass("hide").show()},_clearAlert:function(){b(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast");b(".error_wrapper").fadeOut("fast").remove()},_clearForm:function(a,c){b(".inline-throbber").remove();
a||this._clearAlert();c||b(this.idPrefix+"_label").val("");this._removePerson();this._removeFlagInfo();this._removeDetails();this._removeFamily();this._removeProfilePicture();this.blockingMessage&&this.blockingMessage.remove();this.imageURL.val("");b(".submit-btn").val(this.submitLabel);this._toggleSubmit(!1);a=b(this.idPrefix+"_label");a.trigger("focus").val(a.val())},_getEventType:function(){let a=this.eventType.val();if(!a)return null;let c=b("a.event-type-select",this.eventTypeSelect).filter(function(){return b(this).data("code")==
a});return c.length?{code:c.data("code")||null,name:c.data("name")||null,multiple:"T"==c.data("multiple")}:null},_setEventType:function(a,c){b('input[type="hidden"][name="event"]').val(a);b(".event-type-name",this.eventTypeHeader).text(c);this._updateEventType();this._updateFamilyStatus();b(this.idPrefix+"_person__row .controls").text()&&this._toggleSubmit(!0)},_clearEventType:function(){b('input[type="hidden"][name="event"]').val("");this._updateEventType();this._toggleSubmit(!1)},_updateEventType:function(){let a=
this.eventTypeHeader,c=b("a.event-type-select",this.eventTypeSelect).length,e=b('input[type="hidden"][name="event"]').val();var d=this.options;e?a.removeClass("challenge"):(d=0<c?d.selectEventLabel:d.noEventsLabel,b(".event-type-name",a).text(d));0==c?a.addClass("empty").addClass("disabled"):1==c&&e?a.removeClass("empty").addClass("disabled"):(a.removeClass("empty").removeClass("disabled"),e||a.addClass("challenge"))},_populateEventTypes:function(a){let c=this.eventTypeSelect.empty(),e=a.types;(a=
a.default)||1!=e.length||(a=e[0]);e.forEach(function(d){let g=d[0],k=d[1];d=d[2]?"T":"F";b('<a class="secondary button event-type-select">').text(k).appendTo(c).data({code:g,name:k,multiple:d})});a?this._setEventType(a[0],a[1]):this._clearEventType()},_selectOrg:function(a){let c=a.data("id");a=a.data("name");let e=this.orgHeader,d=this.orgSelect;this._clearForm();e.data("selected",c).addClass("selected");b("h4.org-name",e).text(a);let g=b('<div class="inline-throbber">'),k=this.eventTypeHeader.addClass("disabled"),
l=b(".event-type-name",k).hide().after(g),h=this;b.ajaxS3({url:this.options.ajaxURL+"?org="+c,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(f){h._populateEventTypes(f);g.remove();l.show();1<f.types.length&&k.removeClass("disabled")},error:function(){g.remove()}});d.slideUp("fast")},_selectEventType:function(a){let c=a.data("code");a=a.data("name");this._setEventType(c,a);this.eventTypeSelect.slideUp("fast")},_bindEvents:function(){var a=b(this.element),
c=this.idPrefix,e=this.eventNamespace,d=this;let g=this.orgHeader,k=this.orgSelect,l=this.eventTypeHeader,h=this.eventTypeSelect;g.on("click"+e,function(f){f.preventDefault();f.stopPropagation();if(g.hasClass("disabled"))return!1;h.slideUp("fast",function(){k.hasClass("hide")?k.hide().removeClass("hide").slideDown("fast"):k.slideToggle("fast")})});k.on("click"+e,"a.org-select",function(f){f.preventDefault();f.stopPropagation();d._selectOrg(b(this))});l.on("click"+e,function(f){f.preventDefault();
f.stopPropagation();if(l.hasClass("disabled"))return!1;k.slideUp("fast",function(){h.hasClass("hide")?h.hide().removeClass("hide").slideDown("fast"):h.slideToggle("fast")})});h.on("click"+e,"a.event-type-select",function(f){f.preventDefault();f.stopPropagation();d._selectEventType(b(this))});this.pictureContainer.on("click"+e,".toggle-picture",function(f){f.preventDefault();d._togglePicture()});a.find("a.cancel-action, .clear-btn").on("click"+e,function(f){f.preventDefault();d._clearForm()});b(".qrscan-btn",
a).on("click"+e,function(f){d._clearForm()});a.find(".check-btn").on("click"+e,function(f){f.preventDefault();d._checkID()});a.find(".submit-btn").off(e).on("click"+e,function(f){f.preventDefault();d._registerEvent()});c=b(c+"_label");c.on("input"+e,function(f){d._clearForm(!1,!0)});c.on("keyup"+e,function(f){switch(f.which){case 27:d._clearForm()}});a.on("change"+e,".member-select",function(){var f=b(this),m=f.closest("tr.family-member");f.is(":checked")?m.addClass("member-selected"):m.removeClass("member-selected");
d._updateSelectAll()});a.on("click"+e,".member-info",function(f){f.preventDefault();f=b(this).closest("tr.family-member").find(".member-select").first();f.prop("disabled")||f.prop("checked",!f.prop("checked")).change();return!1});a.on("change"+e,".member-select-all",function(){b(this).is(":checked")?d._selectAll(!0):d._selectAll(!1)});a.on("click"+e,"tr.family-all",function(f){if(!b(f.target).hasClass("member-select-all"))return f.preventDefault(),f=b(this).find(".member-select-all").first(),f.prop("disabled")||
f.prop("checked",!f.prop("checked")).change(),!1});a.on("click"+e,"button.member-show-picture",function(){var f=b(this).closest(".family-member").data("member");f.p?(d.profilePicture=f.p,d._showProfilePicture()):d._removeProfilePicture();d._updatePictureButtons()});return!0},_unbindEvents:function(){var a=b(this.element),c=this.eventNamespace,e=this.idPrefix;this.orgHeader.off(c);this.orgSelect.off(c);b("#event-type-toggle").off(c);b("#event-type-selector").find("a.event-type-selector").off(c);b(e+
"_label").off(c);a.find("a.cancel-action").off(c);a.find(".check-btn").off(c);a.find(".submit-btn").off(c);a.off(c);return!0}})})(jQuery);
