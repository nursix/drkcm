/*
 2016-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(b,m){var n=0;b.widget("dvr.eventRegistration",{options:{tablename:"case_event",ajax:null,ajaxURL:"",showPicture:!0,showPictureText:"Show Picture",hidePictureText:"Hide Picture"},_create:function(){this.id=n;n+=1;this.eventNamespace=".eventRegistration"},_init:function(){this.idPrefix="#"+this.options.tablename;var a=b(this.element);this.flagInfo=a.find("input[type=hidden][name=flags]");this.permissionInfo=a.find("input[type=hidden][name=permitted]");this.actionableInfo=a.find("input[type=hidden][name=actionable]");
this.eventType=a.find('input[type="hidden"][name="event"]');this.blockingInfo=a.find('input[type="hidden"][name="intervals"]');this.actionDetails=a.find('input[type="hidden"][name="actions"]');this.imageURL=a.find('input[type="hidden"][name="image"]');this.blockedEvents=(a=this.blockingInfo.val())?JSON.parse(a):{};this.blockingMessage=null;this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,c=this.idPrefix;this._unbindEvents();a.ajaxURL&&
null===a.ajax&&(a.ajax=!0);this._showFlagInfo();this._showProfilePicture();b(this.element).find(c+"_details__row .controls").addClass("has-details");this.actionDetails.length?JSON.parse(this.actionDetails.val()).length?this._showDetails(!0):this._hideDetails():this._hideDetails();this._checkBlockedEvents()||this._toggleSubmit(!1);a=b(c+"_label");a.trigger("focus").val(a.val());this._clearForm();this._bindEvents()},_checkID:function(){this._clearAlert();b(this.element);var a=this.idPrefix,c=b(a+"_label"),
d=c.val().trim();c.val(d);if(d){c={l:d,c:!0};d=this.options.ajaxURL;var e=b(a+"_person__row .controls").empty(),h=b('<div class="inline-throbber">').insertAfter(e),g=this;this._removeProfilePicture();this._clearDetails();b.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(c),success:function(f){h.remove();if(f.e)b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+f.e+"</div></div>").hide().insertAfter(b(a+
"_label")).slideDown();else{e.html(f.p).removeClass("hide").show();var k=g.flagInfo;f.f?k.val(JSON.stringify(f.f)):k.val("[]");k=g.permissionInfo;f.s!==m?k.val(JSON.stringify(f.s)):k.val("false");k=g.actionableInfo;var l=f.u;k.length&&(l!==m?k.val(JSON.stringify(f.u)):(l=!0,k.val("true")));f.d&&g._updateDetails(f.d,l);f.b&&(g.imageURL.val(f.b),g._showProfilePicture());g.blockedEvents=f.i||{};g.blockingInfo.val(JSON.stringify(g.blockedEvents));g.eventType.val()&&g._toggleSubmit(!0);g._showFlagInfo()}f.a?
S3.showAlert(f.a,"error"):f.m&&S3.showAlert(f.m,"success")},error:function(){h.remove();g._clearForm(!0)}})}},_registerEvent:function(){this._clearAlert();var a=this.idPrefix,c=b(a+"_label").val(),d=this.eventType.val();if(c&&d){c={l:c,t:d};d=this.options.ajaxURL;var e=b(a+"_person__row .controls"),h=b('<div class="inline-throbber">').insertAfter(e),g=this;e=this.actionDetails;e.length&&(e=e.val(),c.d=e?JSON.parse(e):[]);c.c=b(a+"comments").val();b.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",
data:JSON.stringify(c),success:function(f){h.remove();f.e?b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+f.e+"</div></div>").hide().insertAfter(b(a+"_label")).slideDown():g._clearForm();f.a?S3.showAlert(f.a,"error",!1):f.m&&S3.showAlert(f.m,"success",!1)},error:function(){h.remove();this._clearForm(!0)}})}},_checkBlockedEvents:function(){var a=this.eventType.val();a=this.blockedEvents[a];this.blockingMessage&&this.blockingMessage.remove();if(a){var c=
b("<h6>").addClass("event-registration-blocked").html(a[0]);if(new Date(a[1])>new Date)return this.blockingMessage=b("<div>").addClass("small-12-columns").append(c).prependTo(b("#submit_record__row")),!1}return!0},_showFlagInfo:function(){var a=this.flagInfo,c=b(this.idPrefix+"_flaginfo__row .controls").empty();a=a.length?JSON.parse(a.val()):[];var d=a.length;if(d){c.addClass("has-flaginfo").show();c=b('<div class="checkpoint-advise">').hide().appendTo(c);for(var e,h,g=0;g<d;g++)e=a[g],h=b('<div class="checkpoint-instructions">').appendTo(c),
b("<h4>"+e.n+"</h4>").appendTo(h),e.i&&b("<p>"+e.i+"</p>").appendTo(h);c.slideDown()}},_showProfilePicture:function(){var a=b(this.element),c=this.options,d=this.imageURL.val();this._removeProfilePicture();if(d){var e=b('<button class="small secondary button toggle-picture" type="button">'),h=b('<div class="button-row">').append(e);e.text(c.showPictureText);b('<div class="panel profile-picture">').append(h).data("url",d).appendTo(a);c.showPicture&&this._togglePicture()}},_removeProfilePicture:function(){this.imageURL.val("");
b(this.element).find(".panel.profile-picture").remove()},_togglePicture:function(){var a=b(this.element),c=this.options;a=a.find(".panel.profile-picture");if(a.length){var d=a.find(".image-row"),e=a.data("url"),h=a.find("button.toggle-picture");d.length?(d.remove(),h.text(c.showPictureText)):e&&(d=b("<img>").attr("src",e),d=b('<div class="image-row">').append(d),a.prepend(d),h.text(c.hidePictureText))}},_hideDetails:function(){var a=this.idPrefix;b(a+"_person__row .controls").text()?b(a+"_details__row").show():
b(a+"_details__row").hide();b(a+"_date__row").hide();b(a+"_comments__row").hide()},_showDetails:function(a){var c=this.idPrefix;b(c+"_details__row").show();a&&(b(c+"_date__row").show(),b(c+"_comments__row").show())},_updateDetails:function(a,c){var d=this.idPrefix;b(d+"_details__row .controls");b(d+"_date__row .controls");var e=this.actionDetails;e.length&&(""!==a.h?e.val(JSON.stringify(a.h)):e.val("[]"));b(d+"_details__row .controls").html(a.d);b(d+"_date__row .controls").html(a.t);this._showDetails(c)},
_clearDetails:function(){var a=this.idPrefix;this._hideDetails();this.flagInfo.val("[]");this.permissionInfo.val("false");b(a+"_flaginfo__row .controls").empty();b(a+"_details__row .controls").empty();b(a+"_date__row .controls").empty();b(a+"_comments").val("");this.blockedEvents={};this.blockingMessage&&this.blockingMessage.remove();this.blockingInfo.val(JSON.stringify(this.blockedEvents))},_toggleSubmit:function(a){var c=b(this.element),d=[".check-btn",".submit-btn"],e=this.permissionInfo,h=this.actionableInfo;
if(a){var g=a=!1;e.length&&(e=e.val())&&(a=JSON.parse(e));a&&(g=!0,h.length&&(h=h.val())&&(g=JSON.parse(h)));a&&g&&(g=this._checkBlockedEvents());a&&g&&d.reverse()}e=c.find(d[0]);c.find(d[1]).prop("disabled",!0).hide().insertAfter(e);e.prop("disabled",!1).hide().removeClass("hide").show()},_clearAlert:function(){b(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast");b(".error_wrapper").fadeOut("fast").remove()},_clearForm:function(a,c){var d=this.idPrefix;b(".inline-throbber").remove();
a||this._clearAlert();c||b(d+"_label").val("");b(d+"_person__row .controls").hide().empty();b(d+"_flaginfo__row .controls").hide().empty();this._removeProfilePicture();this._clearDetails();this._toggleSubmit(!1)},_bindEvents:function(){var a=b(this.element),c=this.idPrefix,d=this.eventNamespace,e=this,h=b("#event-type-toggle"),g=b("#event-type-selector");h.on("click"+d,function(){e._clearAlert();g.hasClass("hide")?g.hide().removeClass("hide").slideDown():g.slideToggle()});g.find("a.event-type-selector").on("click"+
d,function(){var f=b(this),k=f.data("code");f=f.data("name");b('input[type="hidden"][name="event"]').val(k);b(".event-type-name").text(f).removeClass("placeholder");b(c+"_person__row .controls").text()&&e._toggleSubmit(!0);g.slideUp()});a.on("click"+d,".toggle-picture",function(f){f.preventDefault();e._togglePicture()});a.find("a.cancel-action, .clear-btn").on("click"+d,function(f){f.preventDefault();e._clearForm()});b(".qrscan-btn",a).on("click"+d,function(f){e._clearForm()});this.options.ajax&&
(a.find(".check-btn").on("click"+d,function(f){f.preventDefault();e._checkID()}),a.find(".submit-btn").off(d).on("click"+d,function(f){f.preventDefault();e._registerEvent()}));a=b(c+"_label");a.on("input"+d,function(f){e._clearForm(!1,!0)});a.on("keyup"+d,function(f){switch(f.which){case 27:e._clearForm()}});return!0},_unbindEvents:function(){var a=b(this.element),c=this.eventNamespace,d=this.idPrefix;b("#event-type-toggle").off(c);b("#event-type-selector").find("a.event-type-selector").off(c);b(d+
"_label").off(c);a.find("a.cancel-action").off(c);a.find(".check-btn").off(c);a.find(".submit-btn").off(c);a.off(c);return!0}})})(jQuery);
