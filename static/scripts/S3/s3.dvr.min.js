/*
 2016-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(b,m){var n=0;b.widget("dvr.eventRegistration",{options:{tablename:"case_event",ajax:null,ajaxURL:"",showPicture:!0,showPictureText:"Show Picture",hidePictureText:"Hide Picture"},_create:function(){this.id=n;n+=1;this.eventNamespace=".eventRegistration"},_init:function(){this.idPrefix="#"+this.options.tablename;var a=b(this.element);this.flagInfo=a.find("input[type=hidden][name=flags]");this.permissionInfo=a.find("input[type=hidden][name=permitted]");this.actionableInfo=a.find("input[type=hidden][name=actionable]");
this.eventType=a.find('input[type="hidden"][name="event"]');this.blockingInfo=a.find('input[type="hidden"][name="intervals"]');this.actionDetails=a.find('input[type="hidden"][name="actions"]');this.imageURL=a.find('input[type="hidden"][name="image"]');this.blockedEvents=(a=this.blockingInfo.val())?JSON.parse(a):{};this.blockingMessage=null;this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,c=this.idPrefix;this._unbindEvents();a.ajaxURL&&
null===a.ajax&&(a.ajax=!0);this._showFlagInfo();this._showProfilePicture();b(this.element).find(c+"_details__row .controls").addClass("has-details");this.actionDetails.length?JSON.parse(this.actionDetails.val()).length?this._showDetails(!0):this._hideDetails():this._hideDetails();this._checkBlockedEvents()||this._toggleSubmit(!1);a=b(c+"_label");a.focus().val(a.val());this._bindEvents()},_checkID:function(){this._clearAlert();b(this.element);var a=this.idPrefix,c=b(a+"_label"),d=c.val().trim();c.val(d);
if(d){c={l:d,c:!0};d=this.options.ajaxURL;var e=b(a+"_person__row .controls").empty(),k=b('<div class="inline-throbber">').insertAfter(e),h=this;this._removeProfilePicture();this._clearDetails();b.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(c),success:function(f){k.remove();if(f.e)b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+f.e+"</div></div>").hide().insertAfter(b(a+"_label")).slideDown();
else{e.html(f.p).removeClass("hide").show();var g=h.flagInfo;f.f?g.val(JSON.stringify(f.f)):g.val("[]");g=h.permissionInfo;f.s!==m?g.val(JSON.stringify(f.s)):g.val("false");g=h.actionableInfo;var l=f.u;g.length&&(l!==m?g.val(JSON.stringify(f.u)):(l=!0,g.val("true")));f.d&&h._updateDetails(f.d,l);f.b&&(h.imageURL.val(f.b),h._showProfilePicture());h.blockedEvents=f.i||{};h.blockingInfo.val(JSON.stringify(h.blockedEvents));h.eventType.val()&&h._toggleSubmit(!0);h._showFlagInfo()}f.a?S3.showAlert(f.a,
"error"):f.m&&S3.showAlert(f.m,"success")},error:function(){k.remove();h._clearForm(!0)}})}},_registerEvent:function(){this._clearAlert();var a=this.idPrefix,c=b(a+"_label").val(),d=this.eventType.val();if(c&&d){c={l:c,t:d};d=this.options.ajaxURL;var e=b(a+"_person__row .controls"),k=b('<div class="inline-throbber">').insertAfter(e),h=this;e=this.actionDetails;e.length&&(e=e.val(),c.d=e?JSON.parse(e):[]);c.c=b(a+"comments").val();b.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",
data:JSON.stringify(c),success:function(f){k.remove();f.e?b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+f.e+"</div></div>").hide().insertAfter(b(a+"_label")).slideDown():h._clearForm();f.a?S3.showAlert(f.a,"error",!1):f.m&&S3.showAlert(f.m,"success",!1)},error:function(){k.remove();this._clearForm(!0)}})}},_checkBlockedEvents:function(){var a=this.eventType.val();a=this.blockedEvents[a];this.blockingMessage&&this.blockingMessage.remove();if(a){var c=
b("<h6>").addClass("event-registration-blocked").html(a[0]);if(new Date(a[1])>new Date)return this.blockingMessage=b("<div>").addClass("small-12-columns").append(c).prependTo(b("#submit_record__row")),!1}return!0},_showFlagInfo:function(){var a=this.flagInfo,c=b(this.idPrefix+"_flaginfo__row .controls").empty();a=a.length?JSON.parse(a.val()):[];var d=a.length;if(d){c.addClass("has-flaginfo");c=b('<div class="checkpoint-advise">').hide().appendTo(c);for(var e,k,h=0;h<d;h++)e=a[h],k=b('<div class="checkpoint-instructions">').appendTo(c),
b("<h4>"+e.n+"</h4>").appendTo(k),e.i&&b("<p>"+e.i+"</p>").appendTo(k);c.slideDown()}},_showProfilePicture:function(){var a=b(this.element),c=this.options,d=this.imageURL.val();this._removeProfilePicture();if(d){var e=b('<button class="tiny secondary button toggle-picture" type="button">'),k=b('<div class="button-row">').append(e);e.text(c.showPictureText);b('<div class="panel profile-picture">').append(k).data("url",d).appendTo(a);c.showPicture&&this._togglePicture()}},_removeProfilePicture:function(){this.imageURL.val("");
b(this.element).find(".panel.profile-picture").remove()},_togglePicture:function(){var a=b(this.element),c=this.options;a=a.find(".panel.profile-picture");if(a.length){var d=a.find(".image-row"),e=a.data("url"),k=a.find("button.toggle-picture");d.length?(d.remove(),k.text(c.showPictureText)):e&&(d=b("<img>").attr("src",e),d=b('<div class="image-row">').append(d),a.prepend(d),k.text(c.hidePictureText))}},_hideDetails:function(){var a=this.idPrefix;b(a+"_person__row .controls").text()?b(a+"_details__row").show():
b(a+"_details__row").hide();b(a+"_date__row").hide();b(a+"_comments__row").hide()},_showDetails:function(a){var c=this.idPrefix;b(c+"_details__row").show();a&&(b(c+"_date__row").show(),b(c+"_comments__row").show())},_updateDetails:function(a,c){var d=this.idPrefix;b(d+"_details__row .controls");b(d+"_date__row .controls");var e=this.actionDetails;e.length&&(""!==a.h?e.val(JSON.stringify(a.h)):e.val("[]"));b(d+"_details__row .controls").html(a.d);b(d+"_date__row .controls").html(a.t);this._showDetails(c)},
_clearDetails:function(){var a=this.idPrefix;this._hideDetails();this.flagInfo.val("[]");this.permissionInfo.val("false");b(a+"_flaginfo__row .controls").empty();b(a+"_details__row .controls").empty();b(a+"_date__row .controls").empty();b(a+"_comments").val("");this.blockedEvents={};this.blockingMessage&&this.blockingMessage.remove();this.blockingInfo.val(JSON.stringify(this.blockedEvents))},_toggleSubmit:function(a){var c=b(this.element),d=[".check-btn",".submit-btn"],e=this.permissionInfo,k=this.actionableInfo;
if(a){var h=a=!1;e.length&&(e=e.val())&&(a=JSON.parse(e));a&&(h=!0,k.length&&(k=k.val())&&(h=JSON.parse(k)));a&&h&&(h=this._checkBlockedEvents());a&&h&&d.reverse()}e=c.find(d[0]);c.find(d[1]).prop("disabled",!0).hide().insertAfter(e);e.prop("disabled",!1).hide().removeClass("hide").show()},_clearAlert:function(){b(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast");b(".error_wrapper").fadeOut("fast").remove()},_clearForm:function(a,c){var d=this.idPrefix;b(".inline-throbber").remove();
a||this._clearAlert();c||b(d+"_label").val("");b(d+"_person__row .controls").hide().empty();this._removeProfilePicture();this._clearDetails();this._toggleSubmit(!1)},_bindEvents:function(){var a=b(this.element),c=this.idPrefix,d=this.eventNamespace,e=this,k=b(".zxing-button"),h=b("#event-type-toggle"),f=b("#event-type-selector");-1==navigator.userAgent.toLowerCase().indexOf("android")?k.addClass("disabled").click(function(g){g.preventDefault();g.stopPropagation();return!1}):k.bind("click"+d,function(){e._clearAlert()});
h.bind("click"+d,function(){e._clearAlert();f.hasClass("hide")?f.hide().removeClass("hide").slideDown():f.slideToggle()});f.find("a.event-type-selector").bind("click"+d,function(){var g=b(this),l=g.data("code");g=g.data("name");b('input[type="hidden"][name="event"]').val(l);b(".event-type-name").text(g).removeClass("placeholder");b(c+"_person__row .controls").text()&&e._toggleSubmit(!0);k.each(function(){var p=b(this),q=p.data("tmp");q&&p.attr("href",q.replace("%7BEVENT%7D",l))});f.slideUp()});a.delegate(".toggle-picture",
"click"+d,function(g){g.preventDefault();e._togglePicture()});a.find("a.cancel-action").bind("click"+d,function(g){g.preventDefault();e._clearForm()});this.options.ajax&&(a.find(".check-btn").bind("click"+d,function(g){g.preventDefault();e._checkID()}),a.find(".submit-btn").unbind(d).bind("click"+d,function(g){g.preventDefault();e._registerEvent()}));a=b(c+"_label");a.bind("input"+d,function(g){e._clearForm(!1,!0)});a.bind("keyup"+d,function(g){switch(g.which){case 27:e._clearForm()}});return!0},
_unbindEvents:function(){var a=b(this.element),c=this.eventNamespace,d=this.idPrefix;b(".zxing-button").unbind(c).unbind("click");b("#event-type-toggle").unbind(c);b("#event-type-selector").find("a.event-type-selector").unbind(c);b(d+"_label").unbind(c);a.find("a.cancel-action").unbind(c);a.find(".check-btn").unbind(c);a.find(".submit-btn").unbind(c);a.undelegate(c);return!0}})})(jQuery);
