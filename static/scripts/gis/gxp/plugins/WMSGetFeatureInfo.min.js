Ext.namespace("gxp.plugins");
gxp.plugins.WMSGetFeatureInfo=Ext.extend(gxp.plugins.Tool,{ptype:"gxp_wmsgetfeatureinfo",outputTarget:"map",popupCache:null,infoActionTip:"Get Feature Info",popupTitle:"Feature Info",buttonText:"Identify",format:"html",addActions:function(){this.popupCache={};var c=gxp.plugins.WMSGetFeatureInfo.superclass.addActions.call(this,[{tooltip:this.infoActionTip,iconCls:"gxp-icon-getfeatureinfo",buttonText:this.buttonText,toggleGroup:this.toggleGroup,enableToggle:!0,allowDepress:!0,toggleHandler:function(a,
d){a=0;for(var e=b.controls.length;a<e;a++)d?b.controls[a].activate():b.controls[a].deactivate()}}]),n=this.actions[0].items[0],b={controls:[]},g=function(){for(var a=this.target.mapPanel.layers.queryBy(function(f){return f.get("queryable")}),d=this.target.mapPanel.map,e,l=0,p=b.controls.length;l<p;l++)e=b.controls[l],e.deactivate(),e.destroy();b.controls=[];a.each(function(f){var h=f.getLayer(),u=Ext.apply({},this.vendorParams);if(this.layerParams)for(var q=this.layerParams.length-1;0<=q;--q){var v=
this.layerParams[q].toUpperCase();u[v]=h.params[v]}var m=f.get("infoFormat");void 0===m&&(m="html"==this.format?"text/html":"application/vnd.ogc.gml");h=new OpenLayers.Control.WMSGetFeatureInfo(Ext.applyIf({url:h.url,queryVisible:!0,layers:[h],infoFormat:m,vendorParams:u,maxFeatures:1E3,eventListeners:{getfeatureinfo:function(k){var r=f.get("title")||f.get("name");if("text/html"==m){var t=k.text.match(/<body[^>]*>([\s\S]*)<\/body>/);t&&!t[1].match(/^\s*$/)&&this.displayPopup(k,r,t[1])}else"text/plain"==
m?this.displayPopup(k,r,"<pre>"+k.text+"</pre>"):k.features&&0<k.features.length&&this.displayPopup(k,r,null,f.get("getFeatureInfo"))},scope:this}},this.controlOptions));d.addControl(h);b.controls.push(h);n.pressed&&h.activate()},this)};this.target.mapPanel.layers.on("update",g,this);this.target.mapPanel.layers.on("add",g,this);this.target.mapPanel.layers.on("remove",g,this);return c},displayPopup:function(c,n,b,g){var a=c.xy.x+"."+c.xy.y;g=g||{};if(a in this.popupCache)var d=this.popupCache[a];else d=
this.addOutput({xtype:"gx_popup",title:this.popupTitle,layout:"accordion",fill:!1,autoScroll:!0,location:c.xy,map:this.target.mapPanel,width:250,height:300,defaults:{layout:"fit",autoScroll:!0,autoHeight:!0,autoWidth:!0,collapsible:!0}}),d.on({close:function(p){return function(f){delete this.popupCache[p]}}(a),scope:this}),this.popupCache[a]=d;c=c.features;a=[];if(!b&&c)for(var e=0,l=c.length;e<l;++e)b=c[e],a.push(Ext.apply({xtype:"gxp_editorgrid",readOnly:!0,listeners:{beforeedit:function(p){return!1}},
title:b.fid?b.fid:n,feature:b,fields:g.fields,propertyNames:g.propertyNames},this.itemConfig));else b&&a.push(Ext.apply({title:n,html:b},this.itemConfig));d.add(a);d.doLayout()}});Ext.preg(gxp.plugins.WMSGetFeatureInfo.prototype.ptype,gxp.plugins.WMSGetFeatureInfo);
